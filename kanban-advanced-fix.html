<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TaskFlow v3.0 Advanced - Sistema Kanban</title>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Archivo:wght@400;500;600;700&family=IBM+Plex+Mono:wght@400;500&display=swap');
        
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        :root {
            --bg-dark: #0a0e17;
            --bg-card: #151923;
            --bg-hover: #1c212e;
            --border: #2a3142;
            --text-primary: #e4e8f0;
            --text-secondary: #8b92a8;
            --accent-blue: #3b82f6;
            --accent-purple: #8b5cf6;
            --accent-green: #10b981;
            --accent-orange: #f59e0b;
            --accent-red: #ef4444;
            --shadow: rgba(0, 0, 0, 0.3);
        }
        
        [data-theme="light"] {
            --bg-dark: #ffffff;
            --bg-card: #f8f9fa;
            --bg-hover: #e9ecef;
            --border: #dee2e6;
            --text-primary: #212529;
            --text-secondary: #6c757d;
            --accent-blue: #0d6efd;
            --accent-purple: #7c3aed;
            --accent-green: #059669;
            --accent-orange: #f59e0b;
            --accent-red: #dc3545;
            --shadow: rgba(0, 0, 0, 0.1);
        }
        
        body {
            transition: background-color 0.3s ease, color 0.3s ease;
        }
        
        * {
            transition: background-color 0.2s ease, border-color 0.2s ease, color 0.2s ease;
        }
        
        body {
            font-family: 'Archivo', sans-serif;
            background: var(--bg-dark);
            color: var(--text-primary);
            overflow-x: hidden;
        }
        
        /* Background effect */
        body::before {
            content: '';
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: 
                radial-gradient(circle at 20% 30%, rgba(59, 130, 246, 0.08) 0%, transparent 50%),
                radial-gradient(circle at 80% 70%, rgba(139, 92, 246, 0.08) 0%, transparent 50%);
            pointer-events: none;
            z-index: 0;
        }
        
        [data-theme="light"] body::before {
            background: 
                radial-gradient(circle at 20% 30%, rgba(59, 130, 246, 0.05) 0%, transparent 50%),
                radial-gradient(circle at 80% 70%, rgba(139, 92, 246, 0.05) 0%, transparent 50%);
        }
        
        .container {
            position: relative;
            z-index: 1;
            max-width: 1800px;
            margin: 0 auto;
            padding: 20px;
            min-height: 100vh;
        }
        
        /* Header */
        .header {
            display: flex;
            flex-direction: column;
            gap: 12px;
            margin-bottom: 20px;
            padding: 16px 20px;
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: 12px;
            animation: slideDown 0.5s ease;
        }
        
        .header-top {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .header-bottom {
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
            align-items: center;
        }
        
        @keyframes slideDown {
            from { opacity: 0; transform: translateY(-20px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        .logo {
            display: flex;
            align-items: center;
            gap: 0;
        }
        
        .logo-icon {
            width: 40px;
            height: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
            background: linear-gradient(135deg, var(--accent-blue), var(--accent-purple));
            border-radius: 8px;
            font-size: 24px;
            font-weight: 700;
            color: white;
        }
        
        .logo h1 {
            font-size: 24px;
            font-weight: 700;
            background: linear-gradient(135deg, var(--accent-blue), var(--accent-purple));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }
        
        .header-actions {
            display: flex;
            gap: 8px;
            align-items: center;
            flex-wrap: wrap;
        }
        
        .search-box {
            position: relative;
        }
        
        .search-box input {
            padding: 10px 16px 10px 40px;
            background: var(--bg-dark);
            border: 1px solid var(--border);
            border-radius: 8px;
            color: var(--text-primary);
            font-family: 'Archivo', sans-serif;
            font-size: 14px;
            width: 250px;
            transition: all 0.3s ease;
        }
        
        .search-box input:focus {
            outline: none;
            border-color: var(--accent-blue);
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
        }
        
        .search-box::before {
            content: 'üîç';
            position: absolute;
            left: 14px;
            top: 50%;
            transform: translateY(-50%);
            font-size: 16px;
        }
        
        .btn {
            padding: 10px 20px;
            background: var(--accent-blue);
            color: white;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-family: 'Archivo', sans-serif;
            font-weight: 600;
            font-size: 14px;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .btn:hover {
            background: #2563eb;
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(59, 130, 246, 0.3);
        }
        
        .btn-secondary {
            background: var(--bg-hover);
            border: 1px solid var(--border);
        }
        
        .btn-secondary:hover {
            background: var(--border);
            transform: translateY(-2px);
            box-shadow: 0 6px 20px var(--shadow);
        }
        
        /* Filters */
        .filters {
            display: flex;
            gap: 12px;
            margin-bottom: 20px;
            padding: 16px 20px;
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: 12px;
            animation: fadeIn 0.5s ease 0.1s both;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        .filter-tag {
            padding: 8px 16px;
            background: var(--bg-dark);
            border: 1px solid var(--border);
            border-radius: 6px;
            cursor: pointer;
            font-size: 13px;
            transition: all 0.2s ease;
            user-select: none;
        }
        
        .filter-tag:hover {
            border-color: var(--accent-blue);
            background: var(--bg-hover);
        }
        
        .filter-tag.active {
            background: var(--accent-blue);
            border-color: var(--accent-blue);
            color: white;
        }
        
        /* Board */
        /* Board Container */
        #boardContainer {
            min-height: 400px;
        }
        
        .board {
            display: flex;
            gap: 20px;
            overflow-x: auto;
            padding-bottom: 20px;
            min-height: 500px;
        }
        
        .board::-webkit-scrollbar {
            height: 8px;
        }
        
        .board::-webkit-scrollbar-track {
            background: var(--bg-card);
            border-radius: 4px;
        }
        
        .board::-webkit-scrollbar-thumb {
            background: var(--border);
            border-radius: 4px;
        }
        
        .board::-webkit-scrollbar-thumb:hover {
            background: var(--accent-blue);
        }
        
        /* Column */
        .column {
            min-width: 350px;
            max-width: 350px;
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: 12px;
            padding: 20px;
            animation: fadeIn 0.5s ease both;
            display: flex;
            flex-direction: column;
            flex-shrink: 0;
        }
        
        .column:nth-child(1) { animation-delay: 0.2s; }
        .column:nth-child(2) { animation-delay: 0.3s; }
        .column:nth-child(3) { animation-delay: 0.4s; }
        .column:nth-child(4) { animation-delay: 0.5s; }
        
        .column-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 16px;
            padding-bottom: 12px;
            border-bottom: 2px solid var(--border);
        }
        
        .column-title {
            display: flex;
            align-items: center;
            gap: 8px;
            font-weight: 600;
            font-size: 15px;
        }
        
        .column-badge {
            background: var(--bg-dark);
            padding: 4px 10px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: 600;
            font-family: 'IBM Plex Mono', monospace;
        }
        
        .column-icon {
            font-size: 18px;
        }
        
        .add-task-btn {
            background: transparent;
            border: 1px dashed var(--border);
            color: var(--text-secondary);
            padding: 12px;
            border-radius: 8px;
            cursor: pointer;
            font-family: 'Archivo', sans-serif;
            font-size: 14px;
            width: 100%;
            transition: all 0.2s ease;
            margin-top: 12px;
        }
        
        .add-task-btn:hover {
            border-color: var(--accent-blue);
            color: var(--accent-blue);
            background: rgba(59, 130, 246, 0.05);
        }
        
        /* Tasks */
        .tasks {
            display: flex;
            flex-direction: column;
            gap: 12px;
            min-height: 100px;
            max-height: 600px;
            overflow-y: auto;
            padding-right: 4px;
        }
        
        .tasks::-webkit-scrollbar {
            width: 6px;
        }
        
        .tasks::-webkit-scrollbar-track {
            background: transparent;
        }
        
        .tasks::-webkit-scrollbar-thumb {
            background: var(--border);
            border-radius: 3px;
        }
        
        .tasks::-webkit-scrollbar-thumb:hover {
            background: var(--accent-blue);
        }
        
        .task {
            background: var(--bg-dark);
            border: 1px solid var(--border);
            border-radius: 8px;
            padding: 16px;
            cursor: move;
            transition: all 0.2s ease;
            animation: taskAppear 0.3s ease;
        }
        
        @keyframes taskAppear {
            from { opacity: 0; transform: scale(0.95); }
            to { opacity: 1; transform: scale(1); }
        }
        
        .task:hover {
            border-color: var(--accent-blue);
            box-shadow: 0 4px 12px var(--shadow);
            transform: translateY(-2px);
        }
        
        .task.dragging {
            opacity: 0.5;
            transform: rotate(2deg);
        }
        
        .task-header {
            display: flex;
            justify-content: space-between;
            align-items: start;
            margin-bottom: 8px;
        }
        
        .task-id {
            font-family: 'IBM Plex Mono', monospace;
            font-size: 11px;
            color: var(--text-secondary);
            font-weight: 500;
        }
        
        .task-priority {
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 10px;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        
        .priority-high {
            background: rgba(239, 68, 68, 0.15);
            color: var(--accent-red);
            border: 1px solid rgba(239, 68, 68, 0.3);
        }
        
        [data-theme="light"] .priority-high {
            background: rgba(220, 53, 69, 0.1);
            color: #dc3545;
            border: 1px solid rgba(220, 53, 69, 0.3);
        }
        
        .priority-medium {
            background: rgba(245, 158, 11, 0.15);
            color: var(--accent-orange);
            border: 1px solid rgba(245, 158, 11, 0.3);
        }
        
        [data-theme="light"] .priority-medium {
            background: rgba(245, 158, 11, 0.1);
            color: #d97706;
            border: 1px solid rgba(245, 158, 11, 0.3);
        }
        
        .priority-low {
            background: rgba(16, 185, 129, 0.15);
            color: var(--accent-green);
            border: 1px solid rgba(16, 185, 129, 0.3);
        }
        
        [data-theme="light"] .priority-low {
            background: rgba(5, 150, 105, 0.1);
            color: #059669;
            border: 1px solid rgba(5, 150, 105, 0.3);
        }
        
        .task-title {
            font-weight: 600;
            font-size: 15px;
            margin-bottom: 8px;
            line-height: 1.4;
        }
        
        .task-description {
            font-size: 13px;
            color: var(--text-secondary);
            line-height: 1.5;
            margin-bottom: 12px;
            /* Limit to 3 lines with ellipsis */
            display: -webkit-box;
            -webkit-line-clamp: 3;
            -webkit-box-orient: vertical;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        
        .task-dates {
            display: flex;
            gap: 8px;
            align-items: center;
            font-size: 11px;
            color: var(--text-secondary);
            margin-bottom: 12px;
            padding: 6px 10px;
            background: var(--bg-hover);
            border-radius: 6px;
            flex-wrap: wrap;
        }
        
        .task-dates span {
            display: flex;
            align-items: center;
            gap: 4px;
        }
        
        .task-lead-time {
            padding: 2px 8px;
            background: rgba(139, 92, 246, 0.15);
            color: var(--accent-purple);
            border-radius: 4px;
            font-weight: 600;
            border: 1px solid rgba(139, 92, 246, 0.3);
        }
        
        [data-theme="light"] .task-lead-time {
            background: rgba(124, 58, 237, 0.1);
            color: #7c3aed;
            border: 1px solid rgba(124, 58, 237, 0.3);
        }
        
        .task-footer {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .task-tags {
            display: flex;
            gap: 6px;
            flex-wrap: wrap;
        }
        
        .task-tag {
            padding: 4px 10px;
            background: rgba(59, 130, 246, 0.15);
            color: var(--accent-blue);
            border-radius: 4px;
            font-size: 11px;
            font-weight: 500;
            border: 1px solid rgba(59, 130, 246, 0.3);
        }
        
        [data-theme="light"] .task-tag {
            background: rgba(13, 110, 253, 0.1);
            color: #0d6efd;
            border: 1px solid rgba(13, 110, 253, 0.3);
        }
        
        .task-assignee {
            width: 32px;
            height: 32px;
            border-radius: 50%;
            background: linear-gradient(135deg, var(--accent-purple), var(--accent-blue));
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 600;
            font-size: 12px;
            border: 2px solid var(--bg-dark);
            cursor: help;
        }
        
        .task-email-btn {
            background: transparent;
            border: none;
            font-size: 18px;
            cursor: pointer;
            padding: 4px;
            border-radius: 4px;
            transition: all 0.2s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            opacity: 0.7;
        }
        
        .task-email-btn:hover {
            opacity: 1;
            background: rgba(59, 130, 246, 0.1);
            transform: scale(1.1);
        }
        
        .task-email-btn:active {
            transform: scale(0.95);
        }
        
        /* Modal */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.7);
            backdrop-filter: blur(4px);
            z-index: 1000;
            align-items: center;
            justify-content: center;
            animation: modalFadeIn 0.3s ease;
        }
        
        @keyframes modalFadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }
        
        .modal.active {
            display: flex;
        }
        
        .modal-content {
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: 16px;
            padding: 32px;
            max-width: 600px;
            width: 90%;
            max-height: 90vh;
            overflow-y: auto;
            animation: modalSlideUp 0.3s ease;
        }
        
        @keyframes modalSlideUp {
            from { opacity: 0; transform: translateY(30px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 24px;
        }
        
        .modal-header h2 {
            font-size: 22px;
            font-weight: 700;
        }
        
        .close-btn {
            background: transparent;
            border: none;
            color: var(--text-secondary);
            font-size: 28px;
            cursor: pointer;
            width: 36px;
            height: 36px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 6px;
            transition: all 0.2s ease;
        }
        
        .close-btn:hover {
            background: var(--bg-hover);
            color: var(--text-primary);
        }
        
        .form-group {
            margin-bottom: 20px;
        }
        
        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            font-size: 14px;
        }
        
        .form-group input,
        .form-group textarea,
        .form-group select {
            width: 100%;
            padding: 12px;
            background: var(--bg-dark);
            border: 1px solid var(--border);
            border-radius: 8px;
            color: var(--text-primary);
            font-family: 'Archivo', sans-serif;
            font-size: 14px;
            transition: all 0.2s ease;
        }
        
        .form-group input:focus,
        .form-group textarea:focus,
        .form-group select:focus {
            outline: none;
            border-color: var(--accent-blue);
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
        }
        
        .form-group textarea {
            resize: vertical;
            min-height: 100px;
        }
        
        .form-actions {
            display: flex;
            gap: 12px;
            justify-content: flex-end;
            margin-top: 24px;
        }
        
        /* Drag over state */
        .column.drag-over {
            background: rgba(59, 130, 246, 0.05);
            border-color: var(--accent-blue);
        }
        
        /* Stats */
        .stats {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 16px;
            margin-bottom: 20px;
            animation: fadeIn 0.5s ease 0.15s both;
        }
        
        .stat-card {
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: 12px;
            padding: 16px 20px;
            transition: all 0.3s ease;
        }
        
        .stat-card:hover {
            transform: translateY(-4px);
            box-shadow: 0 8px 24px var(--shadow);
        }
        
        .stat-label {
            font-size: 13px;
            color: var(--text-secondary);
            margin-bottom: 8px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            font-weight: 500;
        }
        
        .stat-value {
            font-size: 28px;
            font-weight: 700;
            font-family: 'IBM Plex Mono', monospace;
            background: linear-gradient(135deg, var(--accent-blue), var(--accent-purple));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }
        
        /* Add Column Button */
        .add-column-btn {
            min-width: 350px;
            max-width: 350px;
            background: var(--bg-card);
            border: 2px dashed var(--border);
            border-radius: 12px;
            padding: 40px 20px;
            cursor: pointer;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            gap: 12px;
            transition: all 0.3s ease;
            color: var(--text-secondary);
            font-weight: 600;
            animation: fadeIn 0.5s ease 0.6s both;
            flex-shrink: 0;
        }
        
        .add-column-btn:hover {
            border-color: var(--accent-blue);
            color: var(--accent-blue);
            background: rgba(59, 130, 246, 0.05);
            transform: scale(1.02);
        }
        
        .add-column-btn-icon {
            font-size: 32px;
        }
        
        .column-actions {
            display: flex;
            gap: 8px;
        }
        
        .column-action-btn {
            background: transparent;
            border: none;
            color: var(--text-secondary);
            cursor: pointer;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 16px;
            transition: all 0.2s ease;
        }
        
        .column-action-btn:hover {
            background: var(--bg-hover);
            color: var(--text-primary);
        }
        
        .column-action-btn.delete:hover {
            color: var(--accent-red);
        }
        
        /* Swimlanes */
        .swimlanes-container {
            animation: fadeIn 0.5s ease 0.25s both;
            min-height: 400px;
        }
        
        .swimlane {
            margin-bottom: 20px;
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: 12px;
            overflow: hidden;
        }
        
        .swimlane-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 16px 24px;
            background: var(--bg-hover);
            border-bottom: 1px solid var(--border);
            cursor: pointer;
            user-select: none;
            transition: all 0.2s ease;
        }
        
        .swimlane-header:hover {
            background: var(--border);
        }
        
        .swimlane-title-section {
            display: flex;
            align-items: center;
            gap: 12px;
            flex: 1;
        }
        
        .swimlane-icon {
            font-size: 20px;
        }
        
        .swimlane-title {
            font-weight: 600;
            font-size: 16px;
        }
        
        .swimlane-badge {
            background: var(--bg-dark);
            padding: 4px 10px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: 600;
            font-family: 'IBM Plex Mono', monospace;
            color: var(--text-secondary);
        }
        
        .swimlane-actions {
            display: flex;
            gap: 8px;
            align-items: center;
        }
        
        .swimlane-toggle {
            font-size: 18px;
            transition: transform 0.3s ease;
        }
        
        .swimlane.collapsed .swimlane-toggle {
            transform: rotate(-90deg);
        }
        
        .swimlane-content {
            padding: 20px;
            display: block;
            transition: all 0.3s ease;
        }
        
        .swimlane-content .board {
            min-height: 300px;
        }
        
        .swimlane.collapsed .swimlane-content {
            display: none;
        }
        
        .add-swimlane-btn {
            background: var(--bg-card);
            border: 2px dashed var(--border);
            border-radius: 12px;
            padding: 20px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 12px;
            transition: all 0.3s ease;
            color: var(--text-secondary);
            font-weight: 600;
        }
        
        .add-swimlane-btn:hover {
            border-color: var(--accent-blue);
            color: var(--accent-blue);
            background: rgba(59, 130, 246, 0.05);
        }
        
        .swimlane-action-btn {
            background: transparent;
            border: none;
            color: var(--text-secondary);
            cursor: pointer;
            padding: 6px 10px;
            border-radius: 4px;
            font-size: 16px;
            transition: all 0.2s ease;
        }
        
        .swimlane-action-btn:hover {
            background: var(--bg-dark);
            color: var(--text-primary);
        }
        
        .swimlane-action-btn.delete:hover {
            color: var(--accent-red);
        }

        /* Reminders Badge Animation */
        @keyframes pulse {
            0%, 100% {
                transform: scale(1);
                opacity: 1;
            }
            50% {
                transform: scale(1.05);
                opacity: 0.8;
            }
        }
        
        /* v3.0: Avatares e M√∫ltiplos Respons√°veis */
        .avatar {
            width: 28px;
            height: 28px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 11px;
            font-weight: 600;
            color: white;
            border: 2px solid var(--bg-card);
            cursor: pointer;
            transition: all 0.2s;
        }
        
        .avatar:hover {
            transform: scale(1.1);
            z-index: 10;
        }
        
        .task-assignees {
            display: flex;
            margin-left: auto;
            align-items: center;
        }
        
        .task-assignees .avatar {
            margin-left: -8px;
        }
        
        .task-assignees .avatar:first-child {
            margin-left: 0;
        }
        
        .avatar-more {
            width: 28px;
            height: 28px;
            border-radius: 50%;
            background: var(--text-secondary);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 10px;
            font-weight: 600;
            color: white;
            margin-left: -8px;
            border: 2px solid var(--bg-card);
        }
        
        .assignees-selector {
            display: flex;
            flex-direction: column;
            gap: 12px;
        }
        
        .assignees-selected {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            min-height: 40px;
            padding: 8px;
            border: 1px solid var(--border);
            border-radius: 4px;
            background: var(--bg-dark);
        }
        
        .assignee-chip {
            display: flex;
            align-items: center;
            gap: 6px;
            padding: 4px 8px;
            border-radius: 16px;
            background: var(--bg-hover);
            font-size: 13px;
        }
        
        .assignee-chip .avatar {
            width: 24px;
            height: 24px;
            font-size: 10px;
            border-width: 1px;
        }
        
        .assignee-chip-remove {
            background: none;
            border: none;
            color: var(--text-secondary);
            cursor: pointer;
            padding: 0;
            width: 16px;
            height: 16px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 50%;
            font-size: 14px;
        }
        
        .assignee-chip-remove:hover {
            background: var(--accent-red);
            color: white;
        }
        
        .btn-add-assignee {
            padding: 8px 12px;
            border: 1px dashed var(--border);
            border-radius: 4px;
            background: transparent;
            color: var(--text-secondary);
            font-size: 13px;
            cursor: pointer;
            transition: all 0.2s;
        }
        
        .btn-add-assignee:hover {
            border-color: var(--accent-blue);
            color: var(--accent-blue);
            background: var(--bg-hover);
        }
        
        .people-list {
            display: flex;
            flex-direction: column;
            gap: 8px;
            max-height: 200px;
            overflow-y: auto;
        }
        
        .person-item {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 8px 12px;
            border-radius: 4px;
            cursor: pointer;
            transition: all 0.2s;
        }
        
        .person-item:hover {
            background: var(--bg-hover);
        }
        
        .person-item.selected {
            background: var(--accent-blue);
            color: white;
        }
        
        .person-info {
            flex: 1;
        }
        
        .person-name {
            font-size: 14px;
            font-weight: 500;
        }
        
        .person-email {
            font-size: 12px;
            color: var(--text-tertiary);
        }
        
        .person-item.selected .person-email {
            color: rgba(255, 255, 255, 0.8);
        }
        
        /* v3.0: Modal Tabs */
        .modal-tabs {
            display: flex;
            border-bottom: 1px solid var(--border);
            padding: 0 24px;
            gap: 8px;
            background: var(--bg-dark);
        }
        
        .modal-tab {
            padding: 12px 20px;
            border: none;
            background: transparent;
            color: var(--text-secondary);
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
            border-bottom: 2px solid transparent;
            transition: all 0.2s;
        }
        
        .modal-tab:hover {
            color: var(--text-primary);
        }
        
        .modal-tab.active {
            color: var(--accent-blue);
            border-bottom-color: var(--accent-blue);
        }
        
        .tab-content {
            display: none;
        }
        
        .tab-content.active {
            display: block;
        }
        
        /* v3.0: Hist√≥rico de Altera√ß√µes */
        .history-timeline {
            display: flex;
            flex-direction: column;
            gap: 16px;
            padding: 24px;
        }
        
        .history-event {
            display: flex;
            gap: 12px;
            padding: 12px;
            border-radius: 6px;
            background: var(--bg-hover);
        }
        
        .history-icon {
            width: 32px;
            height: 32px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 16px;
            flex-shrink: 0;
            color: white;
        }
        
        .history-icon.created { background: var(--accent-green); }
        .history-icon.moved { background: var(--accent-blue); }
        .history-icon.edited { background: var(--accent-orange); }
        .history-icon.assignee_added { background: var(--accent-purple); }
        .history-icon.assignee_removed { background: var(--accent-red); }
        .history-icon.priority_changed { background: var(--accent-orange); }
        .history-icon.tags_changed { background: var(--accent-purple); }
        
        .history-content {
            flex: 1;
        }
        
        .history-user {
            font-weight: 600;
            color: var(--text-primary);
            font-size: 14px;
        }
        
        .history-action {
            font-size: 14px;
            color: var(--text-secondary);
            margin: 4px 0;
        }
        
        .history-changes {
            font-size: 12px;
            color: var(--text-tertiary);
            font-family: 'IBM Plex Mono', monospace;
            background: var(--bg-dark);
            padding: 8px;
            border-radius: 4px;
            margin-top: 8px;
            border-left: 3px solid var(--accent-blue);
        }
        
        .history-changes div {
            margin: 2px 0;
        }
        
        .history-timestamp {
            font-size: 11px;
            color: var(--text-tertiary);
            margin-top: 4px;
        }
        
        .history-empty {
            text-align: center;
            padding: 40px 20px;
            color: var(--text-secondary);
        }
        
        .history-empty-icon {
            font-size: 48px;
            margin-bottom: 12px;
            opacity: 0.5;
        }
        
        /* Board inside swimlane */
        .swimlane-content .board {
            padding-bottom: 0;
            margin-bottom: 0;
        }
        
        .no-swimlanes-mode .board {
            padding: 0;
        }
        
        /* Theme Toggle */
        .theme-toggle {
            background: var(--bg-hover);
            border: 1px solid var(--border);
            color: var(--text-primary);
            width: 40px;
            height: 40px;
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            font-size: 20px;
            transition: all 0.3s ease;
        }
        
        .theme-toggle:hover {
            background: var(--border);
            transform: translateY(-2px);
            box-shadow: 0 4px 12px var(--shadow);
        }
/* ========================================
   FASE 5: UX/UI AVAN√áADO - ESTILOS v3.0
   ======================================== */

/* Vari√°veis de Densidade */
:root {
    --card-padding: 16px;
    --card-gap: 12px;
    --card-font-size: 14px;
}

[data-density="compact"] {
    --card-padding: 12px;
    --card-gap: 8px;
    --card-font-size: 13px;
}

[data-density="spacious"] {
    --card-padding: 20px;
    --card-gap: 16px;
    --card-font-size: 15px;
}

/* Aplicar densidade nos cards */
.task {
    padding: var(--card-padding) !important;
    font-size: var(--card-font-size) !important;
}

.column-tasks {
    gap: var(--card-gap) !important;
}

/* ========================================
   EDITOR DE TEMAS
   ======================================== */

.themes-grid {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
    gap: 16px;
}

.theme-preset {
    padding: 16px;
    border: 2px solid var(--border);
    border-radius: 8px;
    cursor: pointer;
    transition: all 0.2s;
    position: relative;
}

.theme-preset:hover {
    border-color: var(--accent-blue);
    transform: translateY(-2px);
    box-shadow: 0 4px 12px var(--shadow);
}

.theme-preset.active {
    border-color: var(--accent-green);
    background: var(--bg-hover);
}

.theme-preview {
    display: flex;
    gap: 6px;
    margin-bottom: 12px;
    flex-wrap: wrap;
}

.color-dot {
    width: 24px;
    height: 24px;
    border-radius: 50%;
    border: 2px solid var(--border);
}

.theme-name {
    font-weight: 600;
    font-size: 14px;
    margin-bottom: 4px;
}

.theme-active-badge {
    position: absolute;
    top: 12px;
    right: 12px;
    background: var(--accent-green);
    color: white;
    padding: 4px 8px;
    border-radius: 12px;
    font-size: 11px;
    font-weight: 700;
}

/* ========================================
   PALETA DE COMANDOS
   ======================================== */

.command-palette {
    position: fixed;
    top: 20%;
    left: 50%;
    transform: translateX(-50%);
    width: 90%;
    max-width: 600px;
    background: var(--bg-primary);
    border: 1px solid var(--border);
    border-radius: 12px;
    box-shadow: 0 12px 40px rgba(0, 0, 0, 0.5);
    overflow: hidden;
    z-index: 10000;
}

.command-search {
    padding: 16px;
    border-bottom: 1px solid var(--border);
}

.command-search input {
    width: 100%;
    padding: 12px 16px;
    border: none;
    background: var(--bg-secondary);
    color: var(--text-primary);
    border-radius: 6px;
    font-size: 16px;
    outline: none;
}

.command-search input:focus {
    background: var(--bg-hover);
}

.command-results {
    max-height: 400px;
    overflow-y: auto;
}

.command-item {
    display: flex;
    align-items: center;
    gap: 12px;
    padding: 12px 16px;
    cursor: pointer;
    transition: all 0.2s;
    border-bottom: 1px solid var(--border);
}

.command-item:hover {
    background: var(--bg-hover);
}

.command-icon {
    font-size: 20px;
}

.command-name {
    font-weight: 500;
    font-size: 14px;
}

.command-empty {
    padding: 40px;
    text-align: center;
    color: var(--text-secondary);
}

/* ========================================
   ATALHOS DE TECLADO
   ======================================== */

.shortcuts-list {
    display: flex;
    flex-direction: column;
    gap: 12px;
}

.shortcut-item {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 12px;
    background: var(--bg-secondary);
    border-radius: 6px;
}

.shortcut-key {
    background: var(--bg-hover);
    border: 1px solid var(--border);
    border-radius: 4px;
    padding: 6px 12px;
    font-family: 'Monaco', 'Courier New', monospace;
    font-size: 13px;
    font-weight: 600;
    box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
}

.shortcut-desc {
    font-size: 14px;
    color: var(--text-secondary);
}

kbd {
    background: var(--bg-hover);
    border: 1px solid var(--border);
    border-radius: 4px;
    padding: 4px 8px;
    font-family: 'Monaco', 'Courier New', monospace;
    font-size: 12px;
    font-weight: 600;
}

/* ========================================
   DENSIDADE
   ======================================== */

.density-options {
    display: flex;
    flex-direction: column;
    gap: 12px;
}

.density-option {
    display: flex;
    align-items: center;
    gap: 16px;
    padding: 16px;
    border: 2px solid var(--border);
    border-radius: 8px;
    cursor: pointer;
    transition: all 0.2s;
    position: relative;
}

.density-option:hover {
    border-color: var(--accent-blue);
    background: var(--bg-hover);
}

.density-option.active {
    border-color: var(--accent-green);
    background: var(--bg-hover);
}

.density-icon {
    font-size: 32px;
}

.density-info {
    flex: 1;
}

.density-name {
    font-weight: 600;
    font-size: 16px;
    margin-bottom: 4px;
}

.density-desc {
    font-size: 13px;
    color: var(--text-secondary);
}

.density-badge {
    position: absolute;
    top: 16px;
    right: 16px;
    color: var(--accent-green);
    font-size: 20px;
    font-weight: 700;
}

/* ========================================
   ANIMA√á√ïES SUAVES
   ======================================== */

@keyframes slideInDown {
    from {
        opacity: 0;
        transform: translateY(-20px);
    }
    to {
        opacity: 1;
        transform: translateY(0);
    }
}

@keyframes fadeIn {
    from {
        opacity: 0;
    }
    to {
        opacity: 1;
    }
}

.modal.active {
    animation: fadeIn 0.2s ease;
}

.command-palette {
    animation: slideInDown 0.3s ease;
}

/* ========================================
   MELHORIAS GERAIS UX
   ======================================== */

/* Transi√ß√µes suaves em tudo */
* {
    transition: background-color 0.2s ease, color 0.2s ease, border-color 0.2s ease;
}

/* Focus states melhorados */
input:focus,
textarea:focus,
select:focus,
button:focus {
    outline: 2px solid var(--accent-blue);
    outline-offset: 2px;
}

/* Hover states consistentes */
button:hover,
.btn:hover {
    transform: translateY(-1px);
}

button:active,
.btn:active {
    transform: translateY(0);
}

/* Tooltips */
[title] {
    position: relative;
    cursor: help;
}

/* Scrollbars customizadas */
::-webkit-scrollbar {
    width: 10px;
    height: 10px;
}

::-webkit-scrollbar-track {
    background: var(--bg-secondary);
}

::-webkit-scrollbar-thumb {
    background: var(--border);
    border-radius: 5px;
}

::-webkit-scrollbar-thumb:hover {
    background: var(--accent-blue);
}

/* Loading states */
.loading {
    opacity: 0.6;
    pointer-events: none;
    cursor: wait;
}

/* Skeleton loaders */
.skeleton {
    background: linear-gradient(90deg, 
        var(--bg-secondary) 25%, 
        var(--bg-hover) 50%, 
        var(--bg-secondary) 75%
    );
    background-size: 200% 100%;
    animation: loading 1.5s ease-in-out infinite;
}

@keyframes loading {
    0% {
        background-position: 200% 0;
    }
    100% {
        background-position: -200% 0;
    }
}

/* Badges modernos */
.badge {
    display: inline-block;
    padding: 4px 8px;
    border-radius: 12px;
    font-size: 11px;
    font-weight: 700;
    text-transform: uppercase;
    letter-spacing: 0.5px;
}

.badge-primary {
    background: var(--accent-blue);
    color: white;
}

.badge-success {
    background: var(--accent-green);
    color: white;
}

.badge-danger {
    background: var(--accent-red);
    color: white;
}

/* Backup Manager Styles */
.backup-manager {
    background: var(--bg-primary);
    border-radius: 12px;
    padding: 24px;
    max-width: 800px;
    width: 90%;
    max-height: 80vh;
    overflow-y: auto;
}

.backup-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 24px;
    padding-bottom: 16px;
    border-bottom: 2px solid var(--border);
}

.backup-header h2 {
    font-size: 24px;
    color: var(--text-primary);
    display: flex;
    align-items: center;
    gap: 12px;
}

.backup-section {
    margin-bottom: 24px;
    padding: 20px;
    background: var(--bg-secondary);
    border-radius: 8px;
    border: 1px solid var(--border);
}

.backup-section h3 {
    font-size: 18px;
    color: var(--text-primary);
    margin-bottom: 16px;
    display: flex;
    align-items: center;
    gap: 8px;
}

.backup-actions {
    display: flex;
    gap: 12px;
    flex-wrap: wrap;
}

.backup-info {
    display: flex;
    align-items: center;
    gap: 12px;
    padding: 12px;
    background: var(--bg-dark);
    border-radius: 6px;
    margin-bottom: 12px;
}

.backup-info-icon {
    font-size: 24px;
}

.backup-info-text {
    flex: 1;
}

.backup-info-label {
    font-size: 12px;
    color: var(--text-secondary);
    margin-bottom: 4px;
}

.backup-info-value {
    font-size: 16px;
    font-weight: 600;
    color: var(--text-primary);
}

.backup-history {
    max-height: 300px;
    overflow-y: auto;
}

.backup-item {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 12px;
    background: var(--bg-dark);
    border-radius: 6px;
    margin-bottom: 8px;
    border: 1px solid var(--border);
}

.backup-item:hover {
    background: var(--bg-hover);
    border-color: var(--accent-blue);
}

.backup-item-info {
    flex: 1;
}

.backup-item-name {
    font-weight: 600;
    color: var(--text-primary);
    margin-bottom: 4px;
}

.backup-item-details {
    font-size: 12px;
    color: var(--text-secondary);
}

.backup-item-actions {
    display: flex;
    gap: 8px;
}

.backup-auto-settings {
    display: flex;
    flex-direction: column;
    gap: 12px;
}

.backup-auto-option {
    display: flex;
    align-items: center;
    gap: 12px;
    padding: 12px;
    background: var(--bg-dark);
    border-radius: 6px;
    cursor: pointer;
    border: 2px solid transparent;
}

.backup-auto-option:hover {
    background: var(--bg-hover);
}

.backup-auto-option.active {
    border-color: var(--accent-blue);
    background: rgba(59, 130, 246, 0.1);
}

.backup-auto-option input[type="radio"] {
    width: 20px;
    height: 20px;
}

.backup-auto-label {
    flex: 1;
}

.backup-auto-title {
    font-weight: 600;
    color: var(--text-primary);
    margin-bottom: 4px;
}

.backup-auto-desc {
    font-size: 12px;
    color: var(--text-secondary);
}

.backup-stats {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
    gap: 12px;
    margin-top: 16px;
}

.backup-stat-card {
    padding: 16px;
    background: var(--bg-dark);
    border-radius: 8px;
    text-align: center;
    border: 1px solid var(--border);
}

.backup-stat-value {
    font-size: 28px;
    font-weight: 700;
    color: var(--accent-blue);
    margin-bottom: 4px;
}

.backup-stat-label {
    font-size: 12px;
    color: var(--text-secondary);
    text-transform: uppercase;
}

/* Cards com hover effect */
.card-hover {
    transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
}

.card-hover:hover {
    transform: translateY(-4px) scale(1.02);
    box-shadow: 0 12px 24px rgba(0, 0, 0, 0.15);
}

/* Emoji Picker */
.emoji-picker-container {
    position: relative;
    margin-top: 8px;
}

.emoji-grid {
    display: grid;
    grid-template-columns: repeat(8, 1fr);
    gap: 8px;
    padding: 12px;
    background: var(--bg-secondary);
    border-radius: 8px;
    border: 1px solid var(--border);
    max-height: 200px;
    overflow-y: auto;
}

.emoji-item {
    width: 40px;
    height: 40px;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 24px;
    cursor: pointer;
    border-radius: 6px;
    transition: all 0.2s ease;
    background: var(--bg-dark);
    border: 2px solid transparent;
}

.emoji-item:hover {
    transform: scale(1.15);
    background: var(--bg-hover);
    border-color: var(--accent-blue);
}

.emoji-item.selected {
    background: var(--accent-blue);
    border-color: var(--accent-blue);
    box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.2);
}

.emoji-preview {
    display: flex;
    align-items: center;
    gap: 12px;
    padding: 8px 12px;
    background: var(--bg-secondary);
    border-radius: 6px;
    margin-bottom: 12px;
}

.emoji-preview-icon {
    font-size: 32px;
    width: 40px;
    height: 40px;
    display: flex;
    align-items: center;
    justify-content: center;
    background: var(--bg-dark);
    border-radius: 6px;
}

.emoji-preview-text {
    flex: 1;
    font-size: 14px;
    color: var(--text-secondary);
}

.emoji-category {
    font-size: 12px;
    font-weight: 600;
    color: var(--text-secondary);
    text-transform: uppercase;
    margin: 12px 0 8px 0;
    padding: 0 12px;
}

        
        /* Import Swimlane Modal Radio Options */
        .radio-option:hover {
            border-color: var(--accent-blue) !important;
            background: var(--bg-hover);
        }
        
        .radio-option input[type="radio"]:checked + div {
            color: var(--accent-blue);
        }
        
        .radio-option:has(input[type="radio"]:checked) {
            border-color: var(--accent-blue) !important;
            background: rgba(52, 152, 219, 0.1);
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- Header -->
        <div class="header">
            <!-- Linha 1: Logo, Busca e Ferramentas Principais -->
            <div class="header-top">
                <div class="logo">
                    <h1>TaskFlow <span style="font-size: 12px; color: var(--accent-blue); font-weight: 600;">v3.0 Advanced</span></h1>
                </div>
                <div class="header-actions">
                    <button class="theme-toggle" onclick="toggleTheme()" title="Alternar tema" id="themeToggle">
                        üåô
                    </button>
                    <div class="search-box">
                        <input type="text" id="searchInput" placeholder="Buscar tarefas...">
                    </div>
                    <button class="btn" onclick="openModal()">‚ûï Nova Tarefa</button>
                </div>
            </div>
            
            <!-- Linha 2: Todos os outros bot√µes -->
            <div class="header-bottom">
                <button class="btn btn-secondary" onclick="window.open('templates.html', '_blank')" title="Biblioteca de Templates">
                    üìã Templates
                </button>
                <button class="btn btn-secondary" onclick="window.open('integracoes.html', '_blank')" title="Integra√ß√µes e Automa√ß√µes">
                    üîó Integra√ß√µes
                </button>
                <button class="btn btn-secondary" onclick="window.open('dashboard.html', '_blank')">
                    üìä Dashboard
                </button>
                <button class="btn btn-secondary" onclick="window.open('timeline.html', '_blank')">
                    üìÖ Cronograma
                </button>
                <button class="btn btn-secondary" onclick="window.open('notas.html', '_blank')">
                    üìù Bloco de Notas
                </button>
                <button class="btn btn-secondary" id="remindersBtn" onclick="window.open('lembretes.html', '_blank')" style="position: relative;">
                    üîî Lembretes
                    <span id="remindersBadge" style="display: none; position: absolute; top: -8px; right: -8px; background: #ef4444; color: white; border-radius: 10px; padding: 2px 8px; font-size: 11px; font-weight: 700; min-width: 20px; text-align: center;"></span>
                </button>
                <button class="btn btn-secondary" onclick="managePeople()" title="Gerenciar Pessoas do Projeto">
                    üë• Pessoas
                </button>
                <button class="btn btn-secondary" onclick="openThemeEditor()" title="Personalizar Temas e Cores">
                    üé® Temas
                </button>
                <button class="btn btn-secondary" onclick="openCommandPalette()" title="Paleta de Comandos (Ctrl+K)">
                    ‚å®Ô∏è Comandos
                </button>
                <button class="btn btn-secondary" onclick="openDensitySettings()" title="Ajustar Densidade da Interface">
                    üìè Densidade
                </button>
                <button class="btn btn-secondary" onclick="openBackupManager()" title="Sistema de Backup Completo">
                    üíæ Backup
                </button>
                <button class="btn btn-secondary" onclick="exportToExcel()" title="Exportar tarefas para Excel">
                    üì§ Exportar Excel
                </button>
                <button class="btn btn-secondary" onclick="exportToProjectXML()" title="Exportar para MS Project">
                    üì§ Exportar Project
                </button>
                <button class="btn btn-secondary" onclick="document.getElementById('excelFileInput').click()" title="Importar dados do Excel">
                    üì• Importar Excel
                </button>
                <button class="btn btn-secondary" onclick="document.getElementById('projectFileInput').click()" title="Importar do MS Project">
                    üìã Importar Project
                </button>
                <button class="btn btn-secondary" onclick="toggleSwimlanesMode()">
                    <span id="swimlaneToggleIcon">üèä</span> <span id="swimlaneToggleText">Ativar Raias</span>
                </button>
                <input type="file" id="excelFileInput" accept=".xlsx,.xls" style="display: none;" onchange="importFromExcel(event)">
                <input type="file" id="projectFileInput" accept=".xml,.mpp" style="display: none;" onchange="importFromProject(event)">
            </div>
        </div>

        <!-- Stats -->
        <div class="stats">
            <div class="stat-card">
                <div class="stat-label">Total de Tarefas</div>
                <div class="stat-value" id="totalTasks">0</div>
            </div>
            <div class="stat-card">
                <div class="stat-label">Em Progresso</div>
                <div class="stat-value" id="inProgressTasks">0</div>
            </div>
            <div class="stat-card">
                <div class="stat-label">Conclu√≠das</div>
                <div class="stat-value" id="completedTasks">0</div>
            </div>
            <div class="stat-card">
                <div class="stat-label">Taxa de Conclus√£o</div>
                <div class="stat-value" id="completionRate">0%</div>
            </div>
        </div>

        <!-- Filters -->
        <div class="filters">
            <div class="filter-tag active" data-filter="all">Todas</div>
            <div class="filter-tag" data-filter="high">Alta Prioridade</div>
            <div class="filter-tag" data-filter="medium">M√©dia Prioridade</div>
            <div class="filter-tag" data-filter="low">Baixa Prioridade</div>
        </div>

        <!-- Board Container -->
        <div id="boardContainer">
            <!-- Swimlanes Mode -->
            <div id="swimlanesContainer" class="swimlanes-container" style="display: none;">
                <!-- Swimlanes will be rendered here -->
            </div>
            
            <!-- Normal Board Mode -->
            <div class="board" id="board">
                <!-- Colunas ser√£o renderizadas dinamicamente -->
            </div>
        </div>
    </div>

    <!-- Modal -->
    <!-- Task Modal v3.0 -->
    <div class="modal" id="taskModal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 id="modalTitle">Nova Tarefa</h2>
                <button class="close-btn" onclick="closeModal()">√ó</button>
            </div>
            
            <!-- v3.0: Tabs -->
            <div class="modal-tabs">
                <button class="modal-tab active" data-tab="details" onclick="switchModalTab('details')">
                    üìù Detalhes
                </button>
                <button class="modal-tab" data-tab="history" onclick="switchModalTab('history')">
                    üìú Hist√≥rico
                </button>
            </div>
            
            <!-- Tab: Detalhes -->
            <div class="tab-content active" id="tab-details">
                <form id="taskForm" onsubmit="saveTask(event)">
                    <div class="form-group">
                        <label for="taskTitle">T√≠tulo *</label>
                        <input type="text" id="taskTitle" required placeholder="Digite o t√≠tulo da tarefa">
                    </div>
                    
                    <div class="form-group">
                        <label for="taskDescription">Descri√ß√£o</label>
                        <textarea id="taskDescription" placeholder="Descreva a tarefa..."></textarea>
                    </div>
                    
                    <!-- v3.0: M√∫ltiplos Respons√°veis -->
                    <div class="form-group">
                        <label>üë• Respons√°veis</label>
                        <div class="assignees-selector">
                            <div class="assignees-selected" id="assigneesSelected">
                                <div style="color: var(--text-secondary); font-size: 13px; padding: 8px;">
                                    Nenhum respons√°vel selecionado
                                </div>
                            </div>
                            <button type="button" class="btn-add-assignee" onclick="showAssigneeSelector()">
                                + Adicionar Respons√°vel
                            </button>
                        </div>
                    </div>
                    
                    <div class="form-group">
                        <label for="taskPriority">Prioridade *</label>
                        <select id="taskPriority" required>
                            <option value="low">Baixa</option>
                            <option value="medium" selected>M√©dia</option>
                            <option value="high">Alta</option>
                        </select>
                    </div>
                    
                    <div class="form-group" id="swimlaneSelectGroup" style="display: none;">
                        <label for="taskSwimlane">Raia</label>
                        <select id="taskSwimlane">
                            <!-- Options will be populated dynamically -->
                        </select>
                    </div>
                    
                    <div class="form-group">
                        <label for="taskStatus">Status *</label>
                        <select id="taskStatus" required>
                            <!-- Options will be populated dynamically -->
                        </select>
                    </div>
                    
                    <div class="form-group">
                        <label for="taskAssignee">Respons√°vel (legado)</label>
                        <input type="text" id="taskAssignee" placeholder="Nome do respons√°vel">
                    </div>
                    
                    <div class="form-group">
                        <label for="taskAssigneeEmail">Email do Respons√°vel</label>
                        <input type="email" id="taskAssigneeEmail" placeholder="email@exemplo.com">
                    </div>
                    
                    <div class="form-group">
                        <label style="display: flex; align-items: center; gap: 8px; cursor: pointer;">
                            <input type="checkbox" id="sendNotification" style="width: auto; cursor: pointer;">
                            <span>Enviar notifica√ß√£o por email ao salvar</span>
                        </label>
                    </div>
                    
                    <div class="form-group">
                        <label for="taskStartDate">Data de In√≠cio</label>
                        <input type="date" id="taskStartDate">
                    </div>
                    
                    <div class="form-group">
                        <label for="taskEndDate">Data de T√©rmino</label>
                        <input type="date" id="taskEndDate">
                    </div>
                    
                    <div class="form-group">
                        <label for="taskLeadTime">Lead Time (dias)</label>
                        <input type="text" id="taskLeadTime" readonly style="background: var(--bg-hover); cursor: not-allowed;" placeholder="Calculado automaticamente">
                        <small style="color: var(--text-secondary); font-size: 12px; margin-top: 4px; display: block;">
                            ‚è±Ô∏è Tempo decorrido entre in√≠cio e fim da tarefa
                        </small>
                    </div>
                    
                    <div class="form-group">
                        <label for="taskTags">Tags (separadas por v√≠rgula)</label>
                        <input type="text" id="taskTags" placeholder="frontend, bug, urgente">
                    </div>
                    
                    <div class="form-actions">
                        <button type="button" class="btn btn-secondary" onclick="closeModal()">Cancelar</button>
                        <button type="submit" class="btn">üíæ Salvar Tarefa</button>
                    </div>
                </form>
            </div>
            
            <!-- Tab: Hist√≥rico -->
            <div class="tab-content" id="tab-history">
                <div class="history-timeline" id="historyTimeline">
                    <!-- Hist√≥rico ser√° renderizado aqui -->
                </div>
            </div>
        </div>
    </div>



    <!-- Column Modal -->
    <div class="modal" id="columnModal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 id="columnModalTitle">Nova Coluna</h2>
                <button class="close-btn" onclick="closeColumnModal()">√ó</button>
            </div>
            <form id="columnForm" onsubmit="saveColumn(event)">
                <div class="form-group">
                    <label for="columnName">Nome da Coluna *</label>
                    <input type="text" id="columnName" required placeholder="Ex: Em Revis√£o, Testando, Aprovado...">
                </div>
                <div class="form-group">
                    <label>√çcone da Coluna</label>
                    <div class="emoji-preview">
                        <div class="emoji-preview-icon" id="columnEmojiPreview">üìå</div>
                        <div class="emoji-preview-text">Clique em um emoji abaixo para selecionar</div>
                    </div>
                    <input type="hidden" id="columnIcon" value="üìå">
                    <div class="emoji-picker-container">
                        <div class="emoji-category">S√≠mbolos de Status</div>
                        <div class="emoji-grid" id="columnEmojiGrid">
                            <div class="emoji-item" onclick="selectColumnEmoji('üìå')">üìå</div>
                            <div class="emoji-item" onclick="selectColumnEmoji('‚úÖ')">‚úÖ</div>
                            <div class="emoji-item" onclick="selectColumnEmoji('üéØ')">üéØ</div>
                            <div class="emoji-item" onclick="selectColumnEmoji('‚è≥')">‚è≥</div>
                            <div class="emoji-item" onclick="selectColumnEmoji('üîÑ')">üîÑ</div>
                            <div class="emoji-item" onclick="selectColumnEmoji('‚úîÔ∏è')">‚úîÔ∏è</div>
                            <div class="emoji-item" onclick="selectColumnEmoji('‚≠ê')">‚≠ê</div>
                            <div class="emoji-item" onclick="selectColumnEmoji('üöÄ')">üöÄ</div>
                            <div class="emoji-item" onclick="selectColumnEmoji('üìã')">üìã</div>
                            <div class="emoji-item" onclick="selectColumnEmoji('üìù')">üìù</div>
                            <div class="emoji-item" onclick="selectColumnEmoji('üîç')">üîç</div>
                            <div class="emoji-item" onclick="selectColumnEmoji('‚ö°')">‚ö°</div>
                            <div class="emoji-item" onclick="selectColumnEmoji('üé®')">üé®</div>
                            <div class="emoji-item" onclick="selectColumnEmoji('üõ†Ô∏è')">üõ†Ô∏è</div>
                            <div class="emoji-item" onclick="selectColumnEmoji('üß™')">üß™</div>
                            <div class="emoji-item" onclick="selectColumnEmoji('üì¶')">üì¶</div>
                            <div class="emoji-item" onclick="selectColumnEmoji('üèÅ')">üèÅ</div>
                            <div class="emoji-item" onclick="selectColumnEmoji('üéâ')">üéâ</div>
                            <div class="emoji-item" onclick="selectColumnEmoji('üí°')">üí°</div>
                            <div class="emoji-item" onclick="selectColumnEmoji('üîß')">üîß</div>
                            <div class="emoji-item" onclick="selectColumnEmoji('‚öôÔ∏è')">‚öôÔ∏è</div>
                            <div class="emoji-item" onclick="selectColumnEmoji('üî®')">üî®</div>
                            <div class="emoji-item" onclick="selectColumnEmoji('üé™')">üé™</div>
                            <div class="emoji-item" onclick="selectColumnEmoji('üé≠')">üé≠</div>
                        </div>
                        <div class="emoji-category">Setas e Dire√ß√µes</div>
                        <div class="emoji-grid">
                            <div class="emoji-item" onclick="selectColumnEmoji('‚û°Ô∏è')">‚û°Ô∏è</div>
                            <div class="emoji-item" onclick="selectColumnEmoji('‚¨ÖÔ∏è')">‚¨ÖÔ∏è</div>
                            <div class="emoji-item" onclick="selectColumnEmoji('‚¨ÜÔ∏è')">‚¨ÜÔ∏è</div>
                            <div class="emoji-item" onclick="selectColumnEmoji('‚¨áÔ∏è')">‚¨áÔ∏è</div>
                            <div class="emoji-item" onclick="selectColumnEmoji('‚ÜóÔ∏è')">‚ÜóÔ∏è</div>
                            <div class="emoji-item" onclick="selectColumnEmoji('‚ÜòÔ∏è')">‚ÜòÔ∏è</div>
                            <div class="emoji-item" onclick="selectColumnEmoji('üîÄ')">üîÄ</div>
                            <div class="emoji-item" onclick="selectColumnEmoji('üîÅ')">üîÅ</div>
                        </div>
                        <div class="emoji-category">Bandeiras e Marcadores</div>
                        <div class="emoji-grid">
                            <div class="emoji-item" onclick="selectColumnEmoji('üö©')">üö©</div>
                            <div class="emoji-item" onclick="selectColumnEmoji('üè¥')">üè¥</div>
                            <div class="emoji-item" onclick="selectColumnEmoji('üè≥Ô∏è')">üè≥Ô∏è</div>
                            <div class="emoji-item" onclick="selectColumnEmoji('üéå')">üéå</div>
                            <div class="emoji-item" onclick="selectColumnEmoji('üìç')">üìç</div>
                            <div class="emoji-item" onclick="selectColumnEmoji('üìé')">üìé</div>
                            <div class="emoji-item" onclick="selectColumnEmoji('üîñ')">üîñ</div>
                            <div class="emoji-item" onclick="selectColumnEmoji('üè∑Ô∏è')">üè∑Ô∏è</div>
                        </div>
                        <div class="emoji-category">Objetos</div>
                        <div class="emoji-grid">
                            <div class="emoji-item" onclick="selectColumnEmoji('üíº')">üíº</div>
                            <div class="emoji-item" onclick="selectColumnEmoji('üìä')">üìä</div>
                            <div class="emoji-item" onclick="selectColumnEmoji('üìà')">üìà</div>
                            <div class="emoji-item" onclick="selectColumnEmoji('üìâ')">üìâ</div>
                            <div class="emoji-item" onclick="selectColumnEmoji('üóÇÔ∏è')">üóÇÔ∏è</div>
                            <div class="emoji-item" onclick="selectColumnEmoji('üìÅ')">üìÅ</div>
                            <div class="emoji-item" onclick="selectColumnEmoji('üìÇ')">üìÇ</div>
                            <div class="emoji-item" onclick="selectColumnEmoji('üóÉÔ∏è')">üóÉÔ∏è</div>
                        </div>
                    </div>
                </div>
                <div class="form-actions">
                    <button type="button" class="btn btn-secondary" onclick="closeColumnModal()">Cancelar</button>
                    <button type="submit" class="btn">Criar Coluna</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Swimlane Modal -->
    <div class="modal" id="swimlaneModal">
        <div class="modal-content" style="max-width: 700px;">
            <div class="modal-header">
                <h2 id="swimlaneModalTitle">Nova Raia</h2>
                <button class="close-btn" onclick="closeSwimlaneModal()">√ó</button>
            </div>
            <form id="swimlaneForm" onsubmit="saveSwimlane(event)">
                <div class="form-group">
                    <label for="swimlaneName">Nome da Raia *</label>
                    <input type="text" id="swimlaneName" required placeholder="Ex: Frontend, Backend, Design, Urgente...">
                </div>
                <div class="form-group">
                    <label>√çcone da Raia</label>
                    <div class="emoji-preview">
                        <div class="emoji-preview-icon" id="swimlaneEmojiPreview">üèä</div>
                        <div class="emoji-preview-text">Clique em um emoji abaixo para selecionar</div>
                    </div>
                    <input type="hidden" id="swimlaneIcon" value="üèä">
                    <div class="emoji-picker-container">
                        <div class="emoji-category">Equipes e Departamentos</div>
                        <div class="emoji-grid">
                            <div class="emoji-item" onclick="selectSwimlaneEmoji('üèä')">üèä</div>
                            <div class="emoji-item" onclick="selectSwimlaneEmoji('üíª')">üíª</div>
                            <div class="emoji-item" onclick="selectSwimlaneEmoji('üé®')">üé®</div>
                            <div class="emoji-item" onclick="selectSwimlaneEmoji('üì±')">üì±</div>
                            <div class="emoji-item" onclick="selectSwimlaneEmoji('üñ•Ô∏è')">üñ•Ô∏è</div>
                            <div class="emoji-item" onclick="selectSwimlaneEmoji('üåê')">üåê</div>
                            <div class="emoji-item" onclick="selectSwimlaneEmoji('üì°')">üì°</div>
                            <div class="emoji-item" onclick="selectSwimlaneEmoji('‚öôÔ∏è')">‚öôÔ∏è</div>
                        </div>
                        <div class="emoji-category">Prioridades</div>
                        <div class="emoji-grid">
                            <div class="emoji-item" onclick="selectSwimlaneEmoji('üî¥')">üî¥</div>
                            <div class="emoji-item" onclick="selectSwimlaneEmoji('üü°')">üü°</div>
                            <div class="emoji-item" onclick="selectSwimlaneEmoji('üü¢')">üü¢</div>
                            <div class="emoji-item" onclick="selectSwimlaneEmoji('üîµ')">üîµ</div>
                            <div class="emoji-item" onclick="selectSwimlaneEmoji('üö®')">üö®</div>
                            <div class="emoji-item" onclick="selectSwimlaneEmoji('‚ö†Ô∏è')">‚ö†Ô∏è</div>
                            <div class="emoji-item" onclick="selectSwimlaneEmoji('üî•')">üî•</div>
                            <div class="emoji-item" onclick="selectSwimlaneEmoji('‚≠ê')">‚≠ê</div>
                        </div>
                        <div class="emoji-category">Tipos de Trabalho</div>
                        <div class="emoji-grid">
                            <div class="emoji-item" onclick="selectSwimlaneEmoji('üêõ')">üêõ</div>
                            <div class="emoji-item" onclick="selectSwimlaneEmoji('‚ú®')">‚ú®</div>
                            <div class="emoji-item" onclick="selectSwimlaneEmoji('üîß')">üîß</div>
                            <div class="emoji-item" onclick="selectSwimlaneEmoji('üìù')">üìù</div>
                            <div class="emoji-item" onclick="selectSwimlaneEmoji('üß™')">üß™</div>
                            <div class="emoji-item" onclick="selectSwimlaneEmoji('üì¶')">üì¶</div>
                            <div class="emoji-item" onclick="selectSwimlaneEmoji('üöÄ')">üöÄ</div>
                            <div class="emoji-item" onclick="selectSwimlaneEmoji('üéØ')">üéØ</div>
                        </div>
                        <div class="emoji-category">Pessoas e Times</div>
                        <div class="emoji-grid">
                            <div class="emoji-item" onclick="selectSwimlaneEmoji('üë§')">üë§</div>
                            <div class="emoji-item" onclick="selectSwimlaneEmoji('üë•')">üë•</div>
                            <div class="emoji-item" onclick="selectSwimlaneEmoji('üë®‚Äçüíª')">üë®‚Äçüíª</div>
                            <div class="emoji-item" onclick="selectSwimlaneEmoji('üë©‚Äçüíª')">üë©‚Äçüíª</div>
                            <div class="emoji-item" onclick="selectSwimlaneEmoji('üë®‚Äçüé®')">üë®‚Äçüé®</div>
                            <div class="emoji-item" onclick="selectSwimlaneEmoji('üë©‚Äçüé®')">üë©‚Äçüé®</div>
                            <div class="emoji-item" onclick="selectSwimlaneEmoji('üëî')">üëî</div>
                            <div class="emoji-item" onclick="selectSwimlaneEmoji('üéì')">üéì</div>
                        </div>
                    </div>
                </div>
                
                <!-- Template de Colunas -->
                <div class="form-group" id="columnTemplateGroup" style="display: none;">
                    <label>Template de Colunas</label>
                    <p style="font-size: 13px; color: var(--text-secondary); margin-bottom: 12px;">
                        Escolha um template de colunas para esta raia. Voc√™ pode adicionar/remover colunas depois.
                    </p>
                    <select id="columnTemplate" class="form-control" onchange="previewColumnTemplate()" style="width: 100%; padding: 10px; border: 1px solid var(--border); border-radius: 6px; background: var(--bg-secondary); color: var(--text); font-size: 14px;">
                        <option value="empty">üèä Raia Vazia (Sem colunas - adicionar depois)</option>
                        <option value="development">üíª Desenvolvimento (Backlog ‚Üí Code Review ‚Üí Testing ‚Üí Deploy)</option>
                        <option value="design">üé® Design (Idea√ß√£o ‚Üí Wireframe ‚Üí Prot√≥tipo ‚Üí Aprovado)</option>
                        <option value="bugs">üêõ Bug Tracking (Reportado ‚Üí Triagem ‚Üí Em Corre√ß√£o ‚Üí Testado ‚Üí Resolvido)</option>
                        <option value="features">‚ú® Feature Development (Planejamento ‚Üí Dev ‚Üí QA ‚Üí Staging ‚Üí Produ√ß√£o)</option>
                        <option value="kanban">üìã Kanban Cl√°ssico (Backlog ‚Üí A Fazer ‚Üí Em Progresso ‚Üí Conclu√≠do)</option>
                        <option value="scrum">üöÄ Sprint Scrum (Product Backlog ‚Üí Sprint Backlog ‚Üí In Progress ‚Üí Review ‚Üí Done)</option>
                        <option value="marketing">üìä Marketing (Ideias ‚Üí Planejamento ‚Üí Cria√ß√£o ‚Üí Aprova√ß√£o ‚Üí Publicado)</option>
                        <option value="sales">üíº Vendas (Lead ‚Üí Qualifica√ß√£o ‚Üí Proposta ‚Üí Negocia√ß√£o ‚Üí Fechado)</option>
                        <option value="onboarding">üéì Onboarding (Inicial ‚Üí Treinamento ‚Üí Pr√°tica ‚Üí Avalia√ß√£o ‚Üí Completo)</option>
                    </select>
                    <div id="columnTemplatePreview" style="margin-top: 12px; padding: 12px; background: var(--bg-hover); border-radius: 6px; font-size: 13px; color: var(--text-secondary); display: none;">
                        <!-- Preview ser√° preenchido via JavaScript -->
                    </div>
                </div>
                
                <div class="form-actions">
                    <button type="button" class="btn btn-secondary" onclick="closeSwimlaneModal()">Cancelar</button>
                    <button type="submit" class="btn">Criar Raia</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Modal de Sele√ß√£o de Raia para Importa√ß√£o -->
    <div class="modal" id="importSwimlaneModal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>üì• Selecionar Destino da Importa√ß√£o</h2>
                <button class="close-btn" onclick="closeImportSwimlaneModal()">√ó</button>
            </div>
            <div class="modal-body">
                <p style="margin-bottom: 20px; color: var(--text-secondary);">
                    <strong id="importTaskCount">0</strong> tarefa(s) ser√°(√£o) importada(s). 
                    Escolha onde deseja adicionar essas tarefas:
                </p>
                
                <div class="form-group">
                    <label>Modo de Importa√ß√£o</label>
                    <div style="display: flex; flex-direction: column; gap: 12px; margin-top: 12px;">
                        <label class="radio-option" style="display: flex; align-items: flex-start; padding: 16px; border: 2px solid var(--border); border-radius: 8px; cursor: pointer; transition: all 0.2s;">
                            <input type="radio" name="importMode" value="normal" checked onchange="updateImportModeDisplay()" style="margin-top: 4px; margin-right: 12px;">
                            <div>
                                <div style="font-weight: 600; margin-bottom: 4px;">üìã Modo Normal</div>
                                <div style="font-size: 13px; color: var(--text-secondary);">
                                    As tarefas ser√£o importadas sem raia associada (modo tradicional)
                                </div>
                            </div>
                        </label>
                        
                        <label class="radio-option" style="display: flex; align-items: flex-start; padding: 16px; border: 2px solid var(--border); border-radius: 8px; cursor: pointer; transition: all 0.2s;">
                            <input type="radio" name="importMode" value="swimlane" onchange="updateImportModeDisplay()" style="margin-top: 4px; margin-right: 12px;">
                            <div style="flex: 1;">
                                <div style="font-weight: 600; margin-bottom: 4px;">üèä Importar em Raia</div>
                                <div style="font-size: 13px; color: var(--text-secondary); margin-bottom: 12px;">
                                    Todas as tarefas ser√£o adicionadas √† raia selecionada
                                </div>
                                <div id="swimlaneSelectContainer" style="display: none;">
                                    <select id="importSwimlaneSelect" class="form-control" style="width: 100%; padding: 8px; border: 1px solid var(--border); border-radius: 4px; background: var(--bg-secondary); color: var(--text);">
                                        <!-- Op√ß√µes ser√£o preenchidas via JavaScript -->
                                    </select>
                                </div>
                            </div>
                        </label>
                    </div>
                </div>
            </div>
            <div class="form-actions">
                <button type="button" class="btn btn-secondary" onclick="closeImportSwimlaneModal()">Cancelar</button>
                <button type="button" class="btn" onclick="confirmImport()">Importar</button>
            </div>
        </div>
    </div>

    <script>
        // ====== LOG INICIAL DE CARREGAMENTO ======
        console.log('üöÄ TaskFlow v3.0.58 - Script JavaScript iniciado');
        console.log('‚è∞ Timestamp:', new Date().toLocaleString());
        console.log('üìç URL:', window.location.href);
        console.log('=======================================');
        
        // State management
        let tasks = JSON.parse(localStorage.getItem('kanban-tasks')) || [];
        
        // Separate columns for each mode
        let normalColumns = JSON.parse(localStorage.getItem('kanban-normal-columns')) || [
            { id: 'backlog', name: 'Backlog', icon: 'üìã', order: 0 },
            { id: 'todo', name: 'A Fazer', icon: 'üìù', order: 1 },
            { id: 'doing', name: 'Em Progresso', icon: '‚ö°', order: 2 },
            { id: 'done', name: 'Conclu√≠do', icon: '‚úÖ', order: 3 }
        ];
        
        let swimlaneColumns = JSON.parse(localStorage.getItem('kanban-swimlane-columns')) || [
            { id: 'backlog-sl', name: 'Backlog', icon: 'üìã', order: 0 },
            { id: 'todo-sl', name: 'A Fazer', icon: 'üìù', order: 1 },
            { id: 'doing-sl', name: 'Em Progresso', icon: '‚ö°', order: 2 },
            { id: 'done-sl', name: 'Conclu√≠do', icon: '‚úÖ', order: 3 }
        ];
        
        // Active columns based on current mode
        let columns = [];
        
        let swimlanes = JSON.parse(localStorage.getItem('kanban-swimlanes')) || [];
        let swimlanesMode = JSON.parse(localStorage.getItem('kanban-swimlanes-mode')) || false;
        let currentTheme = localStorage.getItem('kanban-theme') || 'dark';
        let taskIdCounter = tasks.length > 0 ? Math.max(...tasks.map(t => t.id)) + 1 : 1;
        
        // ==================== MIGRA√á√ÉO: Adicionar 'type' em colunas antigas ====================
        function migrateColumnsAndTasks() {
            let needsSave = false;
            
            // Migrar colunas de swimlanes
            swimlanes.forEach(swimlane => {
                if (swimlane.columns) {
                    swimlane.columns.forEach(column => {
                        if (!column.type) {
                            // Inferir tipo pelo nome ou ID
                            const nameLower = column.name.toLowerCase();
                            const idLower = column.id.toLowerCase();
                            
                            if (nameLower.includes('conclu') || nameLower.includes('done') || 
                                nameLower.includes('feito') || idLower.includes('done')) {
                                column.type = 'done';
                            } else if (nameLower.includes('progr') || nameLower.includes('doing') || 
                                       nameLower.includes('andamento') || idLower.includes('doing')) {
                                column.type = 'doing';
                            } else if (nameLower.includes('fazer') || nameLower.includes('todo') || 
                                       nameLower.includes('backlog') || idLower.includes('todo') || 
                                       idLower.includes('backlog')) {
                                column.type = 'todo';
                            } else {
                                // Padr√£o: doing
                                column.type = 'doing';
                            }
                            
                            needsSave = true;
                            console.log(`‚úÖ Migra√ß√£o: Coluna "${column.name}" ‚Üí type="${column.type}"`);
                        }
                    });
                }
            });
            
            if (needsSave) {
                localStorage.setItem('kanban-swimlanes', JSON.stringify(swimlanes));
                console.log('‚úÖ Migra√ß√£o de colunas conclu√≠da!');
            }
            
            // Migrar tarefas: adicionar columnType baseado no status
            let tasksNeedSave = false;
            tasks.forEach(task => {
                if (!task.columnType && task.status) {
                    // Se tem swimlane, procurar o tipo da coluna
                    if (task.swimlane) {
                        const swimlane = swimlanes.find(s => s.id === task.swimlane);
                        if (swimlane && swimlane.columns) {
                            const column = swimlane.columns.find(c => c.id === task.status);
                            if (column && column.type) {
                                task.columnType = column.type;
                                tasksNeedSave = true;
                            }
                        }
                    } else {
                        // Modo normal: status j√° √© o tipo
                        task.columnType = task.status;
                        tasksNeedSave = true;
                    }
                }
            });
            
            if (tasksNeedSave) {
                localStorage.setItem('kanban-tasks', JSON.stringify(tasks));
                console.log(`‚úÖ Migra√ß√£o de ${tasks.length} tarefas conclu√≠da!`);
            }
        }
        
        // Executar migra√ß√£o
        migrateColumnsAndTasks();
        // ====================================================================================
        let currentFilter = 'all';
        let editingTaskId = null;
        let editingColumnId = null;
        let editingSwimlaneId = null;

        // Normalize tasks - ensure swimlane property exists
        // Tasks without swimlane are for normal mode
        // Tasks with swimlane are for swimlanes mode
        tasks = tasks.map(task => {
            if (!task.hasOwnProperty('swimlane')) {
                task.swimlane = ''; // Empty string = normal mode task
            }
            return task;
        });
        // Save normalized tasks
        localStorage.setItem('kanban-tasks', JSON.stringify(tasks));

        // v3.0: M√∫ltiplos Respons√°veis
        let people = [];
        let currentTaskAssignees = [];

        // v3.0: Hist√≥rico
        let currentUser = 'Usu√°rio';

        // v3.0: Modal State
        let currentModalTab = 'details';

        // Initialize
        document.addEventListener('DOMContentLoaded', () => {
            applyBasicTheme();
            updateActiveColumns(); // Set correct columns based on mode
            updateSwimlanesMode();
            loadPeople(); // v3.0
            checkForTemplate(); // v3.0
            currentUser = getCurrentUser(); // v3.0
            renderBoard();
            renderAllTasks();
            updateStats();
            setupEventListeners();
            setupDragAndDrop(); // Initialize drag and drop
        });

        function toggleTheme() {
            currentTheme = currentTheme === 'dark' ? 'light' : 'dark';
            localStorage.setItem('kanban-theme', currentTheme);
            applyBasicTheme();
        }

        function applyBasicTheme() {
            const body = document.body;
            const themeToggle = document.getElementById('themeToggle');
            
            if (currentTheme === 'light') {
                body.setAttribute('data-theme', 'light');
                if (themeToggle) themeToggle.textContent = 'üåô';
            } else {
                body.removeAttribute('data-theme');
                if (themeToggle) themeToggle.textContent = '‚òÄÔ∏è';
            }
        }

        function setupEventListeners() {
            // Search
            document.getElementById('searchInput').addEventListener('input', (e) => {
                const searchTerm = e.target.value.toLowerCase();
                filterTasks(searchTerm);
            });

            // Filter tags
            document.querySelectorAll('.filter-tag').forEach(tag => {
                tag.addEventListener('click', () => {
                    document.querySelectorAll('.filter-tag').forEach(t => t.classList.remove('active'));
                    tag.classList.add('active');
                    currentFilter = tag.dataset.filter;
                    renderAllTasks();
                });
            });
        }

        function toggleSwimlanesMode() {
            console.log('üîÑ Toggle chamado! Modo atual:', swimlanesMode);
            swimlanesMode = !swimlanesMode;
            console.log('‚úÖ Novo modo:', swimlanesMode ? 'RAIAS' : 'NORMAL');
            localStorage.setItem('kanban-swimlanes-mode', JSON.stringify(swimlanesMode));
            
            // Switch active columns based on mode
            updateActiveColumns();
            
            updateSwimlanesMode();
            renderBoard();
            renderAllTasks();
            updateStats(); // Update stats after mode change
        }
        
        function updateActiveColumns() {
            if (swimlanesMode) {
                columns = swimlaneColumns;
            } else {
                columns = normalColumns;
            }
        }

        function updateSwimlanesMode() {
            console.log('üìä UpdateSwimlanesMode chamado. Modo:', swimlanesMode);
            const swimlanesContainer = document.getElementById('swimlanesContainer');
            const normalBoard = document.getElementById('board');
            const toggleIcon = document.getElementById('swimlaneToggleIcon');
            const toggleText = document.getElementById('swimlaneToggleText');

            if (swimlanesMode) {
                console.log('üèä Ativando MODO RAIAS');
                swimlanesContainer.style.display = 'block';
                normalBoard.style.display = 'none';
                toggleIcon.textContent = 'üìã';
                toggleText.textContent = 'Modo Normal';
                renderSwimlanes();
            } else {
                console.log('üìã Ativando MODO NORMAL');
                swimlanesContainer.style.display = 'none';
                normalBoard.style.display = 'flex';
                toggleIcon.textContent = 'üèä';
                toggleText.textContent = 'Ativar Raias';
            }

            // Show/hide swimlane field in task modal
            const swimlaneGroup = document.getElementById('swimlaneSelectGroup');
            if (swimlanesMode && swimlanes.length > 0) {
                swimlaneGroup.style.display = 'block';
                updateTaskSwimlaneSelect();
            } else {
                swimlaneGroup.style.display = 'none';
            }
        }

        function renderSwimlanes() {
            const container = document.getElementById('swimlanesContainer');
            container.innerHTML = '';

            if (swimlanes.length === 0) {
                const emptyState = document.createElement('div');
                emptyState.className = 'add-swimlane-btn';
                emptyState.innerHTML = `
                    <div style="font-size: 24px;">üèä</div>
                    <div>Criar primeira raia</div>
                `;
                emptyState.onclick = openSwimlaneModal;
                container.appendChild(emptyState);
                return;
            }

            swimlanes.forEach((swimlane, index) => {
                const swimlaneEl = createSwimlaneElement(swimlane, index);
                container.appendChild(swimlaneEl);
            });

            // Add swimlane button
            const addBtn = document.createElement('div');
            addBtn.className = 'add-swimlane-btn';
            addBtn.innerHTML = `
                <div style="font-size: 20px;">‚ûï</div>
                <div>Adicionar Raia</div>
            `;
            addBtn.onclick = openSwimlaneModal;
            container.appendChild(addBtn);

            // Setup drag and drop
            setupDragAndDrop();
        }

        function createSwimlaneElement(swimlane, index) {
            const div = document.createElement('div');
            div.className = 'swimlane';
            div.dataset.swimlaneId = swimlane.id;
            
            const tasksInSwimlane = tasks.filter(t => t.swimlane === swimlane.id);
            const isCollapsed = swimlane.collapsed || false;
            
            if (isCollapsed) {
                div.classList.add('collapsed');
            }

            const canDelete = swimlanes.length > 1;

            const header = document.createElement('div');
            header.className = 'swimlane-header';
            header.innerHTML = `
                <div class="swimlane-title-section">
                    <span class="swimlane-icon">${swimlane.icon || 'üèä'}</span>
                    <span class="swimlane-title">${swimlane.name}</span>
                    <span class="swimlane-badge">${tasksInSwimlane.length}</span>
                </div>
                <div class="swimlane-actions">
                    <button class="swimlane-action-btn" onclick="event.stopPropagation(); editSwimlane('${swimlane.id}')" title="Editar raia">‚úèÔ∏è</button>
                    ${canDelete ? `<button class="swimlane-action-btn delete" onclick="event.stopPropagation(); deleteSwimlane('${swimlane.id}')" title="Excluir raia">üóëÔ∏è</button>` : ''}
                    <span class="swimlane-toggle">üîΩ</span>
                </div>
            `;
            
            header.onclick = () => toggleSwimlane(swimlane.id);

            const content = document.createElement('div');
            content.className = 'swimlane-content';
            
            const board = document.createElement('div');
            board.className = 'board';
            board.dataset.swimlaneId = swimlane.id;
            
            // NOVO: Usar colunas espec√≠ficas da raia OU colunas globais (retrocompatibilidade)
            const swimlaneColumns = swimlane.columns && swimlane.columns.length > 0 
                ? swimlane.columns 
                : columns; // Fallback para raias antigas
            
            const sortedColumns = [...swimlaneColumns].sort((a, b) => a.order - b.order);
            sortedColumns.forEach((column, colIndex) => {
                const columnEl = createColumnElement(column, colIndex, swimlane.id);
                board.appendChild(columnEl);
            });

            // Add column button - apenas para raias vazias
            if (!swimlane.columns || swimlane.columns.length === 0) {
                const addColumnBtn = document.createElement('div');
                addColumnBtn.className = 'add-column-btn';
                addColumnBtn.innerHTML = `
                    <div class="add-column-btn-icon">‚ûï</div>
                    <div>Adicionar Coluna</div>
                `;
                addColumnBtn.onclick = () => addColumnToSwimlane(swimlane.id);
                board.appendChild(addColumnBtn);
            }

            content.appendChild(board);
            div.appendChild(header);
            div.appendChild(content);

            return div;
        }

        function toggleSwimlane(swimlaneId) {
            const swimlane = swimlanes.find(s => s.id === swimlaneId);
            if (!swimlane) return;

            swimlane.collapsed = !swimlane.collapsed;
            saveSwimlanes();
            renderSwimlanes();
            renderAllTasks();
        }

        // Adicionar coluna em raia espec√≠fica
        function addColumnToSwimlane(swimlaneId) {
            const swimlane = swimlanes.find(s => s.id === swimlaneId);
            if (!swimlane) return;
            
            const columnName = prompt('Nome da nova coluna:', 'Nova Coluna');
            if (!columnName) return;
            
            const columnIcon = prompt('√çcone da coluna (emoji):', 'üìå');
            
            // Perguntar o tipo da coluna (doing, done, todo)
            const columnType = prompt('Tipo da coluna (todo/doing/done):', 'doing');
            
            if (!swimlane.columns) {
                swimlane.columns = [];
            }
            
            const newColumn = {
                id: `${swimlane.id}-${columnName.toLowerCase().replace(/\s+/g, '-')}-${Date.now()}`,
                name: columnName,
                icon: columnIcon || 'üìå',
                type: columnType || 'doing',  // ‚Üê NOVO: tipo base da coluna
                order: swimlane.columns.length
            };
            
            swimlane.columns.push(newColumn);
            saveSwimlanes();
            renderSwimlanes();
            renderAllTasks();
        }

        // Templates de colunas para raias
        const columnTemplates = {
            empty: [],
            development: [
                { name: 'Backlog', icon: 'üìã' },
                { name: 'Code Review', icon: 'üëÅÔ∏è' },
                { name: 'Testing', icon: 'üß™' },
                { name: 'Deploy', icon: 'üöÄ' }
            ],
            design: [
                { name: 'Idea√ß√£o', icon: 'üí°' },
                { name: 'Wireframe', icon: 'üìê' },
                { name: 'Prot√≥tipo', icon: 'üé®' },
                { name: 'Aprovado', icon: '‚úÖ' }
            ],
            bugs: [
                { name: 'Reportado', icon: 'üìù' },
                { name: 'Triagem', icon: 'üîç' },
                { name: 'Em Corre√ß√£o', icon: 'üîß' },
                { name: 'Testado', icon: 'üß™' },
                { name: 'Resolvido', icon: '‚úÖ' }
            ],
            features: [
                { name: 'Planejamento', icon: 'üìã' },
                { name: 'Desenvolvimento', icon: 'üíª' },
                { name: 'QA', icon: 'üß™' },
                { name: 'Staging', icon: 'üé≠' },
                { name: 'Produ√ß√£o', icon: 'üöÄ' }
            ],
            kanban: [
                { name: 'Backlog', icon: 'üìã' },
                { name: 'A Fazer', icon: 'üìù' },
                { name: 'Em Progresso', icon: '‚ö°' },
                { name: 'Conclu√≠do', icon: '‚úÖ' }
            ],
            scrum: [
                { name: 'Product Backlog', icon: 'üì¶' },
                { name: 'Sprint Backlog', icon: 'üéØ' },
                { name: 'In Progress', icon: '‚ö°' },
                { name: 'Review', icon: 'üëÅÔ∏è' },
                { name: 'Done', icon: '‚úÖ' }
            ],
            marketing: [
                { name: 'Ideias', icon: 'üí°' },
                { name: 'Planejamento', icon: 'üìã' },
                { name: 'Cria√ß√£o', icon: 'üé®' },
                { name: 'Aprova√ß√£o', icon: 'üëÅÔ∏è' },
                { name: 'Publicado', icon: 'üì¢' }
            ],
            sales: [
                { name: 'Lead', icon: 'üë§' },
                { name: 'Qualifica√ß√£o', icon: 'üîç' },
                { name: 'Proposta', icon: 'üìÑ' },
                { name: 'Negocia√ß√£o', icon: 'üí¨' },
                { name: 'Fechado', icon: 'ü§ù' }
            ],
            onboarding: [
                { name: 'Inicial', icon: 'üëã' },
                { name: 'Treinamento', icon: 'üìö' },
                { name: 'Pr√°tica', icon: 'üíª' },
                { name: 'Avalia√ß√£o', icon: 'üìä' },
                { name: 'Completo', icon: 'üéì' }
            ]
        };

        // Preview do template selecionado
        function previewColumnTemplate() {
            const template = document.getElementById('columnTemplate').value;
            const preview = document.getElementById('columnTemplatePreview');
            const columns = columnTemplates[template];
            
            if (!columns || columns.length === 0) {
                preview.style.display = 'none';
                return;
            }
            
            const columnNames = columns.map(c => `${c.icon} ${c.name}`).join(' ‚Üí ');
            preview.innerHTML = `<strong>Colunas:</strong> ${columnNames}`;
            preview.style.display = 'block';
        }

        function openSwimlaneModal() {
            editingSwimlaneId = null;
            document.getElementById('swimlaneModalTitle').textContent = 'Nova Raia';
            document.getElementById('swimlaneForm').reset();
            document.getElementById('swimlaneIcon').value = 'üèä';
            document.getElementById('swimlaneEmojiPreview').textContent = 'üèä';
            updateSwimlaneEmojiSelection('üèä');
            
            // Mostrar seletor de template ao criar nova raia
            document.getElementById('columnTemplateGroup').style.display = 'block';
            document.getElementById('columnTemplate').value = 'empty';
            document.getElementById('columnTemplatePreview').style.display = 'none';
            
            document.getElementById('swimlaneModal').classList.add('active');
        }

        function closeSwimlaneModal() {
            document.getElementById('swimlaneModal').classList.remove('active');
            editingSwimlaneId = null;
        }
        
        function selectSwimlaneEmoji(emoji) {
            document.getElementById('swimlaneIcon').value = emoji;
            document.getElementById('swimlaneEmojiPreview').textContent = emoji;
            updateSwimlaneEmojiSelection(emoji);
        }
        
        function updateSwimlaneEmojiSelection(selectedEmoji) {
            // Remove selected class from all emojis
            document.querySelectorAll('#swimlaneModal .emoji-item').forEach(item => {
                item.classList.remove('selected');
            });
            
            // Add selected class to chosen emoji
            document.querySelectorAll('#swimlaneModal .emoji-item').forEach(item => {
                if (item.textContent.trim() === selectedEmoji) {
                    item.classList.add('selected');
                }
            });
        }

        function saveSwimlane(event) {
            event.preventDefault();
            
            const name = document.getElementById('swimlaneName').value;
            const icon = document.getElementById('swimlaneIcon').value || 'üèä';

            if (editingSwimlaneId) {
                const swimlaneIndex = swimlanes.findIndex(s => s.id === editingSwimlaneId);
                swimlanes[swimlaneIndex] = {
                    ...swimlanes[swimlaneIndex],
                    name,
                    icon
                };
            } else {
                const id = name.toLowerCase().replace(/\s+/g, '-').replace(/[^a-z0-9-]/g, '');
                const template = document.getElementById('columnTemplate').value;
                const templateColumns = columnTemplates[template] || [];
                
                // Criar colunas espec√≠ficas para esta raia
                const swimlaneColumns = templateColumns.map((col, index) => ({
                    id: `${id}-${col.name.toLowerCase().replace(/\s+/g, '-')}-${Date.now()}-${index}`,
                    name: col.name,
                    icon: col.icon,
                    order: index
                }));
                
                const newSwimlane = {
                    id: id + '-' + Date.now(),
                    name,
                    icon,
                    order: swimlanes.length,
                    collapsed: false,
                    columns: swimlaneColumns // Colunas espec√≠ficas desta raia
                };
                swimlanes.push(newSwimlane);
            }

            saveSwimlanes();
            renderSwimlanes();
            updateTaskSwimlaneSelect();
            renderAllTasks();
            closeSwimlaneModal();
        }

        function editSwimlane(swimlaneId) {
            const swimlane = swimlanes.find(s => s.id === swimlaneId);
            if (!swimlane) return;

            editingSwimlaneId = swimlaneId;
            document.getElementById('swimlaneModalTitle').textContent = 'Editar Raia';
            document.getElementById('swimlaneName').value = swimlane.name;
            document.getElementById('swimlaneIcon').value = swimlane.icon;
            document.getElementById('swimlaneEmojiPreview').textContent = swimlane.icon;
            updateSwimlaneEmojiSelection(swimlane.icon);
            
            // Esconder seletor de template ao editar
            document.getElementById('columnTemplateGroup').style.display = 'none';
            
            document.getElementById('swimlaneModal').classList.add('active');
        }

        function deleteSwimlane(swimlaneId) {
            if (swimlanes.length <= 1) {
                alert('Voc√™ precisa ter pelo menos uma raia!');
                return;
            }

            const swimlane = swimlanes.find(s => s.id === swimlaneId);
            const tasksInSwimlane = tasks.filter(t => t.swimlane === swimlaneId);

            let confirmMessage = `Tem certeza que deseja excluir a raia "${swimlane.name}"?`;
            if (tasksInSwimlane.length > 0) {
                confirmMessage += `\n\n‚ö†Ô∏è Existem ${tasksInSwimlane.length} tarefa(s) nesta raia que ter√£o a raia removida!`;
            }

            if (confirm(confirmMessage)) {
                swimlanes = swimlanes.filter(s => s.id !== swimlaneId);
                // Remove swimlane from tasks but keep the tasks
                tasks.forEach(task => {
                    if (task.swimlane === swimlaneId) {
                        task.swimlane = null;
                    }
                });
                saveSwimlanes();
                saveTasks();
                renderSwimlanes();
                updateTaskSwimlaneSelect();
                renderAllTasks();
                updateStats();
            }
        }

        function updateTaskSwimlaneSelect() {
            const select = document.getElementById('taskSwimlane');
            select.innerHTML = '<option value="">Sem raia</option>';
            
            swimlanes.forEach(swimlane => {
                const option = document.createElement('option');
                option.value = swimlane.id;
                option.textContent = swimlane.name;
                select.appendChild(option);
            });
        }

        function renderBoard() {
            if (swimlanesMode) {
                renderSwimlanes();
            } else {
                const board = document.getElementById('board');
                board.innerHTML = '';

                // Sort columns by order
                const sortedColumns = [...columns].sort((a, b) => a.order - b.order);

                sortedColumns.forEach((column, index) => {
                    const columnEl = createColumnElement(column, index);
                    board.appendChild(columnEl);
                });

                // Add "Add Column" button
                const addColumnBtn = document.createElement('div');
                addColumnBtn.className = 'add-column-btn';
                addColumnBtn.innerHTML = `
                    <div class="add-column-btn-icon">‚ûï</div>
                    <div>Adicionar Coluna</div>
                `;
                addColumnBtn.onclick = openColumnModal;
                board.appendChild(addColumnBtn);

                // Setup drag and drop after rendering
                setupDragAndDrop();
            }
        }

        function createColumnElement(column, index, swimlaneId = null) {
            const div = document.createElement('div');
            div.className = 'column';
            div.dataset.status = column.id;
            if (swimlaneId) {
                div.dataset.swimlaneId = swimlaneId;
            }
            div.style.animationDelay = `${0.2 + (index * 0.1)}s`;

            const canDelete = columns.length > 1;

            const taskContainerId = swimlaneId ? `${swimlaneId}-${column.id}-tasks` : `${column.id}-tasks`;
            const countId = swimlaneId ? `${swimlaneId}-${column.id}-count` : `${column.id}-count`;

            div.innerHTML = `
                <div class="column-header">
                    <div class="column-title">
                        <span class="column-icon">${column.icon || 'üìå'}</span>
                        ${column.name}
                        <span class="column-badge" id="${countId}">0</span>
                    </div>
                    <div class="column-actions">
                        <button class="column-action-btn" onclick="editColumn('${column.id}')" title="Editar coluna">‚úèÔ∏è</button>
                        ${canDelete ? `<button class="column-action-btn delete" onclick="deleteColumn('${column.id}')" title="Excluir coluna">üóëÔ∏è</button>` : ''}
                    </div>
                </div>
                <div class="tasks" id="${taskContainerId}"></div>
                <button class="add-task-btn" onclick="openModal('${column.id}', '${swimlaneId || ''}')">+ Adicionar tarefa</button>
            `;

            return div;
        }

        function openColumnModal() {
            editingColumnId = null;
            document.getElementById('columnModalTitle').textContent = 'Nova Coluna';
            document.getElementById('columnForm').reset();
            document.getElementById('columnIcon').value = 'üìå';
            document.getElementById('columnEmojiPreview').textContent = 'üìå';
            updateEmojiSelection('üìå');
            document.getElementById('columnModal').classList.add('active');
        }

        function closeColumnModal() {
            document.getElementById('columnModal').classList.remove('active');
            editingColumnId = null;
        }
        
        function selectColumnEmoji(emoji) {
            document.getElementById('columnIcon').value = emoji;
            document.getElementById('columnEmojiPreview').textContent = emoji;
            updateEmojiSelection(emoji);
        }
        
        function updateEmojiSelection(selectedEmoji) {
            // Remove selected class from all emojis
            document.querySelectorAll('#columnModal .emoji-item').forEach(item => {
                item.classList.remove('selected');
            });
            
            // Add selected class to chosen emoji
            document.querySelectorAll('#columnModal .emoji-item').forEach(item => {
                if (item.textContent.trim() === selectedEmoji) {
                    item.classList.add('selected');
                }
            });
        }

        function saveColumn(event) {
            event.preventDefault();
            
            const name = document.getElementById('columnName').value;
            const icon = document.getElementById('columnIcon').value || 'üìå';

            if (editingColumnId) {
                const columnIndex = columns.findIndex(c => c.id === editingColumnId);
                columns[columnIndex] = {
                    ...columns[columnIndex],
                    name,
                    icon
                };
            } else {
                const id = name.toLowerCase().replace(/\s+/g, '-').replace(/[^a-z0-9-]/g, '');
                const newColumn = {
                    id: id + '-' + Date.now(),
                    name,
                    icon,
                    order: columns.length
                };
                columns.push(newColumn);
            }

            saveColumns();
            renderBoard();
            updateTaskStatusSelect();
            renderAllTasks();
            closeColumnModal();
        }

        function editColumn(columnId) {
            const column = columns.find(c => c.id === columnId);
            if (!column) return;

            editingColumnId = columnId;
            document.getElementById('columnModalTitle').textContent = 'Editar Coluna';
            document.getElementById('columnName').value = column.name;
            document.getElementById('columnIcon').value = column.icon;
            document.getElementById('columnEmojiPreview').textContent = column.icon;
            updateEmojiSelection(column.icon);
            document.getElementById('columnModal').classList.add('active');
        }

        function deleteColumn(columnId) {
            if (columns.length <= 1) {
                alert('Voc√™ precisa ter pelo menos uma coluna!');
                return;
            }

            const column = columns.find(c => c.id === columnId);
            const tasksInColumn = tasks.filter(t => t.status === columnId);

            let confirmMessage = `Tem certeza que deseja excluir a coluna "${column.name}"?`;
            if (tasksInColumn.length > 0) {
                confirmMessage += `\n\n‚ö†Ô∏è Existem ${tasksInColumn.length} tarefa(s) nesta coluna que tamb√©m ser√£o exclu√≠das!`;
            }

            if (confirm(confirmMessage)) {
                columns = columns.filter(c => c.id !== columnId);
                tasks = tasks.filter(t => t.status !== columnId);
                saveColumns();
                saveTasks();
                renderBoard();
                updateTaskStatusSelect();
                renderAllTasks();
                updateStats();
            }
        }

        // ========================================
        // v3.0: GEST√ÉO DE PESSOAS
        // ========================================

        function loadPeople() {
            const data = localStorage.getItem('taskflow-people');
            if (data) {
                people = JSON.parse(data);
            } else {
                people = [
                    { id: 'user-1', name: 'Jo√£o Silva', email: 'joao@email.com', avatar: 'JS', color: '#3b82f6' },
                    { id: 'user-2', name: 'Maria Santos', email: 'maria@email.com', avatar: 'MS', color: '#8b5cf6' },
                    { id: 'user-3', name: 'Pedro Costa', email: 'pedro@email.com', avatar: 'PC', color: '#10b981' }
                ];
                savePeople();
            }
        }

        function savePeople() {
            localStorage.setItem('taskflow-people', JSON.stringify(people));
        }

        function getCurrentUser() {
            let user = localStorage.getItem('taskflow-current-user');
            if (!user) {
                user = 'Usu√°rio';
                localStorage.setItem('taskflow-current-user', user);
            }
            return user;
        }

        function managePeople() {
            console.log('‚úÖ Fun√ß√£o managePeople DEFINIDA e EXECUTADA');
            console.log('üë• managePeople() chamado');
            console.log('Pessoas atuais:', people);
            
            const modal = document.createElement('div');
            modal.className = 'modal active';
            modal.id = 'peopleModal';
            
            console.log('Modal criado:', modal);
            
            const peopleList = people.map(p => `
                <div class="person-item" style="display: flex; align-items: center; gap: 12px; padding: 12px; border-radius: 4px; background: var(--bg-hover); margin-bottom: 8px;">
                    <div class="avatar" style="background: ${p.color}">${p.avatar}</div>
                    <div style="flex: 1;">
                        <div style="font-weight: 600; font-size: 14px;">${p.name}</div>
                        <div style="font-size: 12px; color: var(--text-secondary);">${p.email}</div>
                    </div>
                    <button onclick="removePerson('${p.id}')" style="background: var(--accent-red); color: white; border: none; padding: 4px 8px; border-radius: 3px; cursor: pointer; font-size: 12px;">
                        üóëÔ∏è Remover
                    </button>
                </div>
            `).join('');
            
            console.log('Lista de pessoas HTML criada');
            
            modal.innerHTML = `
                <div class="modal-content" style="max-width: 500px;">
                    <div class="modal-header">
                        <h2>üë• Gerenciar Pessoas</h2>
                        <button class="close-btn" onclick="closePeopleModal()">√ó</button>
                    </div>
                    <div style="padding: 24px;">
                        <div style="margin-bottom: 20px;">
                            <h3 style="margin-bottom: 12px; font-size: 14px; font-weight: 600;">Adicionar Nova Pessoa</h3>
                            <div style="display: flex; gap: 8px; margin-bottom: 8px;">
                                <input type="text" id="newPersonName" placeholder="Nome" style="flex: 1; padding: 8px; border: 1px solid var(--border); border-radius: 4px; background: var(--bg-dark); color: var(--text-primary);">
                            </div>
                            <div style="display: flex; gap: 8px; margin-bottom: 8px;">
                                <input type="email" id="newPersonEmail" placeholder="Email" style="flex: 1; padding: 8px; border: 1px solid var(--border); border-radius: 4px; background: var(--bg-dark); color: var(--text-primary);">
                                <button onclick="addNewPerson()" style="background: var(--accent-blue); color: white; border: none; padding: 8px 16px; border-radius: 4px; cursor: pointer; font-weight: 600;">
                                    ‚ûï Adicionar
                                </button>
                            </div>
                        </div>
                        <h3 style="margin-bottom: 12px; font-size: 14px; font-weight: 600;">Pessoas do Projeto</h3>
                        <div id="peopleListContainer" style="max-height: 300px; overflow-y: auto;">
                            ${peopleList}
                        </div>
                    </div>
                </div>
            `;
            
            console.log('HTML do modal definido');
            document.body.appendChild(modal);
            console.log('‚úÖ Modal adicionado ao DOM');
        }

        function closePeopleModal() {
            const modal = document.getElementById('peopleModal');
            if (modal) modal.remove();
        }

        function addNewPerson() {
            const name = document.getElementById('newPersonName').value.trim();
            const email = document.getElementById('newPersonEmail').value.trim();
            
            if (!name || !email) {
                alert('‚ö†Ô∏è Por favor, preencha nome e email!');
                return;
            }
            
            const avatar = name.split(' ').map(n => n[0]).join('').toUpperCase().substring(0, 2);
            const colors = ['#3b82f6', '#8b5cf6', '#10b981', '#f59e0b', '#ef4444', '#06b6d4', '#ec4899', '#8b5cf6'];
            const color = colors[people.length % colors.length];
            
            const person = {
                id: 'user-' + Date.now(),
                name,
                email,
                avatar,
                color
            };
            
            people.push(person);
            savePeople();
            
            closePeopleModal();
            managePeople();
            
            showNotification(`‚úÖ ${name} adicionado(a) ao projeto!`);
        }

        function removePerson(personId) {
            const person = people.find(p => p.id === personId);
            if (!confirm(`Remover ${person.name} do projeto?`)) return;
            
            people = people.filter(p => p.id !== personId);
            savePeople();
            
            closePeopleModal();
            managePeople();
        }

        // ========================================
        // v3.0: M√öLTIPLOS RESPONS√ÅVEIS
        // ========================================

        function renderAssignees(assignees) {
            if (!assignees || assignees.length === 0) return '';
            
            const visible = assignees.slice(0, 3);
            const remaining = assignees.length - 3;
            
            let html = '<div class="task-assignees">';
            
            visible.forEach(a => {
                html += `
                    <div class="avatar" 
                         style="background: ${a.color}" 
                         title="${a.name}">
                        ${a.avatar}
                    </div>
                `;
            });
            
            if (remaining > 0) {
                html += `<div class="avatar-more" title="${remaining} mais">+${remaining}</div>`;
            }
            
            html += '</div>';
            return html;
        }

        function showAssigneeSelector() {
            const modal = document.createElement('div');
            modal.className = 'modal active';
            modal.id = 'assigneeModal';
            
            const peopleList = people.map(p => {
                const isSelected = currentTaskAssignees.some(a => a.id === p.id);
                return `
                    <div class="person-item ${isSelected ? 'selected' : ''}" onclick="toggleAssignee('${p.id}')">
                        <div class="avatar" style="background: ${p.color}">${p.avatar}</div>
                        <div class="person-info">
                            <div class="person-name">${p.name}</div>
                            <div class="person-email">${p.email}</div>
                        </div>
                        ${isSelected ? '<span style="font-size: 20px;">‚úì</span>' : ''}
                    </div>
                `;
            }).join('');
            
            modal.innerHTML = `
                <div class="modal-content" style="max-width: 400px;">
                    <div class="modal-header">
                        <h2>Selecionar Respons√°veis</h2>
                        <button class="close-btn" onclick="closeAssigneeModal()">√ó</button>
                    </div>
                    <div style="padding: 24px;">
                        <div class="people-list" id="assigneePeopleList">
                            ${peopleList}
                        </div>
                        <div style="margin-top: 20px; display: flex; justify-content: flex-end; gap: 8px;">
                            <button onclick="closeAssigneeModal()" class="btn btn-secondary">Cancelar</button>
                            <button onclick="confirmAssignees()" class="btn">Confirmar</button>
                        </div>
                    </div>
                </div>
            `;
            
            document.body.appendChild(modal);
        }

        function closeAssigneeModal() {
            const modal = document.getElementById('assigneeModal');
            if (modal) modal.remove();
        }

        function toggleAssignee(personId) {
            const index = currentTaskAssignees.findIndex(a => a.id === personId);
            const person = people.find(p => p.id === personId);
            
            if (index >= 0) {
                currentTaskAssignees.splice(index, 1);
            } else {
                currentTaskAssignees.push({
                    id: person.id,
                    name: person.name,
                    email: person.email,
                    avatar: person.avatar,
                    color: person.color
                });
            }
            
            const items = document.querySelectorAll('#assigneePeopleList .person-item');
            items.forEach(item => {
                item.classList.remove('selected');
                const check = item.querySelector('span');
                if (check) check.remove();
            });
            
            currentTaskAssignees.forEach(a => {
                const item = Array.from(items).find(i => i.onclick.toString().includes(a.id));
                if (item) {
                    item.classList.add('selected');
                    item.innerHTML += '<span style="font-size: 20px;">‚úì</span>';
                }
            });
        }

        function confirmAssignees() {
            renderAssigneesInModal();
            closeAssigneeModal();
        }

        function renderAssigneesInModal() {
            const container = document.getElementById('assigneesSelected');
            if (!container) return;
            
            if (currentTaskAssignees.length === 0) {
                container.innerHTML = '<div style="color: var(--text-secondary); font-size: 13px; padding: 8px;">Nenhum respons√°vel selecionado</div>';
            } else {
                container.innerHTML = currentTaskAssignees.map(a => `
                    <div class="assignee-chip">
                        <div class="avatar" style="background: ${a.color}">${a.avatar}</div>
                        <span>${a.name}</span>
                        <button class="assignee-chip-remove" onclick="removeAssigneeFromTask('${a.id}')" type="button">√ó</button>
                    </div>
                `).join('');
            }
        }

        function removeAssigneeFromTask(personId) {
            currentTaskAssignees = currentTaskAssignees.filter(a => a.id !== personId);
            renderAssigneesInModal();
        }

        // ========================================
        // v3.0: HIST√ìRICO DE ALTERA√á√ïES
        // ========================================

        function addHistoryEvent(taskId, action, changes = {}) {
            const task = tasks.find(t => t.id === taskId);
            if (!task) return;
            
            if (!task.history) task.history = [];
            
            const event = {
                id: task.history.length + 1,
                timestamp: new Date().toISOString(),
                user: getCurrentUser(),
                action: action,
                changes: changes
            };
            
            task.history.push(event);
            saveTasks();
        }

        function renderHistory(taskId) {
            const task = tasks.find(t => t.id === taskId);
            if (!task || !task.history || task.history.length === 0) {
                return `
                    <div class="history-empty">
                        <div class="history-empty-icon">üìú</div>
                        <div>Nenhum hist√≥rico ainda</div>
                        <div style="font-size: 12px; color: var(--text-tertiary); margin-top: 4px;">
                            As altera√ß√µes ser√£o registradas automaticamente
                        </div>
                    </div>
                `;
            }
            
            const sortedHistory = [...task.history].sort((a, b) => 
                new Date(b.timestamp) - new Date(a.timestamp)
            );
            
            return sortedHistory.map(event => {
                const icon = getActionIcon(event.action);
                const description = getActionDescription(event);
                const time = formatTimeAgo(event.timestamp);
                
                return `
                    <div class="history-event">
                        <div class="history-icon ${event.action}">${icon}</div>
                        <div class="history-content">
                            <div class="history-user">${event.user}</div>
                            <div class="history-action">${description}</div>
                            ${renderChanges(event.changes)}
                            <div class="history-timestamp">${time}</div>
                        </div>
                    </div>
                `;
            }).join('');
        }

        function getActionIcon(action) {
            const icons = {
                'created': '‚ú®',
                'moved': '‚û°Ô∏è',
                'edited': '‚úèÔ∏è',
                'assignee_added': 'üë§',
                'assignee_removed': 'üë§',
                'priority_changed': '‚ö°',
                'tags_changed': 'üè∑Ô∏è'
            };
            return icons[action] || 'üìù';
        }

        function getActionDescription(event) {
            const descriptions = {
                'created': 'criou a tarefa',
                'moved': `moveu de "${event.changes.from?.column || 'N/A'}" para "${event.changes.to?.column || 'N/A'}"`,
                'edited': 'editou a tarefa',
                'assignee_added': `atribuiu para ${event.changes.assignee}`,
                'assignee_removed': `removeu ${event.changes.assignee}`,
                'priority_changed': `mudou prioridade de ${event.changes.old} para ${event.changes.new}`,
                'tags_changed': 'alterou as tags'
            };
            return descriptions[event.action] || 'fez uma altera√ß√£o';
        }

        function renderChanges(changes) {
            if (!changes || Object.keys(changes).length === 0) return '';
            
            let html = '<div class="history-changes">';
            
            for (const [key, value] of Object.entries(changes)) {
                if (key === 'from' || key === 'to' || key === 'assignee') continue;
                
                if (value.old !== undefined && value.new !== undefined) {
                    html += `<div>‚Ä¢ ${key}: "${value.old}" ‚Üí "${value.new}"</div>`;
                }
            }
            
            html += '</div>';
            return html;
        }

        function formatTimeAgo(timestamp) {
            const now = new Date();
            const then = new Date(timestamp);
            const seconds = Math.floor((now - then) / 1000);
            
            if (seconds < 60) return 'agora mesmo';
            if (seconds < 3600) return `h√° ${Math.floor(seconds / 60)} minuto${Math.floor(seconds / 60) > 1 ? 's' : ''}`;
            if (seconds < 86400) return `h√° ${Math.floor(seconds / 3600)} hora${Math.floor(seconds / 3600) > 1 ? 's' : ''}`;
            if (seconds < 604800) return `h√° ${Math.floor(seconds / 86400)} dia${Math.floor(seconds / 86400) > 1 ? 's' : ''}`;
            if (seconds < 2592000) return `h√° ${Math.floor(seconds / 604800)} semana${Math.floor(seconds / 604800) > 1 ? 's' : ''}`;
            
            return then.toLocaleDateString('pt-BR');
        }

        // ========================================
        // v3.0: INTEGRA√á√ÉO COM TEMPLATES
        // ========================================

        function checkForTemplate() {
            const templateData = localStorage.getItem('taskflow-template-to-apply');
            if (!templateData) return;
            
            const template = JSON.parse(templateData);
            localStorage.removeItem('taskflow-template-to-apply');
            
            setTimeout(() => {
                if (confirm(`‚ú® Aplicar template "${template.name}"?\n\nüìä ${template.columns.length} colunas\nüìù ${template.tasks.length} tarefas\n\nIsso criar√° as colunas e tarefas no seu Kanban.`)) {
                    applyTemplateToKanban(template);
                }
            }, 500);
        }

        function applyTemplateToKanban(template) {
            let columnsCreated = 0;
            let tasksCreated = 0;
            
            template.columns.forEach((colName, index) => {
                const colId = colName.toLowerCase().replace(/\s+/g, '-').replace(/[^a-z0-9-]/g, '');
                if (!columns.find(c => c.id === colId)) {
                    columns.push({
                        id: colId,
                        name: colName,
                        icon: getColumnIcon(index),
                        order: columns.length
                    });
                    columnsCreated++;
                }
            });
            
            template.tasks.forEach(taskTemplate => {
                const colId = taskTemplate.column.toLowerCase().replace(/\s+/g, '-').replace(/[^a-z0-9-]/g, '');
                
                const task = {
                    id: taskIdCounter++,
                    title: taskTemplate.title,
                    description: taskTemplate.description || '',
                    column: colId,
                    swimlane: null,
                    priority: taskTemplate.priority || 'medium',
                    tags: taskTemplate.tags || [],
                    assignees: [],
                    assignee: '',
                    assigneeEmail: '',
                    startDate: '',
                    endDate: '',
                    leadTime: 0,
                    history: [
                        {
                            id: 1,
                            timestamp: new Date().toISOString(),
                            user: 'Sistema',
                            action: 'created',
                            changes: { source: 'template', templateName: template.name }
                        }
                    ],
                    createdAt: new Date().toISOString()
                };
                
                tasks.push(task);
                tasksCreated++;
            });
            
            saveColumns();
            saveTasks();
            
            updateTaskStatusSelect();
            renderBoard();
            renderAllTasks();
            updateStats();
            
            showNotification(`‚úÖ Template "${template.name}" aplicado!\n\nüìä ${columnsCreated} coluna${columnsCreated !== 1 ? 's' : ''} criada${columnsCreated !== 1 ? 's' : ''}\nüìù ${tasksCreated} tarefa${tasksCreated !== 1 ? 's' : ''} criada${tasksCreated !== 1 ? 's' : ''}`);
        }

        function getColumnIcon(index) {
            const icons = ['üìã', 'üìù', '‚ö°', 'üîç', '‚úÖ', 'üéâ', 'üöÄ', '‚è∏Ô∏è'];
            return icons[index % icons.length];
        }

        // ========================================
        // v3.0: MODAL TABS
        // ========================================

        function switchModalTab(tab) {
            currentModalTab = tab;
            
            document.querySelectorAll('.modal-tab').forEach(t => t.classList.remove('active'));
            document.querySelector(`.modal-tab[data-tab="${tab}"]`)?.classList.add('active');
            
            document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
            document.getElementById(`tab-${tab}`)?.classList.add('active');
            
            if (tab === 'history' && editingTaskId) {
                document.getElementById('historyTimeline').innerHTML = renderHistory(editingTaskId);
            }
        }


        function openModal(status = null, swimlaneId = null) {
            editingTaskId = null;
            document.getElementById('modalTitle').textContent = 'Nova Tarefa';
            document.getElementById('taskForm').reset();
            updateTaskStatusSelect();
            
            // v3.0: Reset respons√°veis
            currentTaskAssignees = [];
            renderAssigneesInModal();
            
            if (swimlanesMode && swimlanes.length > 0) {
                document.getElementById('swimlaneSelectGroup').style.display = 'block';
                updateTaskSwimlaneSelect();
                if (swimlaneId) {
                    document.getElementById('taskSwimlane').value = swimlaneId;
                }
            } else {
                document.getElementById('swimlaneSelectGroup').style.display = 'none';
            }
            
            if (status && columns.find(c => c.id === status)) {
                document.getElementById('taskStatus').value = status;
            }
            
            document.getElementById('taskLeadTime').value = '';
            
            // v3.0: Reset para tab details
            currentModalTab = 'details';
            switchModalTab('details');
            
            document.getElementById('taskModal').classList.add('active');
        }

        function closeModal() {
            document.getElementById('taskModal').classList.remove('active');
            editingTaskId = null;
        }

        // Calcular lead time em dias
        function calculateLeadTime(startDate, endDate) {
            if (!startDate || !endDate) return null;
            
            const start = new Date(startDate);
            const end = new Date(endDate);
            
            if (start > end) return 0;
            
            const diffTime = Math.abs(end - start);
            const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
            
            return diffDays;
        }

        // Atualizar campo de lead time
        function updateLeadTimeField() {
            const startDate = document.getElementById('taskStartDate').value;
            const endDate = document.getElementById('taskEndDate').value;
            const leadTime = calculateLeadTime(startDate, endDate);
            
            const leadTimeField = document.getElementById('taskLeadTime');
            if (leadTime !== null) {
                leadTimeField.value = `${leadTime} ${leadTime === 1 ? 'dia' : 'dias'}`;
            } else {
                leadTimeField.value = '';
            }
        }

        // Adicionar listeners para calcular lead time automaticamente
        document.getElementById('taskStartDate').addEventListener('change', updateLeadTimeField);
        document.getElementById('taskEndDate').addEventListener('change', updateLeadTimeField);

        function updateTaskStatusSelect() {
            const select = document.getElementById('taskStatus');
            select.innerHTML = '';
            
            columns.forEach(column => {
                const option = document.createElement('option');
                option.value = column.id;
                option.textContent = column.name;
                select.appendChild(option);
            });
        }

        function saveTask(event) {
            event.preventDefault();
            
            const taskData = {
                title: document.getElementById('taskTitle').value,
                description: document.getElementById('taskDescription').value,
                priority: document.getElementById('taskPriority').value,
                status: document.getElementById('taskStatus').value,
                assignee: document.getElementById('taskAssignee').value,
                assigneeEmail: document.getElementById('taskAssigneeEmail').value,
                startDate: document.getElementById('taskStartDate').value,
                endDate: document.getElementById('taskEndDate').value,
                swimlane: swimlanesMode && swimlanes.length > 0 ? 
                    (document.getElementById('taskSwimlane').value || '') : '',
                tags: document.getElementById('taskTags').value.split(',').map(t => t.trim()).filter(t => t),
                assignees: currentTaskAssignees
            };
            
            taskData.leadTime = calculateLeadTime(taskData.startDate, taskData.endDate);
            
            if (editingTaskId) {
                const task = tasks.find(t => t.id === editingTaskId);
                const changes = {};
                
                if (task.title !== taskData.title) {
                    changes.title = { old: task.title, new: taskData.title };
                }
                if (task.priority !== taskData.priority) {
                    changes.priority = { old: task.priority, new: taskData.priority };
                }
                if (task.description !== taskData.description && taskData.description) {
                    changes.description = { old: task.description, new: taskData.description };
                }
                
                const oldAssignees = task.assignees || [];
                const newAssignees = taskData.assignees;
                
                const added = newAssignees.filter(na => !oldAssignees.some(oa => oa.id === na.id));
                const removed = oldAssignees.filter(oa => !newAssignees.some(na => na.id === oa.id));
                
                Object.assign(task, taskData);
                
                if (Object.keys(changes).length > 0) {
                    addHistoryEvent(editingTaskId, 'edited', changes);
                }
                
                added.forEach(a => {
                    addHistoryEvent(editingTaskId, 'assignee_added', { assignee: a.name });
                });
                
                removed.forEach(a => {
                    addHistoryEvent(editingTaskId, 'assignee_removed', { assignee: a.name });
                });
                
            } else {
                const newTask = {
                    id: taskIdCounter++,
                    ...taskData,
                    history: [
                        {
                            id: 1,
                            timestamp: new Date().toISOString(),
                            user: getCurrentUser(),
                            action: 'created',
                            changes: {}
                        }
                    ],
                    createdAt: new Date().toISOString()
                };
                
                tasks.push(newTask);
            }
            
            saveTasks();
            renderAllTasks();
            updateStats();
            
            const shouldSendNotification = document.getElementById('sendNotification').checked;
            if (shouldSendNotification && taskData.assigneeEmail) {
                const savedTask = editingTaskId ? 
                    tasks.find(t => t.id === editingTaskId) : 
                    tasks[tasks.length - 1];
                sendEmailNotification(savedTask);
            }
            
            closeModal();
        }


        function sendEmailNotification(task) {
            if (!task.assigneeEmail) {
                alert('Email do respons√°vel n√£o cadastrado!');
                return;
            }

            const statusName = columns.find(c => c.id === task.status)?.name || task.status;
            const priorityText = {
                high: 'Alta',
                medium: 'M√©dia',
                low: 'Baixa'
            }[task.priority];

            const subject = `[TaskFlow] Nova Tarefa Atribu√≠da: ${task.title}`;
            
            const body = `Ol√° ${task.assignee || 'Colaborador'},

Voc√™ foi atribu√≠do como respons√°vel pela seguinte tarefa no TaskFlow:

‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ
üìã TAREFA: ${task.title}
ID: TF-${task.id}
‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ

üìù DESCRI√á√ÉO:
${task.description || 'Sem descri√ß√£o'}

‚ö° PRIORIDADE: ${priorityText}
üìä STATUS: ${statusName}
üè∑Ô∏è TAGS: ${task.tags.join(', ') || 'Nenhuma'}
üìÖ DATA DE CRIA√á√ÉO: ${new Date(task.createdAt).toLocaleString('pt-BR')}

‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ

Por favor, acesse o sistema TaskFlow para mais detalhes e atualiza√ß√µes.

Esta √© uma mensagem autom√°tica do sistema TaskFlow.`;

            // Criar link mailto para abrir o Outlook
            const mailtoLink = `mailto:${task.assigneeEmail}?subject=${encodeURIComponent(subject)}&body=${encodeURIComponent(body)}`;
            
            // Abrir o cliente de email padr√£o (Outlook)
            window.location.href = mailtoLink;
        }

        function deleteTask(taskId) {
            if (confirm('Tem certeza que deseja excluir esta tarefa?')) {
                tasks = tasks.filter(t => t.id !== taskId);
                saveTasks();
                renderAllTasks();
                updateStats();
            }
        }

        function editTask(taskId) {
            const task = tasks.find(t => t.id === taskId);
            if (!task) return;

            editingTaskId = taskId;
            document.getElementById('modalTitle').textContent = 'Editar Tarefa';
            document.getElementById('taskTitle').value = task.title;
            document.getElementById('taskDescription').value = task.description;
            document.getElementById('taskPriority').value = task.priority;
            updateTaskStatusSelect();
            document.getElementById('taskStatus').value = task.status;
            document.getElementById('taskAssignee').value = task.assignee || '';
            document.getElementById('taskAssigneeEmail').value = task.assigneeEmail || '';
            document.getElementById('taskStartDate').value = task.startDate || '';
            document.getElementById('taskEndDate').value = task.endDate || '';
            document.getElementById('taskTags').value = task.tags.join(', ');
            document.getElementById('sendNotification').checked = false;
            
            // v3.0: Carregar respons√°veis
            currentTaskAssignees = task.assignees || [];
            renderAssigneesInModal();
            
            if (task.leadTime !== null && task.leadTime !== undefined) {
                document.getElementById('taskLeadTime').value = `${task.leadTime} ${task.leadTime === 1 ? 'dia' : 'dias'}`;
            } else {
                updateLeadTimeField();
            }
            
            if (swimlanesMode && swimlanes.length > 0) {
                document.getElementById('swimlaneSelectGroup').style.display = 'block';
                updateTaskSwimlaneSelect();
                document.getElementById('taskSwimlane').value = task.swimlane || '';
            }
            
            // v3.0: Reset para tab details
            currentModalTab = 'details';
            switchModalTab('details');
            
            document.getElementById('taskModal').classList.add('active');
        }

        function renderAllTasks() {
            if (swimlanesMode) {
                // Render tasks in swimlanes
                swimlanes.forEach(swimlane => {
                    // NOVO: Usar colunas espec√≠ficas da raia OU colunas globais
                    const swimlaneColumns = swimlane.columns && swimlane.columns.length > 0 
                        ? swimlane.columns 
                        : columns;
                    
                    swimlaneColumns.forEach(column => {
                        const containerId = `${swimlane.id}-${column.id}-tasks`;
                        const countId = `${swimlane.id}-${column.id}-count`;
                        const container = document.getElementById(containerId);
                        const countEl = document.getElementById(countId);
                        
                        if (!container) return;
                        
                        container.innerHTML = '';
                        
                        const filteredTasks = tasks.filter(task => {
                            if (task.status !== column.id) return false;
                            // Compara√ß√£o estrita: tarefa deve ter swimlane EXATAMENTE igual ao ID da raia
                            if (task.swimlane !== swimlane.id) return false;
                            // Garantir que n√£o seja null, undefined ou string vazia
                            if (!task.swimlane || task.swimlane === '') return false;
                            if (currentFilter === 'all') return true;
                            return task.priority === currentFilter;
                        });

                        filteredTasks.forEach(task => {
                            const taskElement = createTaskElement(task);
                            container.appendChild(taskElement);
                        });

                        if (countEl) {
                            countEl.textContent = filteredTasks.length;
                        }
                    });
                });
            } else {
                // Normal mode - only show tasks WITHOUT swimlane assignment
                columns.forEach(column => {
                    const container = document.getElementById(`${column.id}-tasks`);
                    if (!container) return;
                    
                    container.innerHTML = '';
                    
                    const filteredTasks = tasks.filter(task => {
                        if (task.status !== column.id) return false;
                        // Only show tasks without swimlane in normal mode
                        if (task.swimlane && task.swimlane !== '') return false;
                        if (currentFilter === 'all') return true;
                        return task.priority === currentFilter;
                    });

                    filteredTasks.forEach(task => {
                        const taskElement = createTaskElement(task);
                        container.appendChild(taskElement);
                    });

                    const countEl = document.getElementById(`${column.id}-count`);
                    if (countEl) {
                        countEl.textContent = filteredTasks.length;
                    }
                });
            }
            
            // Reinitialize drag and drop after rendering
            setupDragAndDrop();
        }

        function createTaskElement(task) {
            const div = document.createElement('div');
            div.className = 'task';
            div.draggable = true;
            div.dataset.taskId = task.id;
            
            const priorityClass = `priority-${task.priority}`;
            const priorityText = {
                high: 'Alta',
                medium: 'M√©dia',
                low: 'Baixa'
            }[task.priority];

            const tagsHtml = task.tags.map(tag => 
                `<span class="task-tag">${tag}</span>`
            ).join('');

            // v3.0: Renderizar avatares de m√∫ltiplos respons√°veis
            const assigneesHtml = renderAssignees(task.assignees);

            const assigneeHtml = task.assignee ? 
                `<div class="task-assignee" title="${task.assignee}${task.assigneeEmail ? ' (' + task.assigneeEmail + ')' : ''}">${task.assignee.substring(0, 2).toUpperCase()}</div>` : '';

            const emailButtonHtml = task.assigneeEmail ? 
                `<button class="task-email-btn" onclick="event.stopPropagation(); sendEmailNotification(tasks.find(t => t.id === ${task.id}))" title="Enviar email para ${task.assignee}">üìß</button>` : '';

            const datesHtml = (task.startDate || task.endDate) ? `
                <div class="task-dates">
                    ${task.startDate ? `<span title="Data de In√≠cio">üìÖ ${formatDateBR(task.startDate)}</span>` : ''}
                    ${task.startDate && task.endDate ? ' ‚Üí ' : ''}
                    ${task.endDate ? `<span title="Data de T√©rmino">üèÅ ${formatDateBR(task.endDate)}</span>` : ''}
                    ${task.leadTime ? `<span class="task-lead-time" title="Lead Time">‚è±Ô∏è ${task.leadTime}d</span>` : ''}
                </div>
            ` : '';

            div.innerHTML = `
                <div class="task-header">
                    <span class="task-id">TF-${task.id}</span>
                    ${assigneesHtml}
                    <span class="task-priority ${priorityClass}">${priorityText}</span>
                </div>
                <div class="task-title">${task.title}</div>
                ${task.description ? `<div class="task-description">${task.description}</div>` : ''}
                ${datesHtml}
                <div class="task-footer">
                    <div class="task-tags">${tagsHtml}</div>
                    <div style="display: flex; align-items: center; gap: 8px;">
                        ${emailButtonHtml}
                        ${assigneeHtml}
                    </div>
                </div>
            `;

            div.addEventListener('click', (e) => {
                if (!e.target.closest('.task-actions')) {
                    editTask(task.id);
                }
            });

            div.addEventListener('contextmenu', (e) => {
                e.preventDefault();
                deleteTask(task.id);
            });

            return div;
        }

        // Formatar data para formato brasileiro
        function formatDateBR(dateString) {
            if (!dateString) return '';
            const date = new Date(dateString + 'T00:00:00');
            return date.toLocaleDateString('pt-BR', { day: '2-digit', month: '2-digit' });
        }

        // Global drag handlers
        let dragHandlersInitialized = false;
        
        function handleDragStart(e) {
            if (e.target.classList.contains('task')) {
                e.target.classList.add('dragging');
                e.dataTransfer.effectAllowed = 'move';
            }
        }
        
        function handleDragEnd(e) {
            if (e.target.classList.contains('task')) {
                e.target.classList.remove('dragging');
            }
        }
        
        function setupDragAndDrop() {
            // Setup global drag handlers only once
            if (!dragHandlersInitialized) {
                document.addEventListener('dragstart', handleDragStart);
                document.addEventListener('dragend', handleDragEnd);
                dragHandlersInitialized = true;
            }
            
            const columnsEl = document.querySelectorAll('.tasks');
            
            columnsEl.forEach(column => {
                // Remove old listeners if any
                const oldDragOver = column._dragOverHandler;
                const oldDragLeave = column._dragLeaveHandler;
                const oldDrop = column._dropHandler;
                
                if (oldDragOver) column.removeEventListener('dragover', oldDragOver);
                if (oldDragLeave) column.removeEventListener('dragleave', oldDragLeave);
                if (oldDrop) column.removeEventListener('drop', oldDrop);
                
                // Create new handlers
                const dragOverHandler = (e) => {
                    e.preventDefault();
                    const columnEl = column.closest('.column');
                    columnEl.classList.add('drag-over');
                    
                    const dragging = document.querySelector('.dragging');
                    if (!dragging) return;
                    
                    const afterElement = getDragAfterElement(column, e.clientY);
                    
                    if (afterElement == null) {
                        column.appendChild(dragging);
                    } else {
                        column.insertBefore(dragging, afterElement);
                    }
                };
                
                const dragLeaveHandler = (e) => {
                    const columnEl = column.closest('.column');
                    if (!columnEl.contains(e.relatedTarget)) {
                        columnEl.classList.remove('drag-over');
                    }
                };
                
                const dropHandler = (e) => {
                    e.preventDefault();
                    const columnEl = column.closest('.column');
                    columnEl.classList.remove('drag-over');
                    
                    const dragging = document.querySelector('.dragging');
                    if (!dragging) return;
                    
                    const taskId = parseInt(dragging.dataset.taskId);
                    const newStatus = columnEl.dataset.status;
                    const swimlaneId = columnEl.dataset.swimlaneId || null;
                    
                    const task = tasks.find(t => t.id === taskId);
                    if (task) {
                        task.status = newStatus;
                        
                        // ‚Üê NOVO: Salvar tipo da coluna separadamente
                        if (swimlanesMode && swimlaneId) {
                            task.swimlane = swimlaneId;
                            
                            // Encontrar a coluna e pegar seu tipo
                            const swimlane = swimlanes.find(s => s.id === swimlaneId);
                            if (swimlane && swimlane.columns) {
                                const column = swimlane.columns.find(c => c.id === newStatus);
                                if (column && column.type) {
                                    task.columnType = column.type; // doing, done, todo
                                }
                            }
                        } else {
                            // Modo normal: status j√° √© o tipo correto
                            task.columnType = newStatus;
                        }
                        
                        saveTasks();
                        renderAllTasks();
                        updateStats();
                    }
                };
                
                // Store handlers for future removal
                column._dragOverHandler = dragOverHandler;
                column._dragLeaveHandler = dragLeaveHandler;
                column._dropHandler = dropHandler;
                
                // Add new listeners
                column.addEventListener('dragover', dragOverHandler);
                column.addEventListener('dragleave', dragLeaveHandler);
                column.addEventListener('drop', dropHandler);
            });
        }

        function getDragAfterElement(container, y) {
            const draggableElements = [...container.querySelectorAll('.task:not(.dragging)')];
            
            return draggableElements.reduce((closest, child) => {
                const box = child.getBoundingClientRect();
                const offset = y - box.top - box.height / 2;
                
                if (offset < 0 && offset > closest.offset) {
                    return { offset: offset, element: child };
                } else {
                    return closest;
                }
            }, { offset: Number.NEGATIVE_INFINITY }).element;
        }

        function filterTasks(searchTerm) {
            const allTasks = document.querySelectorAll('.task');
            allTasks.forEach(taskEl => {
                const taskId = parseInt(taskEl.dataset.taskId);
                const task = tasks.find(t => t.id === taskId);
                
                if (task) {
                    const searchableText = `${task.title} ${task.description} ${task.tags.join(' ')}`.toLowerCase();
                    const matches = searchableText.includes(searchTerm);
                    taskEl.style.display = matches ? 'block' : 'none';
                }
            });
        }

        function updateStats() {
            // Filter tasks based on current mode
            let modeTasks;
            if (swimlanesMode) {
                // Swimlane mode: only tasks WITH swimlane
                modeTasks = tasks.filter(t => t.swimlane && t.swimlane !== '');
            } else {
                // Normal mode: only tasks WITHOUT swimlane
                modeTasks = tasks.filter(t => !t.swimlane || t.swimlane === '');
            }
            
            const total = modeTasks.length;
            
            // Count tasks by checking column names (independent of column IDs)
            // This works even if task status IDs don't match current mode columns
            const inProgress = modeTasks.filter(t => {
                // Try to find column in current mode
                const column = columns.find(c => c.id === t.status);
                if (column) {
                    return column.name.toLowerCase().includes('progresso') ||
                           column.name.toLowerCase().includes('progress') ||
                           column.name.toLowerCase().includes('doing') ||
                           column.name.toLowerCase().includes('andamento');
                }
                // If not found in current mode, ignore
                return false;
            }).length;
            
            const completed = modeTasks.filter(t => {
                // Try to find column in current mode
                const column = columns.find(c => c.id === t.status);
                if (column) {
                    return column.name.toLowerCase().includes('conclu√≠') || 
                           column.name.toLowerCase().includes('done') ||
                           column.name.toLowerCase().includes('finaliza') ||
                           column.name.toLowerCase().includes('completo');
                }
                // If not found in current mode, ignore
                return false;
            }).length;
            
            const completionRate = total > 0 ? Math.round((completed / total) * 100) : 0;

            

            const totalEl = document.getElementById('totalTasks');
            const inProgressEl = document.getElementById('inProgressTasks');
            const completedEl = document.getElementById('completedTasks');
            const rateEl = document.getElementById('completionRate');
            
            if (totalEl) totalEl.textContent = total;
            if (inProgressEl) inProgressEl.textContent = inProgress;
            if (completedEl) completedEl.textContent = completed;
            if (rateEl) rateEl.textContent = `${completionRate}%`;
        }

        function saveTasks() {
            localStorage.setItem('kanban-tasks', JSON.stringify(tasks));
        }

        function saveColumns() {
            if (swimlanesMode) {
                swimlaneColumns = [...columns];
                localStorage.setItem('kanban-swimlane-columns', JSON.stringify(swimlaneColumns));
            } else {
                normalColumns = [...columns];
                localStorage.setItem('kanban-normal-columns', JSON.stringify(normalColumns));
            }
        }

        function saveSwimlanes() {
            localStorage.setItem('kanban-swimlanes', JSON.stringify(swimlanes));
        }

        // FUN√á√ÉO DESATIVADA POR SEGURAN√áA (evitar perda acidental de dados)
        // Usu√°rios podem usar Sistema de Backup para gerenciar dados
        /*
        function clearAllTasks() {
            if (confirm('Tem certeza que deseja limpar todas as tarefas? Esta a√ß√£o n√£o pode ser desfeita.')) {
                tasks = [];
                taskIdCounter = 1;
                saveTasks();
                renderAllTasks();
                updateStats();
            }
        }
        */

        // Exportar dados para CSV
        function exportToExcel() {
            if (tasks.length === 0) {
                alert('N√£o h√° tarefas para exportar!');
                return;
            }

            // Preparar dados no formato do modelo de importa√ß√£o
            const excelData = tasks.map(task => {
                // Calcular lead time se tiver datas
                let leadTime = 0;
                if (task.startDate && task.endDate) {
                    const start = new Date(task.startDate);
                    const end = new Date(task.endDate);
                    leadTime = Math.floor((end - start) / (1000 * 60 * 60 * 24));
                }
                
                return {
                    'id': task.id,
                    'title': task.title || '',
                    'description': task.description || `Lead time: ${leadTime} dias`,
                    'priority': task.priority || 'medium',
                    'status': task.status || 'a-fazer',
                    'startDate': task.startDate || '',
                    'endDate': task.endDate || '',
                    'assignedTo': task.assignee || '',
                    'tags': task.tags ? task.tags.join(',') : '',
                    'progress': task.progress || 0
                };
            });

            // Criar workbook e worksheet
            const ws = XLSX.utils.json_to_sheet(excelData);
            
            // Ajustar largura das colunas
            const colWidths = [
                { wch: 5 },   // id
                { wch: 40 },  // title
                { wch: 50 },  // description
                { wch: 10 },  // priority
                { wch: 15 },  // status
                { wch: 12 },  // startDate
                { wch: 12 },  // endDate
                { wch: 20 },  // assignedTo
                { wch: 30 },  // tags
                { wch: 10 }   // progress
            ];
            ws['!cols'] = colWidths;

            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, 'Tarefas');

            // Gerar nome do arquivo
            const now = new Date();
            const fileName = `TaskFlow_Export_${now.getFullYear()}${String(now.getMonth() + 1).padStart(2, '0')}${String(now.getDate()).padStart(2, '0')}_${String(now.getHours()).padStart(2, '0')}${String(now.getMinutes()).padStart(2, '0')}.xlsx`;

            // Download do arquivo
            XLSX.writeFile(wb, fileName);

            // Mostrar mensagem de sucesso
            alert(`‚úÖ Exporta√ß√£o conclu√≠da!\n\n${tasks.length} tarefa(s) exportada(s).\n\nArquivo: ${fileName}`);
        }

        // Vari√°vel global para armazenar dados da importa√ß√£o
        let pendingImportData = null;

        // Importar dados do Excel
        // Abrir modal de sele√ß√£o de raia
        function openImportSwimlaneModal() {
            if (!pendingImportData) return;
            
            // Atualizar contador de tarefas
            document.getElementById('importTaskCount').textContent = pendingImportData.length;
            
            // Preencher select de raias
            const select = document.getElementById('importSwimlaneSelect');
            select.innerHTML = '';
            
            if (swimlanes.length > 0) {
                swimlanes.forEach(swimlane => {
                    const option = document.createElement('option');
                    option.value = swimlane.id;
                    option.textContent = `${swimlane.icon} ${swimlane.name}`;
                    select.appendChild(option);
                });
            } else {
                const option = document.createElement('option');
                option.value = '';
                option.textContent = 'Nenhuma raia dispon√≠vel';
                select.appendChild(option);
            }
            
            // Resetar para modo normal
            document.querySelector('input[name="importMode"][value="normal"]').checked = true;
            updateImportModeDisplay();
            
            // Mostrar modal
            document.getElementById('importSwimlaneModal').classList.add('active');
        }

        // Fechar modal de sele√ß√£o de raia
        function closeImportSwimlaneModal() {
            document.getElementById('importSwimlaneModal').classList.remove('active');
            pendingImportData = null;
        }

        // Atualizar display do modo de importa√ß√£o
        function updateImportModeDisplay() {
            const mode = document.querySelector('input[name="importMode"]:checked').value;
            const swimlaneContainer = document.getElementById('swimlaneSelectContainer');
            
            if (mode === 'swimlane') {
                swimlaneContainer.style.display = 'block';
            } else {
                swimlaneContainer.style.display = 'none';
            }
        }

        // Confirmar e processar importa√ß√£o
        function confirmImport() {
            if (!pendingImportData) return;
            
            const mode = document.querySelector('input[name="importMode"]:checked').value;
            const selectedSwimlane = mode === 'swimlane' ? document.getElementById('importSwimlaneSelect').value : null;
            
            // Verificar se raia foi selecionada quando modo raia est√° ativo
            if (mode === 'swimlane' && (!selectedSwimlane || selectedSwimlane === '')) {
                alert('‚ö†Ô∏è Por favor, selecione uma raia!');
                return;
            }
            
            // Confirmar importa√ß√£o
            const confirmMsg = tasks.length > 0 
                ? `üì• Importar ${pendingImportData.length} tarefa(s)\n\n‚úÖ Existentes: ${tasks.length} tarefa(s)\n‚úÖ Novas: ${pendingImportData.length} tarefa(s)\n${mode === 'swimlane' ? `‚úÖ Destino: Raia "${swimlanes.find(s => s.id === selectedSwimlane)?.name}"\n` : '‚úÖ Destino: Modo Normal\n'}\n‚úÖ Total ap√≥s: ${tasks.length + pendingImportData.length} tarefas\n\nDeseja continuar?`
                : `üì• Importar ${pendingImportData.length} tarefa(s) do Excel?`;
            
            if (!confirm(confirmMsg)) {
                return;
            }
            
            // Processar importa√ß√£o
            processImport(pendingImportData, selectedSwimlane);
            
            // Fechar modal
            closeImportSwimlaneModal();
        }

        // Processar importa√ß√£o
        function processImport(jsonData, swimlaneId) {
            // Pegar maior ID existente para n√£o haver conflitos
            let maxId = taskIdCounter - 1;
            tasks.forEach(task => {
                if (task.id > maxId) maxId = task.id;
            });

            // Processar novas tarefas
            const newTasks = [];
            const existingIds = new Set(tasks.map(t => t.id));

            jsonData.forEach((row, index) => {
                // Calcular lead time se n√£o tiver
                let leadTime = 0;
                if (row.startDate && row.endDate) {
                    const start = new Date(row.startDate);
                    const end = new Date(row.endDate);
                    if (!isNaN(start) && !isNaN(end)) {
                        leadTime = Math.floor((end - start) / (1000 * 60 * 60 * 24));
                    }
                }

                // Determinar ID da tarefa
                let taskId;
                if (row.id && !isNaN(parseInt(row.id))) {
                    // Se ID foi fornecido e n√£o existe, usa ele
                    const providedId = parseInt(row.id);
                    if (!existingIds.has(providedId)) {
                        taskId = providedId;
                        existingIds.add(providedId);
                    } else {
                        // ID j√° existe, gera um novo
                        maxId++;
                        taskId = maxId;
                        existingIds.add(taskId);
                    }
                } else {
                    // ID n√£o fornecido ou inv√°lido, gera automaticamente
                    maxId++;
                    taskId = maxId;
                    existingIds.add(taskId);
                }

                const task = {
                    id: taskId,
                    title: row.title || 'Sem t√≠tulo',
                    description: row.description || '',
                    priority: row.priority || 'medium',
                    status: row.status || columns[0]?.id || 'a-fazer',
                    assignee: row.assignedTo || '',
                    assigneeEmail: '',
                    swimlane: swimlaneId || null, // Usar raia selecionada ou null
                    tags: row.tags ? row.tags.split(',').map(t => t.trim()).filter(t => t) : [],
                    createdAt: new Date().toISOString(),
                    startDate: row.startDate || '',
                    endDate: row.endDate || '',
                    leadTime: leadTime,
                    progress: parseInt(row.progress) || 0
                };

                newTasks.push(task);
            });

            // ADICIONAR novas tarefas √†s existentes (N√ÉO SUBSTITUIR)
            tasks = [...tasks, ...newTasks];
            taskIdCounter = maxId + 1;
            saveTasks();
            renderAllTasks();
            updateStats();

            const swimlaneName = swimlaneId ? swimlanes.find(s => s.id === swimlaneId)?.name : 'Modo Normal';
            alert(`‚úÖ Importa√ß√£o conclu√≠da!\n\nüì• ${newTasks.length} tarefa(s) ADICIONADA(s)\nüèä Destino: ${swimlaneName}\nüìä Total agora: ${tasks.length} tarefas`);
        }

        // Fun√ß√£o separada para importa√ß√£o do Excel
        function importFromExcel(event) {
            const file = event.target.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    // Ler arquivo Excel
                    const data = new Uint8Array(e.target.result);
                    const workbook = XLSX.read(data, { type: 'array' });
                    
                    // Pegar primeira sheet
                    const firstSheet = workbook.Sheets[workbook.SheetNames[0]];
                    
                    // Converter para JSON
                    const jsonData = XLSX.utils.sheet_to_json(firstSheet);
                    
                    if (jsonData.length === 0) {
                        alert('‚ùå Arquivo Excel vazio ou inv√°lido!');
                        return;
                    }

                    // Armazenar dados para importa√ß√£o
                    pendingImportData = jsonData;
                    
                    // Abrir modal de sele√ß√£o de raia
                    openImportSwimlaneModal();
                    
                } catch (error) {
                    console.error('Erro ao importar Excel:', error);
                    alert('‚ùå Erro ao importar arquivo Excel!\n\nVerifique se o arquivo est√° no formato correto.');
                }
                
                // Limpar input
                event.target.value = '';
            };

            reader.readAsArrayBuffer(file);
        }


        // Formatar data do MS Project (ISO) para YYYY-MM-DD
        function formatProjectDate(dateString) {
            try {
                const date = new Date(dateString);
                return date.toISOString().split('T')[0];
            } catch {
                return '';
            }
        }

        // Exportar para MS Project XML
        function exportToProjectXML() {
            if (tasks.length === 0) {
                alert('N√£o h√° tarefas para exportar!');
                return;
            }

            // Criar XML do MS Project
            const xml = generateProjectXML(tasks);

            // Criar blob e fazer download
            const blob = new Blob([xml], { type: 'text/xml;charset=utf-8;' });
            const link = document.createElement('a');
            const url = URL.createObjectURL(blob);
            
            const now = new Date();
            const fileName = `taskflow_project_${now.getFullYear()}${String(now.getMonth() + 1).padStart(2, '0')}${String(now.getDate()).padStart(2, '0')}.xml`;
            
            link.setAttribute('href', url);
            link.setAttribute('download', fileName);
            link.style.visibility = 'hidden';
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);

            alert(`‚úÖ Exporta√ß√£o para MS Project conclu√≠da!\n\n${tasks.length} tarefa(s) exportada(s).\n\nArquivo: ${fileName}\n\nVoc√™ pode abrir este arquivo no Microsoft Project.`);
        }

        // Gerar XML do MS Project
        function generateProjectXML(tasks) {
            const projectName = 'TaskFlow Project';
            const today = new Date().toISOString();

            let xml = `<?xml version="1.0" encoding="UTF-8"?>
<Project xmlns="http://schemas.microsoft.com/project">
    <Name>${escapeXml(projectName)}</Name>
    <Title>${escapeXml(projectName)}</Title>
    <CreationDate>${today}</CreationDate>
    <LastSaved>${today}</LastSaved>
    <ScheduleFromStart>1</ScheduleFromStart>
    <StartDate>${today}</StartDate>
    <CurrencySymbol>R$</CurrencySymbol>
    <Tasks>`;

            tasks.forEach((task, index) => {
                // Mapear prioridade TaskFlow para MS Project (0-1000)
                const priorityMap = {
                    'high': 800,
                    'medium': 500,
                    'low': 200
                };
                const priority = priorityMap[task.priority] || 500;

                // Mapear status para percentual de conclus√£o
                const percentMap = {
                    'backlog': 0,
                    'a-fazer': 0,
                    'em-progresso': 50,
                    'concluido': 100
                };
                const percent = percentMap[task.status] || 0;

                // Datas
                const startDate = task.startDate ? new Date(task.startDate).toISOString() : today;
                const finishDate = task.endDate ? new Date(task.endDate).toISOString() : today;

                xml += `
        <Task>
            <UID>${task.id}</UID>
            <ID>${task.id}</ID>
            <Name>${escapeXml(task.title)}</Name>
            <Type>0</Type>
            <IsNull>0</IsNull>
            <CreateDate>${task.createdAt || today}</CreateDate>
            <WBS>${task.id}</WBS>
            <OutlineNumber>${task.id}</OutlineNumber>
            <OutlineLevel>1</OutlineLevel>
            <Priority>${priority}</Priority>
            <Start>${startDate}</Start>
            <Finish>${finishDate}</Finish>
            <PercentComplete>${percent}</PercentComplete>
            <PercentWorkComplete>${percent}</PercentWorkComplete>
            <Notes>${escapeXml(task.description || '')}</Notes>
            <ResourceNames>${escapeXml(task.assignee || '')}</ResourceNames>
            <Active>1</Active>
            <Manual>0</Manual>
            <Summary>0</Summary>
        </Task>`;
            });

            xml += `
    </Tasks>
</Project>`;

            return xml;
        }

        // Escapar caracteres especiais para XML
        function escapeXml(unsafe) {
            if (!unsafe) return '';
            return String(unsafe)
                .replace(/&/g, '&amp;')
                .replace(/</g, '&lt;')
                .replace(/>/g, '&gt;')
                .replace(/"/g, '&quot;')
                .replace(/'/g, '&apos;');
        }

        // Importar dados do MS Project
        function importFromProject(event) {
            const file = event.target.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const content = e.target.result;
                    
                    // Verificar se √© XML do MS Project
                    if (!content.includes('<Project') && !content.includes('xmlns')) {
                        alert('‚ùå Este arquivo n√£o parece ser um XML v√°lido do MS Project!\n\nPara exportar do MS Project:\n1. Arquivo ‚Üí Salvar Como\n2. Escolha "XML" como formato\n3. Salve e importe aqui');
                        event.target.value = '';
                        return;
                    }

                    const parser = new DOMParser();
                    const xmlDoc = parser.parseFromString(content, 'text/xml');

                    // Verificar erros de parsing
                    const parserError = xmlDoc.querySelector('parsererror');
                    if (parserError) {
                        alert('‚ùå Erro ao ler arquivo XML!\n\nVerifique se o arquivo n√£o est√° corrompido.');
                        event.target.value = '';
                        return;
                    }

                    // Extrair tarefas do XML
                    const xmlTasks = xmlDoc.querySelectorAll('Task');
                    
                    if (xmlTasks.length === 0) {
                        alert('‚ùå Nenhuma tarefa encontrada no arquivo!\n\nVerifique se exportou as tarefas corretamente do MS Project.');
                        event.target.value = '';
                        return;
                    }

                    // Parsear tarefas para formato compat√≠vel
                    const parsedTasks = [];

                    xmlTasks.forEach((taskNode, index) => {
                        // Extrair dados do XML
                        const uid = getXMLValue(taskNode, 'UID');
                        const name = getXMLValue(taskNode, 'Name');
                        const notes = getXMLValue(taskNode, 'Notes');
                        const priority = getXMLValue(taskNode, 'Priority');
                        const percentComplete = getXMLValue(taskNode, 'PercentComplete');
                        const start = getXMLValue(taskNode, 'Start');
                        const finish = getXMLValue(taskNode, 'Finish');
                        const resourceNames = getXMLValue(taskNode, 'ResourceNames');

                        if (!name || name.trim() === '') return; // Pular tarefas sem nome

                        // Mapear prioridade
                        let taskPriority = 'medium';
                        const msPriority = parseInt(priority) || 500;
                        if (msPriority >= 700) taskPriority = 'high';
                        else if (msPriority <= 300) taskPriority = 'low';

                        // Mapear status
                        let taskStatus = 'backlog';
                        const completion = parseInt(percentComplete) || 0;
                        if (completion === 100) taskStatus = 'concluido';
                        else if (completion > 0) taskStatus = 'em-progresso';
                        else if (start) taskStatus = 'a-fazer';

                        // Processar datas
                        const startDate = start ? formatProjectDate(start) : '';
                        const endDate = finish ? formatProjectDate(finish) : '';

                        // Criar objeto compat√≠vel com processImport
                        parsedTasks.push({
                            title: name.substring(0, 100),
                            description: notes || '',
                            priority: taskPriority,
                            status: taskStatus,
                            assignedTo: resourceNames || '',
                            startDate: startDate,
                            endDate: endDate,
                            progress: completion,
                            tags: ''
                        });
                    });

                    if (parsedTasks.length === 0) {
                        alert('‚ùå Nenhuma tarefa v√°lida foi encontrada no arquivo!');
                        event.target.value = '';
                        return;
                    }

                    // Usar o mesmo fluxo do Excel: armazenar dados e abrir modal
                    pendingImportData = parsedTasks;
                    openImportSwimlaneModal();
                    
                } catch (error) {
                    console.error('Erro ao importar MS Project:', error);
                    alert(`‚ùå Erro ao importar arquivo do MS Project!\n\nDetalhes: ${error.message}\n\nVerifique se o arquivo est√° no formato XML correto.`);
                }
                
                event.target.value = '';
            };

            reader.readAsText(file, 'UTF-8');
        }

        // Obter valor de um elemento XML
        function getXMLValue(node, tagName) {
            const element = node.querySelector(tagName);
            return element ? element.textContent.trim() : '';
        }

        // Formatar data do MS Project para formato TaskFlow
        function formatProjectDate(dateString) {
            if (!dateString) return '';
            
            try {
                // MS Project usa formato ISO: 2024-12-25T00:00:00
                const date = new Date(dateString);
                if (isNaN(date.getTime())) return '';
                
                const year = date.getFullYear();
                const month = String(date.getMonth() + 1).padStart(2, '0');
                const day = String(date.getDate()).padStart(2, '0');
                
                return `${year}-${month}-${day}`;
            } catch (e) {
                return '';
            }
        }

        // Close modals on Escape key
        document.addEventListener('keydown', (e) => {
            if (e.key === 'Escape') {
                closeModal();
                closeColumnModal();
                closeSwimlaneModal();
            }
        });

        // Close modals on outside click
        document.getElementById('taskModal').addEventListener('click', (e) => {
            if (e.target.id === 'taskModal') {
                closeModal();
            }
        });

        document.getElementById('columnModal').addEventListener('click', (e) => {
            if (e.target.id === 'columnModal') {
                closeColumnModal();
            }
        });

        document.getElementById('swimlaneModal').addEventListener('click', (e) => {
            if (e.target.id === 'swimlaneModal') {
                closeSwimlaneModal();
            }
        });

        // Update reminders badge
        function updateRemindersBadge() {
            const count = localStorage.getItem('taskflow-reminders-today-count') || '0';
            const badge = document.getElementById('remindersBadge');
            const btn = document.getElementById('remindersBtn');
            
            if (parseInt(count) > 0) {
                badge.textContent = count;
                badge.style.display = 'block';
                btn.style.animation = 'pulse 2s infinite';
            } else {
                badge.style.display = 'none';
                btn.style.animation = 'none';
            }
        }

        // Update badge on load and periodically
        updateRemindersBadge();
        setInterval(updateRemindersBadge, 5000); // Check every 5 seconds

        // Listen for storage changes (when reminders page updates)
        window.addEventListener('storage', function(e) {
            if (e.key === 'taskflow-reminders-today-count') {
                updateRemindersBadge();
            }
        });

        // v3.0: Notifica√ß√£o melhorada
        function showNotification(message) {
            const notification = document.createElement('div');
            notification.style.cssText = `
                position: fixed;
                top: 80px;
                right: 20px;
                background: var(--accent-green);
                color: white;
                padding: 16px 24px;
                border-radius: 8px;
                box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
                z-index: 10000;
                font-weight: 600;
                font-size: 14px;
                max-width: 400px;
                white-space: pre-line;
                animation: slideIn 0.3s ease;
            `;
            notification.textContent = message;
            document.body.appendChild(notification);
            
            setTimeout(() => {
                notification.style.animation = 'slideOut 0.3s ease';
                setTimeout(() => {
                    if (notification.parentNode) {
                        document.body.removeChild(notification);
                    }
                }, 300);
            }, 4000);
        }

// ========================================
// FASE 5: UX/UI AVAN√áADO v3.0
// ========================================

// ========================================
// 1. TEMAS CUSTOMIZ√ÅVEIS
// ========================================

let customThemes = {
    'default-dark': {
        name: 'Escuro Padr√£o',
        colors: {
            'bg-primary': '#1c2128',
            'bg-secondary': '#22272b',
            'bg-hover': '#2c333a',
            'accent-blue': '#579dff',
            'accent-green': '#4bce97',
            'accent-red': '#f87462'
        }
    },
    'default-light': {
        name: 'Claro Padr√£o',
        colors: {
            'bg-primary': '#ffffff',
            'bg-secondary': '#f7f8f9',
            'bg-hover': '#ebecf0',
            'accent-blue': '#0052cc',
            'accent-green': '#00875a',
            'accent-red': '#de350b'
        }
    },
    'ocean': {
        name: 'Ocean Blue',
        colors: {
            'bg-primary': '#0a1929',
            'bg-secondary': '#132f4c',
            'bg-hover': '#1e4976',
            'accent-blue': '#3399ff',
            'accent-green': '#66d9ef',
            'accent-red': '#ff6b9d'
        }
    },
    'forest': {
        name: 'Forest Green',
        colors: {
            'bg-primary': '#1a2421',
            'bg-secondary': '#243831',
            'bg-hover': '#2d4a3e',
            'accent-blue': '#4ecca3',
            'accent-green': '#5efc8d',
            'accent-red': '#ff6b81'
        }
    },
    'sunset': {
        name: 'Sunset Orange',
        colors: {
            'bg-primary': '#2d1b1b',
            'bg-secondary': '#3d2929',
            'bg-hover': '#4d3737',
            'accent-blue': '#ffa726',
            'accent-green': '#ffcc80',
            'accent-red': '#ff6f00'
        }
    },
    'purple-haze': {
        name: 'Purple Haze',
        colors: {
            'bg-primary': '#1a1625',
            'bg-secondary': '#2a2438',
            'bg-hover': '#3a324b',
            'accent-blue': '#9c88ff',
            'accent-green': '#b794f6',
            'accent-red': '#f093fb'
        }
    }
};

let currentThemeId = 'default-dark';

function loadCustomThemes() {
    const saved = localStorage.getItem('taskflow-custom-themes');
    if (saved) {
        const userThemes = JSON.parse(saved);
        customThemes = { ...customThemes, ...userThemes };
    }
    
    const currentId = localStorage.getItem('taskflow-current-theme');
    if (currentId && customThemes[currentId]) {
        currentThemeId = currentId;
        applyTheme(currentId);
    }
}

function applyTheme(themeId) {
    const theme = customThemes[themeId];
    if (!theme) return;
    
    currentThemeId = themeId;
    const root = document.documentElement;
    
    Object.entries(theme.colors).forEach(([key, value]) => {
        root.style.setProperty(`--${key}`, value);
    });
    
    localStorage.setItem('taskflow-current-theme', themeId);
}

function openThemeEditor() {
    console.log('üé® openThemeEditor() chamado');
    console.log('customThemes:', customThemes);
    console.log('currentThemeId:', currentThemeId);
    
    const modal = document.createElement('div');
    modal.className = 'modal active';
    modal.id = 'themeEditorModal';
    
    console.log('Modal temas criado');
    
    const themesList = Object.entries(customThemes).map(([id, theme]) => `
        <div class="theme-preset ${currentThemeId === id ? 'active' : ''}" onclick="applyTheme('${id}')">
            <div class="theme-preview">
                ${Object.entries(theme.colors).slice(0, 6).map(([key, color]) => 
                    `<div class="color-dot" style="background: ${color}"></div>`
                ).join('')}
            </div>
            <div class="theme-name">${theme.name}</div>
            ${currentThemeId === id ? '<span class="theme-active-badge">‚úì Ativo</span>' : ''}
        </div>
    `).join('');
    
    console.log('Lista de temas gerada');
    
    modal.innerHTML = `
        <div class="modal-content" style="max-width: 700px;">
            <div class="modal-header">
                <h2>üé® Editor de Temas</h2>
                <button class="close-btn" onclick="closeThemeEditor()">√ó</button>
            </div>
            <div class="modal-body">
                <h3 style="margin-bottom: 16px;">Temas Pr√©-definidos</h3>
                <div class="themes-grid">
                    ${themesList}
                </div>
                
                <div style="margin-top: 32px;">
                    <h3 style="margin-bottom: 16px;">Criar Tema Personalizado</h3>
                    <button onclick="createCustomTheme()" class="btn btn-primary" style="width: 100%;">
                        ‚ûï Criar Novo Tema
                    </button>
                </div>
            </div>
        </div>
    `;
    
    document.body.appendChild(modal);
    console.log('‚úÖ Modal de temas adicionado ao DOM');
}

function closeThemeEditor() {
    const modal = document.getElementById('themeEditorModal');
    if (modal) modal.remove();
}

function createCustomTheme() {
    const name = prompt('Nome do tema personalizado:');
    if (!name) return;
    
    const id = name.toLowerCase().replace(/\s+/g, '-');
    
    customThemes[id] = {
        name: name,
        colors: { ...customThemes['default-dark'].colors }
    };
    
    localStorage.setItem('taskflow-custom-themes', JSON.stringify(
        Object.fromEntries(
            Object.entries(customThemes).filter(([key]) => 
                !['default-dark', 'default-light', 'ocean', 'forest', 'sunset', 'purple-haze'].includes(key)
            )
        )
    ));
    
    closeThemeEditor();
    openThemeEditor();
    showNotification(`‚úÖ Tema "${name}" criado!`);
}

// ========================================
// 2. ATALHOS DE TECLADO
// ========================================

let shortcuts = {
    'ctrl+k': { action: openCommandPalette, description: 'Abrir paleta de comandos' },
    'ctrl+n': { action: () => openModal(), description: 'Nova tarefa' },
    'ctrl+/': { action: showShortcutsHelp, description: 'Mostrar atalhos' },
    'ctrl+f': { action: focusSearch, description: 'Buscar tarefas' },
    'ctrl+b': { action: toggleSidebar, description: 'Toggle sidebar' },
    'ctrl+shift+d': { action: () => window.open('dashboard.html'), description: 'Abrir dashboard' },
    'ctrl+shift+r': { action: () => window.open('lembretes.html'), description: 'Abrir lembretes' },
    'ctrl+shift+t': { action: () => window.open('templates.html'), description: 'Abrir templates' },
    'esc': { action: closeAllModals, description: 'Fechar modais' }
};

function initializeKeyboardShortcuts() {
    document.addEventListener('keydown', (e) => {
        const key = [];
        if (e.ctrlKey || e.metaKey) key.push('ctrl');
        if (e.shiftKey) key.push('shift');
        if (e.altKey) key.push('alt');
        key.push(e.key.toLowerCase());
        
        const shortcut = key.join('+');
        
        if (shortcuts[shortcut]) {
            // N√£o interceptar se estiver em input
            if (e.target.tagName === 'INPUT' || e.target.tagName === 'TEXTAREA') {
                if (shortcut !== 'esc') return;
            }
            
            e.preventDefault();
            shortcuts[shortcut].action();
        }
    });
}

function openCommandPalette() {
    console.log('‚å®Ô∏è openCommandPalette() chamado');
    
    const modal = document.createElement('div');
    modal.className = 'modal active';
    modal.id = 'commandPaletteModal';
    
    console.log('Modal comandos criado');
    
    modal.innerHTML = `
        <div class="command-palette">
            <div class="command-search">
                <input type="text" id="commandSearch" placeholder="Digite um comando..." autofocus>
                <button onclick="closeCommandPalette()" style="position: absolute; top: 16px; right: 16px; background: none; border: none; color: var(--text-secondary); font-size: 24px; cursor: pointer; padding: 4px 8px; line-height: 1;" title="Fechar (Esc)">√ó</button>
            </div>
            <div class="command-results" id="commandResults">
                ${renderCommandResults('')}
            </div>
        </div>
    `;
    
    document.body.appendChild(modal);
    console.log('‚úÖ Modal comandos adicionado ao DOM');
    
    // Attach listeners to command items
    attachCommandListeners();
    
    const searchInput = document.getElementById('commandSearch');
    searchInput.addEventListener('input', (e) => {
        document.getElementById('commandResults').innerHTML = renderCommandResults(e.target.value);
        attachCommandListeners(); // Re-attach after re-render
    });
    
    searchInput.addEventListener('keydown', (e) => {
        if (e.key === 'Escape') {
            closeCommandPalette();
        }
    });
}

function renderCommandResults(query) {
    console.log('üîç renderCommandResults chamado com query:', query);
    
    const commands = [
        { name: 'Nova Tarefa', icon: '‚ûï', id: 'cmd-new-task' },
        { name: 'Abrir Dashboard', icon: 'üìä', id: 'cmd-dashboard' },
        { name: 'Abrir Lembretes', icon: 'üîî', id: 'cmd-lembretes' },
        { name: 'Abrir Templates', icon: 'üìã', id: 'cmd-templates' },
        { name: 'Abrir Integra√ß√µes', icon: 'üîó', id: 'cmd-integracoes' },
        { name: 'Editor de Temas', icon: 'üé®', id: 'cmd-temas' },
        { name: 'Atalhos de Teclado', icon: '‚å®Ô∏è', id: 'cmd-atalhos' },
        { name: 'Alternar Densidade', icon: 'üìè', id: 'cmd-densidade' },
        { name: 'Gerenciar Pessoas', icon: 'üë•', id: 'cmd-pessoas' },
        { name: 'Exportar Dados', icon: 'üì•', id: 'cmd-export' }
    ];
    
    const filtered = commands.filter(cmd => 
        cmd.name.toLowerCase().includes(query.toLowerCase())
    );
    
    console.log('Comandos filtrados:', filtered.length);
    
    if (filtered.length === 0) {
        return '<div class="command-empty">Nenhum comando encontrado</div>';
    }
    
    return filtered.map((cmd, index) => `
        <div class="command-item" data-command="${cmd.id}">
            <span class="command-icon">${cmd.icon}</span>
            <span class="command-name">${cmd.name}</span>
        </div>
    `).join('');
}

function attachCommandListeners() {
    console.log('üìé attachCommandListeners() chamado');
    const items = document.querySelectorAll('.command-item');
    console.log('Itens de comando encontrados:', items.length);
    
    items.forEach(item => {
        item.addEventListener('click', function() {
            const commandId = this.getAttribute('data-command');
            console.log('üñ±Ô∏è Comando clicado:', commandId);
            executeCommand(commandId);
        });
    });
    
    console.log('‚úÖ Listeners anexados');
}

function executeCommand(commandId) {
    console.log('‚ö° executeCommand() chamado com:', commandId);
    
    closeCommandPalette();
    console.log('Modal fechado');
    
    console.log('Executando switch para:', commandId);
    
    switch(commandId) {
        case 'cmd-new-task':
            console.log('‚Üí Abrindo modal nova tarefa');
            openModal();
            break;
        case 'cmd-dashboard':
            console.log('‚Üí Abrindo dashboard');
            // Verificar se est√° em servidor ou arquivo local
            if (window.location.protocol === 'file:') {
                alert('üí° Dashboard\n\nPara acessar o Dashboard, abra o arquivo "dashboard.html" diretamente.\n\nOu use um servidor local (Live Server, http-server, etc)');
            } else {
                window.open('dashboard.html', '_blank');
            }
            break;
        case 'cmd-lembretes':
            console.log('‚Üí Abrindo lembretes');
            if (window.location.protocol === 'file:') {
                alert('üí° Lembretes\n\nPara acessar Lembretes, abra o arquivo "lembretes.html" diretamente.\n\nOu use um servidor local (Live Server, http-server, etc)');
            } else {
                window.open('lembretes.html', '_blank');
            }
            break;
        case 'cmd-templates':
            console.log('‚Üí Abrindo templates');
            if (window.location.protocol === 'file:') {
                alert('üí° Templates\n\nPara acessar Templates, abra o arquivo "templates.html" diretamente.\n\nOu use um servidor local (Live Server, http-server, etc)');
            } else {
                window.open('templates.html', '_blank');
            }
            break;
        case 'cmd-integracoes':
            console.log('‚Üí Abrindo integra√ß√µes');
            if (window.location.protocol === 'file:') {
                alert('üí° Integra√ß√µes\n\nPara acessar Integra√ß√µes, abra o arquivo "integracoes.html" diretamente.\n\nOu use um servidor local (Live Server, http-server, etc)');
            } else {
                window.open('integracoes.html', '_blank');
            }
            break;
        case 'cmd-temas':
            console.log('‚Üí Abrindo editor de temas');
            openThemeEditor();
            break;
        case 'cmd-atalhos':
            console.log('‚Üí Mostrando atalhos');
            showShortcutsHelp();
            break;
        case 'cmd-densidade':
            console.log('‚Üí Alternando densidade');
            cycleDensity();
            break;
        case 'cmd-pessoas':
            console.log('‚Üí Gerenciando pessoas');
            managePeople();
            break;
        case 'cmd-export':
            console.log('‚Üí Exportando para Excel');
            exportToExcel();
            break;
        default:
            console.warn('‚ö†Ô∏è Comando n√£o reconhecido:', commandId);
    }
    
    console.log('‚úÖ executeCommand conclu√≠do');
}

function closeCommandPalette() {
    const modal = document.getElementById('commandPaletteModal');
    if (modal) modal.remove();
}

function showShortcutsHelp() {
    const modal = document.createElement('div');
    modal.className = 'modal active';
    modal.id = 'shortcutsModal';
    
    const shortcutsList = Object.entries(shortcuts).map(([key, data]) => `
        <div class="shortcut-item">
            <kbd class="shortcut-key">${key.replace('ctrl', '‚åò/Ctrl').replace('shift', '‚áß').replace('+', ' + ')}</kbd>
            <span class="shortcut-desc">${data.description}</span>
        </div>
    `).join('');
    
    modal.innerHTML = `
        <div class="modal-content" style="max-width: 600px;">
            <div class="modal-header">
                <h2>‚å®Ô∏è Atalhos de Teclado</h2>
                <button class="close-btn" onclick="closeShortcutsHelp()">√ó</button>
            </div>
            <div class="modal-body">
                <div class="shortcuts-list">
                    ${shortcutsList}
                </div>
                <div style="margin-top: 24px; padding: 16px; background: var(--bg-secondary); border-radius: 8px; font-size: 13px; color: var(--text-secondary);">
                    üí° <strong>Dica:</strong> Pressione <kbd>Ctrl+K</kbd> (ou <kbd>‚åò+K</kbd> no Mac) para abrir a paleta de comandos e acessar rapidamente qualquer funcionalidade.
                </div>
            </div>
        </div>
    `;
    
    document.body.appendChild(modal);
}

function closeShortcutsHelp() {
    const modal = document.getElementById('shortcutsModal');
    if (modal) modal.remove();
}

function focusSearch() {
    // Implementar busca global de tarefas
    alert('üîç Busca global em desenvolvimento');
}

function toggleSidebar() {
    // Toggle sidebar se existir
    alert('üìê Toggle sidebar em desenvolvimento');
}

function closeAllModals() {
    document.querySelectorAll('.modal.active').forEach(modal => {
        modal.classList.remove('active');
    });
}

// ========================================
// 3. MODO COMPACTO & DENSIDADE
// ========================================

let densityMode = 'comfortable'; // compact, comfortable, spacious

function loadDensity() {
    const saved = localStorage.getItem('taskflow-density');
    if (saved) {
        densityMode = saved;
        applyDensity(densityMode);
    }
}

function applyDensity(mode) {
    densityMode = mode;
    document.documentElement.setAttribute('data-density', mode);
    localStorage.setItem('taskflow-density', mode);
    
    const sizes = {
        compact: { cardPadding: '12px', cardGap: '8px', fontSize: '13px' },
        comfortable: { cardPadding: '16px', cardGap: '12px', fontSize: '14px' },
        spacious: { cardPadding: '20px', cardGap: '16px', fontSize: '15px' }
    };
    
    const root = document.documentElement;
    root.style.setProperty('--card-padding', sizes[mode].cardPadding);
    root.style.setProperty('--card-gap', sizes[mode].cardGap);
    root.style.setProperty('--card-font-size', sizes[mode].fontSize);
}

function cycleDensity() {
    const modes = ['compact', 'comfortable', 'spacious'];
    const currentIndex = modes.indexOf(densityMode);
    const nextIndex = (currentIndex + 1) % modes.length;
    const nextMode = modes[nextIndex];
    
    applyDensity(nextMode);
    
    const names = {
        compact: 'Compacto',
        comfortable: 'Confort√°vel',
        spacious: 'Espa√ßoso'
    };
    
    showNotification(`üìè Modo ${names[nextMode]} ativado`);
}

function openDensitySettings() {
    console.log('üìè openDensitySettings() chamado');
    console.log('densityMode atual:', densityMode);
    
    const modal = document.createElement('div');
    modal.className = 'modal active';
    modal.id = 'densityModal';
    
    console.log('Modal densidade criado');
    
    modal.innerHTML = `
        <div class="modal-content" style="max-width: 500px;">
            <div class="modal-header">
                <h2>üìè Densidade da Interface</h2>
                <button class="close-btn" onclick="closeDensitySettings()">√ó</button>
            </div>
            <div class="modal-body">
                <div class="density-options">
                    <div class="density-option ${densityMode === 'compact' ? 'active' : ''}" onclick="applyDensity('compact'); closeDensitySettings();">
                        <div class="density-icon">üìä</div>
                        <div class="density-info">
                            <div class="density-name">Compacto</div>
                            <div class="density-desc">Mais itens vis√≠veis, menos espa√ßamento</div>
                        </div>
                        ${densityMode === 'compact' ? '<span class="density-badge">‚úì</span>' : ''}
                    </div>
                    
                    <div class="density-option ${densityMode === 'comfortable' ? 'active' : ''}" onclick="applyDensity('comfortable'); closeDensitySettings();">
                        <div class="density-icon">üìã</div>
                        <div class="density-info">
                            <div class="density-name">Confort√°vel</div>
                            <div class="density-desc">Balan√ßo ideal entre espa√ßo e informa√ß√£o</div>
                        </div>
                        ${densityMode === 'comfortable' ? '<span class="density-badge">‚úì</span>' : ''}
                    </div>
                    
                    <div class="density-option ${densityMode === 'spacious' ? 'active' : ''}" onclick="applyDensity('spacious'); closeDensitySettings();">
                        <div class="density-icon">üì∞</div>
                        <div class="density-info">
                            <div class="density-name">Espa√ßoso</div>
                            <div class="density-desc">M√°ximo conforto visual, mais espa√ßamento</div>
                        </div>
                        ${densityMode === 'spacious' ? '<span class="density-badge">‚úì</span>' : ''}
                    </div>
                </div>
            </div>
        </div>
    `;
    
    document.body.appendChild(modal);
    console.log('‚úÖ Modal densidade adicionado ao DOM');
}

function closeDensitySettings() {
    const modal = document.getElementById('densityModal');
    if (modal) modal.remove();
}

// ========================================
// INICIALIZA√á√ÉO FASE 5
// ========================================

function initializePhase5() {
    loadCustomThemes();
    initializeKeyboardShortcuts();
    loadDensity();
    initializeBackupSystem(); // Initialize backup system
}

// Auto-inicializar quando DOM estiver pronto
if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', initializePhase5);
} else {
    initializePhase5();
}

// ========================================
// SISTEMA DE BACKUP AVAN√áADO
// ========================================

let backupHistory = [];
let autoBackupEnabled = false;
let autoBackupInterval = null;
let autoBackupFrequency = 'none'; // none, daily, weekly

function initializeBackupSystem() {
    // Load backup settings
    const savedSettings = localStorage.getItem('backup-settings');
    if (savedSettings) {
        const settings = JSON.parse(savedSettings);
        autoBackupFrequency = settings.frequency || 'none';
        autoBackupEnabled = settings.enabled || false;
    }
    
    // Load backup history
    const savedHistory = localStorage.getItem('backup-history');
    if (savedHistory) {
        backupHistory = JSON.parse(savedHistory);
    }
    
    // Start auto backup if enabled
    if (autoBackupEnabled) {
        startAutoBackup();
    }
    
    // Check if backup is needed
    checkAutoBackup();
}

function openBackupManager() {
    const modal = document.createElement('div');
    modal.className = 'modal active';
    modal.id = 'backupManagerModal';
    
    const totalTasks = tasks.length;
    const totalColumns = columns.length;
    const totalSwimlanes = swimlanes.length;
    const totalPeople = people.length;
    const totalReminders = JSON.parse(localStorage.getItem('kanban-reminders') || '[]').length;
    const totalNotes = JSON.parse(localStorage.getItem('kanban-notes') || '[]').length;
    const totalTemplates = JSON.parse(localStorage.getItem('custom-templates') || '[]').length;
    const totalReports = JSON.parse(localStorage.getItem('custom-reports') || '[]').length;
    const lastBackupDate = backupHistory.length > 0 ? new Date(backupHistory[0].timestamp).toLocaleString('pt-BR') : 'Nunca';
    
    modal.innerHTML = `
        <div class="backup-manager">
            <div class="backup-header">
                <h2>üíæ Sistema de Backup Completo</h2>
                <button onclick="closeBackupManager()" style="background: none; border: none; font-size: 24px; cursor: pointer; color: var(--text-secondary);">√ó</button>
            </div>
            
            <!-- Estat√≠sticas -->
            <div class="backup-section">
                <h3>üìä Dados do Sistema</h3>
                <div class="backup-stats">
                    <div class="backup-stat-card">
                        <div class="backup-stat-value">${totalTasks}</div>
                        <div class="backup-stat-label">Tarefas</div>
                    </div>
                    <div class="backup-stat-card">
                        <div class="backup-stat-value">${totalColumns}</div>
                        <div class="backup-stat-label">Colunas</div>
                    </div>
                    <div class="backup-stat-card">
                        <div class="backup-stat-value">${totalSwimlanes}</div>
                        <div class="backup-stat-label">Raias</div>
                    </div>
                    <div class="backup-stat-card">
                        <div class="backup-stat-value">${totalPeople}</div>
                        <div class="backup-stat-label">Pessoas</div>
                    </div>
                    <div class="backup-stat-card">
                        <div class="backup-stat-value">${totalReminders}</div>
                        <div class="backup-stat-label">Lembretes</div>
                    </div>
                    <div class="backup-stat-card">
                        <div class="backup-stat-value">${totalNotes}</div>
                        <div class="backup-stat-label">Notas</div>
                    </div>
                    <div class="backup-stat-card">
                        <div class="backup-stat-value">${totalTemplates}</div>
                        <div class="backup-stat-label">Templates</div>
                    </div>
                    <div class="backup-stat-card">
                        <div class="backup-stat-value">${totalReports}</div>
                        <div class="backup-stat-label">Relat√≥rios</div>
                    </div>
                </div>
                <div class="backup-info" style="margin-top: 16px;">
                    <div class="backup-info-icon">üïí</div>
                    <div class="backup-info-text">
                        <div class="backup-info-label">√öltimo Backup</div>
                        <div class="backup-info-value">${lastBackupDate}</div>
                    </div>
                </div>
            </div>
            
            <!-- A√ß√µes R√°pidas -->
            <div class="backup-section">
                <h3>‚ö° A√ß√µes R√°pidas</h3>
                <div class="backup-actions">
                    <button class="btn btn-primary" onclick="createFullBackup()">
                        üíæ Criar Backup Agora
                    </button>
                    <button class="btn btn-secondary" onclick="document.getElementById('restoreBackupInput').click()">
                        üì• Restaurar Backup
                    </button>
                    <button class="btn btn-secondary" onclick="exportSelectiveBackup()">
                        üìã Backup Seletivo
                    </button>
                    <input type="file" id="restoreBackupInput" accept=".json" style="display: none;" onchange="restoreBackup(event)">
                </div>
            </div>
            
            <!-- Backup Autom√°tico -->
            <div class="backup-section">
                <h3>üîÑ Backup Autom√°tico</h3>
                <div class="backup-auto-settings">
                    <div class="backup-auto-option ${autoBackupFrequency === 'none' ? 'active' : ''}" onclick="setAutoBackup('none')">
                        <input type="radio" name="autoBackup" ${autoBackupFrequency === 'none' ? 'checked' : ''}>
                        <div class="backup-auto-label">
                            <div class="backup-auto-title">Desativado</div>
                            <div class="backup-auto-desc">Sem backup autom√°tico</div>
                        </div>
                    </div>
                    <div class="backup-auto-option ${autoBackupFrequency === 'daily' ? 'active' : ''}" onclick="setAutoBackup('daily')">
                        <input type="radio" name="autoBackup" ${autoBackupFrequency === 'daily' ? 'checked' : ''}>
                        <div class="backup-auto-label">
                            <div class="backup-auto-title">Di√°rio</div>
                            <div class="backup-auto-desc">Backup autom√°tico a cada 24 horas</div>
                        </div>
                    </div>
                    <div class="backup-auto-option ${autoBackupFrequency === 'weekly' ? 'active' : ''}" onclick="setAutoBackup('weekly')">
                        <input type="radio" name="autoBackup" ${autoBackupFrequency === 'weekly' ? 'checked' : ''}>
                        <div class="backup-auto-label">
                            <div class="backup-auto-title">Semanal</div>
                            <div class="backup-auto-desc">Backup autom√°tico a cada 7 dias</div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Hist√≥rico de Backups -->
            <div class="backup-section">
                <h3>üìú Hist√≥rico de Backups (${backupHistory.length})</h3>
                <div class="backup-history" id="backupHistoryList">
                    ${renderBackupHistory()}
                </div>
            </div>
        </div>
    `;
    
    document.body.appendChild(modal);
}

function renderBackupHistory() {
    if (backupHistory.length === 0) {
        return '<div style="text-align: center; padding: 24px; color: var(--text-secondary);">Nenhum backup encontrado</div>';
    }
    
    return backupHistory.map((backup, index) => {
        const date = new Date(backup.timestamp);
        const dateStr = date.toLocaleString('pt-BR');
        const sizeKB = (JSON.stringify(backup.data).length / 1024).toFixed(2);
        
        return `
            <div class="backup-item">
                <div class="backup-item-info">
                    <div class="backup-item-name">
                        ${backup.auto ? 'üîÑ Auto' : 'üíæ Manual'} - ${backup.name || 'Backup'}
                    </div>
                    <div class="backup-item-details">
                        üìÖ ${dateStr} ‚Ä¢ üì¶ ${sizeKB} KB ‚Ä¢ 
                        ${backup.data.tasks?.length || 0} tarefas
                    </div>
                </div>
                <div class="backup-item-actions">
                    <button class="btn btn-secondary btn-sm" onclick="downloadBackupFromHistory(${index})" title="Baixar">
                        ‚¨áÔ∏è
                    </button>
                    <button class="btn btn-secondary btn-sm" onclick="restoreBackupFromHistory(${index})" title="Restaurar">
                        ‚ôªÔ∏è
                    </button>
                    <button class="btn btn-secondary btn-sm" onclick="deleteBackupFromHistory(${index})" title="Excluir">
                        üóëÔ∏è
                    </button>
                </div>
            </div>
        `;
    }).join('');
}

function createFullBackup(isAuto = false) {
    // Collect all data from ALL tabs/modules
    const backupData = {
        version: '3.0.11',
        timestamp: new Date().toISOString(),
        data: {
            // Kanban Advanced
            tasks: tasks,
            normalColumns: normalColumns,
            swimlaneColumns: swimlaneColumns,
            swimlanes: swimlanes,
            people: people,
            swimlanesMode: swimlanesMode,
            
            // Theme & Settings
            theme: currentTheme,
            customThemes: JSON.parse(localStorage.getItem('taskflow-custom-themes') || '{}'),
            density: localStorage.getItem('taskflow-density') || 'comfortable',
            currentThemeId: localStorage.getItem('taskflow-current-theme') || 'default',
            
            // Lembretes (Reminders)
            reminders: JSON.parse(localStorage.getItem('kanban-reminders') || '[]'),
            
            // Notas (Notes)
            notes: JSON.parse(localStorage.getItem('kanban-notes') || '[]'),
            
            // Dashboard
            dashboardSettings: JSON.parse(localStorage.getItem('dashboard-settings') || '{}'),
            customReports: JSON.parse(localStorage.getItem('custom-reports') || '[]'),
            
            // Templates
            customTemplates: JSON.parse(localStorage.getItem('custom-templates') || '[]'),
            
            // Timeline/Cronograma
            timelineView: localStorage.getItem('timeline-view') || 'gantt',
            timelineZoom: localStorage.getItem('timeline-zoom') || 'month',
            
            // Integra√ß√µes (Integrations)
            integrations: {
                googleCalendar: JSON.parse(localStorage.getItem('integration-google-calendar') || '{}'),
                github: JSON.parse(localStorage.getItem('integration-github') || '{}'),
                slack: JSON.parse(localStorage.getItem('integration-slack') || '{}'),
                discord: JSON.parse(localStorage.getItem('integration-discord') || '{}'),
                outlook: JSON.parse(localStorage.getItem('integration-outlook') || '{}'),
                restApi: JSON.parse(localStorage.getItem('integration-rest-api') || '{}'),
                email: JSON.parse(localStorage.getItem('integration-email') || '{}')
            },
            
            // System Settings
            settings: {
                autoBackup: autoBackupFrequency,
                notificationBannerDismissed: localStorage.getItem('notification-banner-dismissed'),
                keyboardShortcuts: JSON.parse(localStorage.getItem('taskflow-keyboard-shortcuts') || '{}')
            },
            
            // Metadata
            metadata: {
                totalTasks: tasks.length,
                totalColumns: columns.length,
                totalSwimlanes: swimlanes.length,
                totalPeople: people.length,
                totalReminders: JSON.parse(localStorage.getItem('kanban-reminders') || '[]').length,
                totalNotes: JSON.parse(localStorage.getItem('kanban-notes') || '[]').length,
                backupType: isAuto ? 'automatic' : 'manual',
                systemVersion: '3.0.11'
            }
        }
    };
    
    // Add to history
    const historyItem = {
        name: `Backup ${new Date().toLocaleDateString('pt-BR')}`,
        timestamp: backupData.timestamp,
        auto: isAuto,
        data: backupData.data
    };
    
    backupHistory.unshift(historyItem);
    
    // Keep only last 10 backups
    if (backupHistory.length > 10) {
        backupHistory = backupHistory.slice(0, 10);
    }
    
    // Save history
    localStorage.setItem('backup-history', JSON.stringify(backupHistory));
    localStorage.setItem('last-backup-date', backupData.timestamp);
    
    // Download backup file
    const blob = new Blob([JSON.stringify(backupData, null, 2)], { type: 'application/json' });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = `TaskFlow-Backup-${new Date().toISOString().split('T')[0]}.json`;
    a.click();
    URL.revokeObjectURL(url);
    
    // Show notification
    showNotification(isAuto ? 'üîÑ Backup autom√°tico criado!' : 'üíæ Backup completo criado com sucesso!');
    
    // Refresh modal if open
    const modal = document.getElementById('backupManagerModal');
    if (modal) {
        modal.remove();
        openBackupManager();
    }
}

function restoreBackup(event) {
    const file = event.target.files[0];
    if (!file) return;
    
    const reader = new FileReader();
    reader.onload = (e) => {
        try {
            const backup = JSON.parse(e.target.result);
            
            // Validate backup
            if (!backup.version || !backup.data) {
                throw new Error('Formato de backup inv√°lido');
            }
            
            // Confirm restore
            if (!confirm('‚ö†Ô∏è ATEN√á√ÉO: Restaurar backup ir√° substituir TODOS os dados atuais. Deseja continuar?')) {
                return;
            }
            
            // Restore data
            if (backup.data.tasks) {
                tasks = backup.data.tasks;
                localStorage.setItem('kanban-tasks', JSON.stringify(tasks));
            }
            
            // Restore separate columns for each mode
            if (backup.data.normalColumns) {
                normalColumns = backup.data.normalColumns;
                localStorage.setItem('kanban-normal-columns', JSON.stringify(normalColumns));
            } else if (backup.data.columns) {
                // Backward compatibility: old backups with single columns
                normalColumns = backup.data.columns;
                localStorage.setItem('kanban-normal-columns', JSON.stringify(normalColumns));
            }
            
            if (backup.data.swimlaneColumns) {
                swimlaneColumns = backup.data.swimlaneColumns;
                localStorage.setItem('kanban-swimlane-columns', JSON.stringify(swimlaneColumns));
            } else if (backup.data.columns) {
                // Backward compatibility: old backups with single columns
                swimlaneColumns = backup.data.columns;
                localStorage.setItem('kanban-swimlane-columns', JSON.stringify(swimlaneColumns));
            }
            
            if (backup.data.swimlanes) {
                swimlanes = backup.data.swimlanes;
                localStorage.setItem('kanban-swimlanes', JSON.stringify(swimlanes));
            }
            
            if (backup.data.people) {
                people = backup.data.people;
                localStorage.setItem('kanban-people', JSON.stringify(people));
            }
            
            if (backup.data.swimlanesMode !== undefined) {
                swimlanesMode = backup.data.swimlanesMode;
                localStorage.setItem('kanban-swimlanes-mode', JSON.stringify(swimlanesMode));
            }
            
            if (backup.data.theme) {
                currentTheme = backup.data.theme;
                localStorage.setItem('kanban-theme', currentTheme);
            }
            
            if (backup.data.customThemes) {
                localStorage.setItem('taskflow-custom-themes', JSON.stringify(backup.data.customThemes));
            }
            
            if (backup.data.currentThemeId) {
                localStorage.setItem('taskflow-current-theme', backup.data.currentThemeId);
            }
            
            if (backup.data.density) {
                localStorage.setItem('taskflow-density', backup.data.density);
            }
            
            if (backup.data.reminders) {
                localStorage.setItem('kanban-reminders', JSON.stringify(backup.data.reminders));
            }
            
            if (backup.data.notes) {
                localStorage.setItem('kanban-notes', JSON.stringify(backup.data.notes));
            }
            
            // Dashboard
            if (backup.data.dashboardSettings) {
                localStorage.setItem('dashboard-settings', JSON.stringify(backup.data.dashboardSettings));
            }
            
            if (backup.data.customReports) {
                localStorage.setItem('custom-reports', JSON.stringify(backup.data.customReports));
            }
            
            // Templates
            if (backup.data.customTemplates) {
                localStorage.setItem('custom-templates', JSON.stringify(backup.data.customTemplates));
            }
            
            // Timeline
            if (backup.data.timelineView) {
                localStorage.setItem('timeline-view', backup.data.timelineView);
            }
            
            if (backup.data.timelineZoom) {
                localStorage.setItem('timeline-zoom', backup.data.timelineZoom);
            }
            
            // Integra√ß√µes
            if (backup.data.integrations) {
                if (backup.data.integrations.googleCalendar) {
                    localStorage.setItem('integration-google-calendar', JSON.stringify(backup.data.integrations.googleCalendar));
                }
                if (backup.data.integrations.github) {
                    localStorage.setItem('integration-github', JSON.stringify(backup.data.integrations.github));
                }
                if (backup.data.integrations.slack) {
                    localStorage.setItem('integration-slack', JSON.stringify(backup.data.integrations.slack));
                }
                if (backup.data.integrations.discord) {
                    localStorage.setItem('integration-discord', JSON.stringify(backup.data.integrations.discord));
                }
                if (backup.data.integrations.outlook) {
                    localStorage.setItem('integration-outlook', JSON.stringify(backup.data.integrations.outlook));
                }
                if (backup.data.integrations.restApi) {
                    localStorage.setItem('integration-rest-api', JSON.stringify(backup.data.integrations.restApi));
                }
                if (backup.data.integrations.email) {
                    localStorage.setItem('integration-email', JSON.stringify(backup.data.integrations.email));
                }
            }
            
            // Settings
            if (backup.data.settings) {
                if (backup.data.settings.keyboardShortcuts) {
                    localStorage.setItem('taskflow-keyboard-shortcuts', JSON.stringify(backup.data.settings.keyboardShortcuts));
                }
                if (backup.data.settings.notificationBannerDismissed) {
                    localStorage.setItem('notification-banner-dismissed', backup.data.settings.notificationBannerDismissed);
                }
            }
            
            // Reload page
            showNotification('‚úÖ Backup completo restaurado! Recarregando...');
            setTimeout(() => location.reload(), 1500);
            
        } catch (error) {
            alert('‚ùå Erro ao restaurar backup: ' + error.message);
        }
    };
    reader.readAsText(file);
    
    // Reset input
    event.target.value = '';
}

function exportSelectiveBackup() {
    const modal = document.createElement('div');
    modal.className = 'modal active';
    modal.id = 'selectiveBackupModal';
    
    modal.innerHTML = `
        <div class="backup-manager" style="max-width: 600px;">
            <div class="backup-header">
                <h2>üìã Backup Seletivo</h2>
                <button onclick="document.getElementById('selectiveBackupModal').remove()" style="background: none; border: none; font-size: 24px; cursor: pointer; color: var(--text-secondary);">√ó</button>
            </div>
            
            <div class="backup-section">
                <h3>Selecione o que exportar:</h3>
                <div style="display: flex; flex-direction: column; gap: 12px; margin-top: 16px;">
                    <label style="display: flex; align-items: center; gap: 12px; padding: 12px; background: var(--bg-dark); border-radius: 6px; cursor: pointer;">
                        <input type="checkbox" id="backup-tasks" checked>
                        <span>‚úÖ Tarefas (${tasks.length})</span>
                    </label>
                    <label style="display: flex; align-items: center; gap: 12px; padding: 12px; background: var(--bg-dark); border-radius: 6px; cursor: pointer;">
                        <input type="checkbox" id="backup-columns" checked>
                        <span>üìä Colunas (${columns.length})</span>
                    </label>
                    <label style="display: flex; align-items: center; gap: 12px; padding: 12px; background: var(--bg-dark); border-radius: 6px; cursor: pointer;">
                        <input type="checkbox" id="backup-swimlanes" checked>
                        <span>üèä Raias (${swimlanes.length})</span>
                    </label>
                    <label style="display: flex; align-items: center; gap: 12px; padding: 12px; background: var(--bg-dark); border-radius: 6px; cursor: pointer;">
                        <input type="checkbox" id="backup-people" checked>
                        <span>üë• Pessoas (${people.length})</span>
                    </label>
                    <label style="display: flex; align-items: center; gap: 12px; padding: 12px; background: var(--bg-dark); border-radius: 6px; cursor: pointer;">
                        <input type="checkbox" id="backup-reminders" checked>
                        <span>üîî Lembretes (${JSON.parse(localStorage.getItem('kanban-reminders') || '[]').length})</span>
                    </label>
                    <label style="display: flex; align-items: center; gap: 12px; padding: 12px; background: var(--bg-dark); border-radius: 6px; cursor: pointer;">
                        <input type="checkbox" id="backup-notes" checked>
                        <span>üìù Notas (${JSON.parse(localStorage.getItem('kanban-notes') || '[]').length})</span>
                    </label>
                    <label style="display: flex; align-items: center; gap: 12px; padding: 12px; background: var(--bg-dark); border-radius: 6px; cursor: pointer;">
                        <input type="checkbox" id="backup-templates" checked>
                        <span>üìã Templates Customizados</span>
                    </label>
                    <label style="display: flex; align-items: center; gap: 12px; padding: 12px; background: var(--bg-dark); border-radius: 6px; cursor: pointer;">
                        <input type="checkbox" id="backup-dashboard" checked>
                        <span>üìä Dashboard & Relat√≥rios</span>
                    </label>
                    <label style="display: flex; align-items: center; gap: 12px; padding: 12px; background: var(--bg-dark); border-radius: 6px; cursor: pointer;">
                        <input type="checkbox" id="backup-integrations" checked>
                        <span>üîó Integra√ß√µes</span>
                    </label>
                    <label style="display: flex; align-items: center; gap: 12px; padding: 12px; background: var(--bg-dark); border-radius: 6px; cursor: pointer;">
                        <input type="checkbox" id="backup-settings" checked>
                        <span>‚öôÔ∏è Configura√ß√µes & Temas</span>
                    </label>
                </div>
            </div>
            
            <div style="display: flex; gap: 12px; justify-content: flex-end;">
                <button class="btn btn-secondary" onclick="document.getElementById('selectiveBackupModal').remove()">
                    Cancelar
                </button>
                <button class="btn btn-primary" onclick="executeSelectiveBackup()">
                    üíæ Exportar Selecionados
                </button>
            </div>
        </div>
    `;
    
    document.body.appendChild(modal);
}

function executeSelectiveBackup() {
    const backupData = {
        version: '3.0.11',
        timestamp: new Date().toISOString(),
        selective: true,
        data: {}
    };
    
    if (document.getElementById('backup-tasks').checked) {
        backupData.data.tasks = tasks;
    }
    
    if (document.getElementById('backup-columns').checked) {
        backupData.data.columns = columns;
    }
    
    if (document.getElementById('backup-swimlanes').checked) {
        backupData.data.swimlanes = swimlanes;
    }
    
    if (document.getElementById('backup-people').checked) {
        backupData.data.people = people;
    }
    
    if (document.getElementById('backup-reminders').checked) {
        backupData.data.reminders = JSON.parse(localStorage.getItem('kanban-reminders') || '[]');
    }
    
    if (document.getElementById('backup-notes').checked) {
        backupData.data.notes = JSON.parse(localStorage.getItem('taskflow-notes') || '[]');
        backupData.data.notesDraft = JSON.parse(localStorage.getItem('taskflow-notes-draft') || '{}');
    }
    
    if (document.getElementById('backup-templates').checked) {
        backupData.data.customTemplates = JSON.parse(localStorage.getItem('custom-templates') || '[]');
    }
    
    if (document.getElementById('backup-dashboard').checked) {
        backupData.data.dashboardSettings = JSON.parse(localStorage.getItem('dashboard-settings') || '{}');
        backupData.data.customReports = JSON.parse(localStorage.getItem('custom-reports') || '[]');
    }
    
    if (document.getElementById('backup-integrations').checked) {
        backupData.data.integrations = {
            googleCalendar: JSON.parse(localStorage.getItem('integration-google-calendar') || '{}'),
            github: JSON.parse(localStorage.getItem('integration-github') || '{}'),
            slack: JSON.parse(localStorage.getItem('integration-slack') || '{}'),
            discord: JSON.parse(localStorage.getItem('integration-discord') || '{}'),
            outlook: JSON.parse(localStorage.getItem('integration-outlook') || '{}'),
            restApi: JSON.parse(localStorage.getItem('integration-rest-api') || '{}'),
            email: JSON.parse(localStorage.getItem('integration-email') || '{}')
        };
        backupData.data.integrationLog = JSON.parse(localStorage.getItem('taskflow-integration-log') || '[]');
    }
    
    // Adicionar dados do sistema que estavam faltando
    if (document.getElementById('backup-reminders').checked) {
        backupData.data.taskflowReminders = JSON.parse(localStorage.getItem('taskflow-reminders') || '[]');
        backupData.data.remindersTodayCount = localStorage.getItem('taskflow-reminders-today-count');
    }
    
    if (document.getElementById('backup-people').checked) {
        backupData.data.taskflowPeople = JSON.parse(localStorage.getItem('taskflow-people') || '[]');
    }
    
    // Dados do usu√°rio
    if (document.getElementById('backup-settings').checked) {
        backupData.data.currentUser = JSON.parse(localStorage.getItem('taskflow-current-user') || '{}');
    }
    
    if (document.getElementById('backup-settings').checked) {
        backupData.data.theme = currentTheme;
        backupData.data.customThemes = JSON.parse(localStorage.getItem('taskflow-custom-themes') || '{}');
        backupData.data.currentThemeId = localStorage.getItem('taskflow-current-theme') || 'default';
        backupData.data.density = localStorage.getItem('taskflow-density');
        backupData.data.swimlanesMode = swimlanesMode;
        backupData.data.settings = {
            autoBackup: autoBackupFrequency,
            keyboardShortcuts: JSON.parse(localStorage.getItem('taskflow-keyboard-shortcuts') || '{}')
        };
    }
    
    // Download
    const blob = new Blob([JSON.stringify(backupData, null, 2)], { type: 'application/json' });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = `TaskFlow-Selective-${new Date().toISOString().split('T')[0]}.json`;
    a.click();
    URL.revokeObjectURL(url);
    
    document.getElementById('selectiveBackupModal').remove();
    showNotification('üíæ Backup seletivo criado!');
}

function downloadBackupFromHistory(index) {
    const backup = backupHistory[index];
    const backupData = {
        version: '3.0',
        timestamp: backup.timestamp,
        data: backup.data
    };
    
    const blob = new Blob([JSON.stringify(backupData, null, 2)], { type: 'application/json' });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = `${backup.name.replace(/ /g, '-')}.json`;
    a.click();
    URL.revokeObjectURL(url);
    
    showNotification('‚¨áÔ∏è Backup baixado!');
}

function restoreBackupFromHistory(index) {
    const backup = backupHistory[index];
    
    if (!confirm(`‚ö†Ô∏è Restaurar backup de ${new Date(backup.timestamp).toLocaleString('pt-BR')}?\n\nIsso ir√° substituir TODOS os dados atuais.`)) {
        return;
    }
    
    // Restore data
    if (backup.data.tasks) {
        tasks = backup.data.tasks;
        localStorage.setItem('kanban-tasks', JSON.stringify(tasks));
    }
    
    if (backup.data.columns) {
        columns = backup.data.columns;
        localStorage.setItem('kanban-columns', JSON.stringify(columns));
    }
    
    if (backup.data.swimlanes) {
        swimlanes = backup.data.swimlanes;
        localStorage.setItem('kanban-swimlanes', JSON.stringify(swimlanes));
    }
    
    if (backup.data.people) {
        people = backup.data.people;
        localStorage.setItem('kanban-people', JSON.stringify(people));
    }
    
    showNotification('‚úÖ Backup restaurado! Recarregando...');
    setTimeout(() => location.reload(), 1500);
}

function deleteBackupFromHistory(index) {
    if (!confirm('üóëÔ∏è Excluir este backup do hist√≥rico?')) {
        return;
    }
    
    backupHistory.splice(index, 1);
    localStorage.setItem('backup-history', JSON.stringify(backupHistory));
    
    // Refresh modal
    const modal = document.getElementById('backupManagerModal');
    if (modal) {
        modal.remove();
        openBackupManager();
    }
    
    showNotification('üóëÔ∏è Backup exclu√≠do do hist√≥rico');
}

function setAutoBackup(frequency) {
    autoBackupFrequency = frequency;
    autoBackupEnabled = frequency !== 'none';
    
    // Save settings
    localStorage.setItem('backup-settings', JSON.stringify({
        frequency: frequency,
        enabled: autoBackupEnabled
    }));
    
    // Stop existing interval
    if (autoBackupInterval) {
        clearInterval(autoBackupInterval);
        autoBackupInterval = null;
    }
    
    // Start new interval if enabled
    if (autoBackupEnabled) {
        startAutoBackup();
    }
    
    // Refresh modal
    const modal = document.getElementById('backupManagerModal');
    if (modal) {
        modal.remove();
        openBackupManager();
    }
    
    showNotification(autoBackupEnabled ? `üîÑ Backup autom√°tico ${frequency === 'daily' ? 'di√°rio' : 'semanal'} ativado!` : '‚è∏Ô∏è Backup autom√°tico desativado');
}

function startAutoBackup() {
    const interval = autoBackupFrequency === 'daily' ? 24 * 60 * 60 * 1000 : 7 * 24 * 60 * 60 * 1000;
    
    autoBackupInterval = setInterval(() => {
        createFullBackup(true);
    }, interval);
}

function checkAutoBackup() {
    if (!autoBackupEnabled) return;
    
    const lastBackup = localStorage.getItem('last-backup-date');
    if (!lastBackup) {
        createFullBackup(true);
        return;
    }
    
    const lastBackupDate = new Date(lastBackup);
    const now = new Date();
    const diffMs = now - lastBackupDate;
    const diffDays = diffMs / (1000 * 60 * 60 * 24);
    
    if (autoBackupFrequency === 'daily' && diffDays >= 1) {
        createFullBackup(true);
    } else if (autoBackupFrequency === 'weekly' && diffDays >= 7) {
        createFullBackup(true);
    }
}

function closeBackupManager() {
    const modal = document.getElementById('backupManagerModal');
    if (modal) modal.remove();
}

// ====== LOG FINAL - TODAS FUN√á√ïES CARREGADAS ======
console.log('=======================================');
console.log('‚úÖ Todas as fun√ß√µes foram definidas!');
console.log('Verificando fun√ß√µes cr√≠ticas:');
console.log('  managePeople:', typeof managePeople);
console.log('  openThemeEditor:', typeof openThemeEditor);
console.log('  openCommandPalette:', typeof openCommandPalette);
console.log('  openDensitySettings:', typeof openDensitySettings);
console.log('  openBackupManager:', typeof openBackupManager);
console.log('  exportToExcel:', typeof exportToExcel);
console.log('  exportToProjectXML:', typeof exportToProjectXML);
console.log('  toggleSwimlanesMode:', typeof toggleSwimlanesMode);
console.log('  XLSX:', typeof XLSX);
console.log('=======================================');
console.log('üéâ TaskFlow v3.0.58 carregado completamente!');
console.log('üìù Se alguma fun√ß√£o acima estiver "undefined", h√° erro de sintaxe antes dela.');
console.log('=======================================');


    </script>
    
    <!-- SheetJS (XLSX) para importar/exportar Excel -->
    <script src="https://cdn.sheetjs.com/xlsx-0.20.1/package/dist/xlsx.full.min.js"></script>
</body>
</html>
