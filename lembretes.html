<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TaskFlow v3.0 - Lembretes Avan√ßados</title>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap');
        
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        :root {
            --bg-primary: #ffffff;
            --bg-secondary: #f7f8f9;
            --bg-hover: #ebecf0;
            --bg-card: #ffffff;
            --border: #dfe1e6;
            --text-primary: #172b4d;
            --text-secondary: #5e6c84;
            --text-tertiary: #8993a4;
            --accent-blue: #0052cc;
            --accent-green: #00875a;
            --accent-orange: #ff8b00;
            --accent-red: #de350b;
            --accent-purple: #6554c0;
            --accent-yellow: #ffab00;
            --accent-cyan: #00b8d9;
            --accent-pink: #ff5630;
            --shadow: 0 1px 3px rgba(0, 0, 0, 0.12);
        }
        
        [data-theme="dark"] {
            --bg-primary: #1c2128;
            --bg-secondary: #22272b;
            --bg-hover: #2c333a;
            --bg-card: #22272b;
            --border: #373d45;
            --text-primary: #f1f2f4;
            --text-secondary: #9fadbc;
            --text-tertiary: #738496;
            --accent-blue: #579dff;
            --accent-green: #4bce97;
            --accent-orange: #faa53d;
            --accent-red: #f87462;
            --accent-purple: #9f8fef;
            --accent-yellow: #e2b203;
            --accent-cyan: #60c6d2;
            --accent-pink: #ff8f73;
        }
        
        body {
            font-family: 'Inter', -apple-system, sans-serif;
            background: var(--bg-secondary);
            color: var(--text-primary);
            min-height: 100vh;
        }
        
        .container {
            max-width: 1400px;
            margin: 0 auto;
        }
        
        /* Header */
        .header {
            background: var(--bg-primary);
            border-bottom: 2px solid var(--border);
            padding: 16px 24px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            position: sticky;
            top: 0;
            z-index: 100;
            box-shadow: var(--shadow);
        }
        
        .header-left {
            display: flex;
            align-items: center;
            gap: 20px;
        }
        
        .logo {
            font-size: 24px;
            font-weight: 700;
            display: flex;
            align-items: center;
            gap: 12px;
        }
        
        .version-badge {
            font-size: 11px;
            background: var(--accent-blue);
            color: white;
            padding: 4px 8px;
            border-radius: 4px;
            font-weight: 600;
        }
        
        .stats {
            display: flex;
            gap: 16px;
            font-size: 14px;
            color: var(--text-secondary);
        }
        
        .stat-item {
            display: flex;
            align-items: center;
            gap: 6px;
        }
        
        .stat-badge {
            background: var(--bg-hover);
            padding: 4px 10px;
            border-radius: 12px;
            font-weight: 600;
            color: var(--text-primary);
        }
        
        .stat-badge.today {
            background: var(--accent-red);
            color: white;
        }
        
        .header-actions {
            display: flex;
            gap: 12px;
        }
        
        .btn {
            padding: 10px 20px;
            border: none;
            border-radius: 4px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .btn-primary {
            background: var(--accent-blue);
            color: white;
        }
        
        .btn-primary:hover {
            opacity: 0.9;
            transform: translateY(-1px);
        }
        
        .btn-secondary {
            background: var(--bg-hover);
            color: var(--text-primary);
            border: 1px solid var(--border);
        }
        
        .btn-secondary:hover {
            background: var(--border);
        }
        
        .theme-toggle {
            background: var(--bg-hover);
            border: 1px solid var(--border);
            padding: 10px 12px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 20px;
        }
        
        /* Tabs */
        .tabs {
            background: var(--bg-primary);
            border-bottom: 1px solid var(--border);
            padding: 0 24px;
            display: flex;
            gap: 8px;
        }
        
        .tab {
            padding: 16px 24px;
            border: none;
            background: transparent;
            color: var(--text-secondary);
            font-size: 15px;
            font-weight: 600;
            cursor: pointer;
            border-bottom: 3px solid transparent;
            transition: all 0.2s;
            position: relative;
        }
        
        .tab:hover {
            color: var(--text-primary);
            background: var(--bg-hover);
        }
        
        .tab.active {
            color: var(--accent-blue);
            border-bottom-color: var(--accent-blue);
        }
        
        .tab-badge {
            position: absolute;
            top: 10px;
            right: 10px;
            background: var(--accent-red);
            color: white;
            border-radius: 10px;
            padding: 2px 8px;
            font-size: 11px;
            font-weight: 700;
        }
        
        /* Filters */
        .filters {
            background: var(--bg-primary);
            padding: 16px 24px;
            border-bottom: 1px solid var(--border);
            display: flex;
            gap: 12px;
            flex-wrap: wrap;
            align-items: center;
        }
        
        .filter-label {
            font-size: 14px;
            font-weight: 600;
            color: var(--text-secondary);
        }
        
        .filter-chip {
            padding: 6px 14px;
            border-radius: 16px;
            border: 1px solid var(--border);
            background: var(--bg-secondary);
            color: var(--text-primary);
            font-size: 13px;
            cursor: pointer;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            gap: 6px;
        }
        
        .filter-chip:hover {
            background: var(--bg-hover);
        }
        
        .filter-chip.active {
            background: var(--accent-blue);
            color: white;
            border-color: var(--accent-blue);
        }
        
        .category-dot {
            width: 10px;
            height: 10px;
            border-radius: 50%;
        }
        
        /* Content */
        .content {
            padding: 24px;
        }
        
        .reminders-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(350px, 1fr));
            gap: 16px;
        }
        
        /* Reminder Card */
        .reminder-card {
            background: var(--bg-card);
            border: 2px solid var(--border);
            border-radius: 8px;
            padding: 16px;
            transition: all 0.2s;
            cursor: pointer;
        }
        
        .reminder-card:hover {
            box-shadow: 0 4px 12px var(--shadow);
            transform: translateY(-2px);
        }
        
        .reminder-card.today {
            border-color: var(--accent-red);
            border-width: 2px;
        }
        
        .reminder-card.overdue {
            border-color: var(--accent-orange);
            border-width: 2px;
            background: linear-gradient(135deg, var(--bg-card) 0%, rgba(255,139,0,0.05) 100%);
        }
        
        .reminder-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 12px;
        }
        
        .reminder-title {
            font-size: 16px;
            font-weight: 600;
            flex: 1;
            margin-bottom: 4px;
        }
        
        .reminder-actions {
            display: flex;
            gap: 8px;
        }
        
        .action-btn {
            background: var(--bg-hover);
            border: none;
            width: 32px;
            height: 32px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 16px;
            transition: all 0.2s;
        }
        
        .action-btn:hover {
            background: var(--accent-blue);
            color: white;
        }
        
        .action-btn.delete:hover {
            background: var(--accent-red);
        }
        
        .action-btn.complete:hover {
            background: var(--accent-green);
        }
        
        .reminder-datetime {
            display: flex;
            align-items: center;
            gap: 12px;
            font-size: 14px;
            color: var(--text-secondary);
            margin-bottom: 8px;
        }
        
        .reminder-description {
            font-size: 14px;
            color: var(--text-secondary);
            line-height: 1.5;
            margin-bottom: 12px;
        }
        
        .reminder-footer {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding-top: 12px;
            border-top: 1px solid var(--border);
        }
        
        .reminder-categories {
            display: flex;
            gap: 6px;
            flex-wrap: wrap;
        }
        
        .category-badge {
            padding: 4px 10px;
            border-radius: 12px;
            font-size: 11px;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 4px;
        }
        
        .recurrence-badge {
            background: var(--accent-purple);
            color: white;
            padding: 4px 10px;
            border-radius: 12px;
            font-size: 11px;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 4px;
        }
        
        /* Modal */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.5);
            z-index: 1000;
            align-items: center;
            justify-content: center;
            padding: 20px;
        }
        
        .modal.active {
            display: flex;
        }
        
        .modal-content {
            background: var(--bg-primary);
            border-radius: 8px;
            width: 100%;
            max-width: 600px;
            max-height: 90vh;
            overflow-y: auto;
            box-shadow: 0 8px 24px rgba(0, 0, 0, 0.3);
        }
        
        .modal-header {
            padding: 24px;
            border-bottom: 1px solid var(--border);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .modal-title {
            font-size: 20px;
            font-weight: 700;
        }
        
        .close-btn {
            background: none;
            border: none;
            font-size: 28px;
            cursor: pointer;
            color: var(--text-secondary);
            padding: 0;
            width: 32px;
            height: 32px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 4px;
        }
        
        .close-btn:hover {
            background: var(--bg-hover);
        }
        
        .modal-body {
            padding: 24px;
        }
        
        .form-group {
            margin-bottom: 20px;
        }
        
        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            font-size: 14px;
        }
        
        .form-group input,
        .form-group textarea,
        .form-group select {
            width: 100%;
            padding: 10px 12px;
            border: 1px solid var(--border);
            border-radius: 4px;
            font-size: 14px;
            background: var(--bg-primary);
            color: var(--text-primary);
            font-family: inherit;
        }
        
        .form-group textarea {
            resize: vertical;
            min-height: 80px;
        }
        
        .checkbox-group {
            display: flex;
            align-items: center;
            gap: 8px;
            cursor: pointer;
        }
        
        .checkbox-group input[type="checkbox"] {
            width: auto;
            cursor: pointer;
        }
        
        .form-row {
            display: grid;
            grid-template-columns: 2fr 1fr;
            gap: 12px;
        }
        
        .recurrence-options {
            display: none;
            padding: 16px;
            background: var(--bg-secondary);
            border-radius: 4px;
            margin-top: 12px;
        }
        
        .recurrence-options.active {
            display: block;
        }
        
        .days-selector {
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
        }
        
        .day-btn {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            border: 1px solid var(--border);
            background: var(--bg-primary);
            cursor: pointer;
            font-size: 12px;
            font-weight: 600;
            transition: all 0.2s;
        }
        
        .day-btn.selected {
            background: var(--accent-blue);
            color: white;
            border-color: var(--accent-blue);
        }
        
        .categories-selector {
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
        }
        
        .category-option {
            padding: 8px 14px;
            border-radius: 16px;
            border: 1px solid var(--border);
            cursor: pointer;
            font-size: 13px;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            gap: 6px;
        }
        
        .category-option.selected {
            border-width: 2px;
        }
        
        .notification-settings {
            display: flex;
            flex-direction: column;
            gap: 12px;
            padding: 16px;
            background: var(--bg-secondary);
            border-radius: 4px;
        }
        
        .modal-footer {
            padding: 16px 24px;
            border-top: 1px solid var(--border);
            display: flex;
            justify-content: flex-end;
            gap: 12px;
        }
        
        /* Empty State */
        .empty-state {
            text-align: center;
            padding: 60px 20px;
        }
        
        .empty-icon {
            font-size: 64px;
            margin-bottom: 16px;
            opacity: 0.5;
        }
        
        .empty-title {
            font-size: 18px;
            font-weight: 600;
            margin-bottom: 8px;
        }
        
        .empty-text {
            font-size: 14px;
            color: var(--text-secondary);
        }
        
        /* Notification Permission */
        .notification-banner {
            background: var(--accent-yellow);
            color: #000;
            padding: 12px 24px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-size: 14px;
            font-weight: 600;
        }
        
        .notification-banner.hidden {
            display: none;
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- Notification Permission Banner -->
        <div class="notification-banner hidden" id="notificationBanner">
            <span>üîî Ative as notifica√ß√µes para n√£o perder nenhum lembrete!</span>
            <div style="display: flex; gap: 12px;">
                <button class="btn btn-secondary" onclick="requestNotificationPermission()">Ativar</button>
                <button class="btn btn-secondary" onclick="hideNotificationBanner()">Agora n√£o</button>
            </div>
        </div>

        <!-- Header -->
        <div class="header">
            <div class="header-left">
                <div class="logo">
                    üîî Lembretes
                    <span class="version-badge">v3.0</span>
                </div>
                <div class="stats">
                    <div class="stat-item">
                        <span>Total:</span>
                        <span class="stat-badge" id="totalCount">0</span>
                    </div>
                    <div class="stat-item">
                        <span>Hoje:</span>
                        <span class="stat-badge today" id="todayCount">0</span>
                    </div>
                </div>
            </div>
            <div class="header-actions">
                <button class="theme-toggle" onclick="toggleTheme()" id="themeToggle">üåô</button>
                <button class="btn btn-secondary" onclick="window.close()">
                    ‚Üê Voltar ao Kanban
                </button>
                <button class="btn btn-primary" onclick="openModal()">
                    ‚ûï Novo Lembrete
                </button>
            </div>
        </div>

        <!-- Tabs -->
        <div class="tabs">
            <button class="tab active" data-tab="todos" onclick="switchTab('todos')">
                üìã Todos
            </button>
            <button class="tab" data-tab="hoje" onclick="switchTab('hoje')">
                üî• Hoje
                <span class="tab-badge" id="todayBadge">0</span>
            </button>
            <button class="tab" data-tab="proximos" onclick="switchTab('proximos')">
                üìÖ Pr√≥ximos
            </button>
            <button class="tab" data-tab="atrasados" onclick="switchTab('atrasados')">
                ‚ö†Ô∏è Atrasados
                <span class="tab-badge" id="overdueBadge">0</span>
            </button>
            <button class="tab" data-tab="recorrentes" onclick="switchTab('recorrentes')">
                üîÑ Recorrentes
            </button>
        </div>

        <!-- Filters -->
        <div class="filters" id="categoryFilters">
            <span class="filter-label">Categorias:</span>
            <button class="filter-chip active" data-category="all" onclick="filterByCategory('all')">
                Todas
            </button>
            <!-- Category filters will be added dynamically -->
        </div>

        <!-- Content -->
        <div class="content">
            <div class="reminders-grid" id="remindersGrid">
                <!-- Reminders will be rendered here -->
            </div>
        </div>
    </div>

    <!-- Modal -->
    <div class="modal" id="reminderModal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title" id="modalTitle">Novo Lembrete</h2>
                <button class="close-btn" onclick="closeModal()">√ó</button>
            </div>
            <div class="modal-body">
                <form id="reminderForm" onsubmit="saveReminder(event)">
                    <div class="form-group">
                        <label for="reminderTitle">T√≠tulo *</label>
                        <input type="text" id="reminderTitle" required placeholder="Ex: Reuni√£o com cliente">
                    </div>

                    <div class="form-row">
                        <div class="form-group">
                            <label for="reminderDate">Data *</label>
                            <input type="date" id="reminderDate" required>
                        </div>
                        <div class="form-group">
                            <label for="reminderTime">Hora</label>
                            <input type="time" id="reminderTime">
                        </div>
                    </div>

                    <div class="form-group">
                        <label for="reminderDescription">Descri√ß√£o</label>
                        <textarea id="reminderDescription" placeholder="Detalhes do lembrete..."></textarea>
                    </div>

                    <!-- v3.0: Recorr√™ncia -->
                    <div class="form-group">
                        <label class="checkbox-group">
                            <input type="checkbox" id="enableRecurrence" onchange="toggleRecurrenceOptions()">
                            <span>üîÑ Lembrete recorrente</span>
                        </label>
                        <div class="recurrence-options" id="recurrenceOptions">
                            <div class="form-group">
                                <label for="recurrenceType">Frequ√™ncia</label>
                                <select id="recurrenceType" onchange="updateRecurrenceOptions()">
                                    <option value="daily">Di√°rio</option>
                                    <option value="weekly">Semanal</option>
                                    <option value="monthly">Mensal</option>
                                    <option value="yearly">Anual</option>
                                </select>
                            </div>
                            
                            <div class="form-group" id="weeklyOptions" style="display: none;">
                                <label>Dias da semana</label>
                                <div class="days-selector">
                                    <button type="button" class="day-btn" data-day="0" onclick="toggleDay(0)">D</button>
                                    <button type="button" class="day-btn" data-day="1" onclick="toggleDay(1)">S</button>
                                    <button type="button" class="day-btn" data-day="2" onclick="toggleDay(2)">T</button>
                                    <button type="button" class="day-btn" data-day="3" onclick="toggleDay(3)">Q</button>
                                    <button type="button" class="day-btn" data-day="4" onclick="toggleDay(4)">Q</button>
                                    <button type="button" class="day-btn" data-day="5" onclick="toggleDay(5)">S</button>
                                    <button type="button" class="day-btn" data-day="6" onclick="toggleDay(6)">S</button>
                                </div>
                            </div>

                            <div class="form-row">
                                <div class="form-group">
                                    <label for="recurrenceInterval">Repetir a cada</label>
                                    <input type="number" id="recurrenceInterval" value="1" min="1" max="365">
                                </div>
                                <div class="form-group">
                                    <label for="recurrenceEnd">At√© (opcional)</label>
                                    <input type="date" id="recurrenceEnd">
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- v3.0: Categorias -->
                    <div class="form-group">
                        <label>üìÅ Categorias</label>
                        <div class="categories-selector" id="categoriesSelector">
                            <!-- Categories will be added dynamically -->
                        </div>
                    </div>

                    <!-- v3.0: Notifica√ß√µes -->
                    <div class="form-group">
                        <label>üîî Notifica√ß√µes</label>
                        <div class="notification-settings">
                            <label class="checkbox-group">
                                <input type="checkbox" id="enableNotifications" checked>
                                <span>Ativar notifica√ß√µes do navegador</span>
                            </label>
                            <label class="checkbox-group">
                                <input type="checkbox" id="enableSound" checked>
                                <span>üîä Reproduzir som</span>
                            </label>
                            <div class="form-group" style="margin: 0;">
                                <label for="notificationTime">Notificar com anteced√™ncia</label>
                                <select id="notificationTime">
                                    <option value="0">Na hora exata</option>
                                    <option value="5">5 minutos antes</option>
                                    <option value="15" selected>15 minutos antes</option>
                                    <option value="30">30 minutos antes</option>
                                    <option value="60">1 hora antes</option>
                                    <option value="1440">1 dia antes</option>
                                </select>
                            </div>
                        </div>
                    </div>

                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" onclick="closeModal()">Cancelar</button>
                        <button type="submit" class="btn btn-primary">üíæ Salvar</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <script>
        // State
        let reminders = [];
        let categories = [
            { id: 'trabalho', name: 'Trabalho', icon: 'üè¢', color: '#0052cc' },
            { id: 'reuniao', name: 'Reuni√£o', icon: 'üë•', color: '#6554c0' },
            { id: 'ligacao', name: 'Liga√ß√£o', icon: 'üìû', color: '#00875a' },
            { id: 'email', name: 'Email', icon: 'üìß', color: '#ff8b00' },
            { id: 'financeiro', name: 'Financeiro', icon: 'üí∞', color: '#ffab00' },
            { id: 'saude', name: 'Sa√∫de', icon: 'üè•', color: '#de350b' },
            { id: 'pessoal', name: 'Pessoal', icon: 'üéØ', color: '#ff5630' },
            { id: 'estudos', name: 'Estudos', icon: 'üéì', color: '#00b8d9' }
        ];
        let currentTab = 'todos';
        let currentCategory = 'all';
        let editingReminderId = null;
        let selectedDays = [];
        let selectedCategories = [];
        let notificationCheckInterval = null;

        // Initialize
        document.addEventListener('DOMContentLoaded', () => {
            setupTheme();
            loadReminders();
            renderCategoryFilters();
            renderCategorySelector();
            renderReminders();
            updateStats();
            checkNotificationPermission();
            startNotificationChecker();
        });

        // Theme
        function setupTheme() {
            const theme = localStorage.getItem('kanban-theme') || 'dark';
            document.documentElement.setAttribute('data-theme', theme);
            updateThemeIcon();
        }

        function toggleTheme() {
            const current = document.documentElement.getAttribute('data-theme');
            const newTheme = current === 'dark' ? 'light' : 'dark';
            document.documentElement.setAttribute('data-theme', newTheme);
            localStorage.setItem('kanban-theme', newTheme);
            updateThemeIcon();
        }

        function updateThemeIcon() {
            const theme = document.documentElement.getAttribute('data-theme');
            document.getElementById('themeToggle').textContent = theme === 'dark' ? '‚òÄÔ∏è' : 'üåô';
        }

        // Storage
        function loadReminders() {
            const data = localStorage.getItem('taskflow-reminders');
            if (data) {
                reminders = JSON.parse(data);
            }
        }

        function saveReminders() {
            localStorage.setItem('taskflow-reminders', JSON.stringify(reminders));
            updateKanbanBadge();
        }

        function updateKanbanBadge() {
            const today = new Date().toISOString().split('T')[0];
            const todayCount = reminders.filter(r => r.date === today).length;
            localStorage.setItem('taskflow-reminders-today-count', todayCount.toString());
        }

        // Tabs
        function switchTab(tab) {
            currentTab = tab;
            document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
            document.querySelector(`[data-tab="${tab}"]`).classList.add('active');
            renderReminders();
        }

        // Category Filters
        function renderCategoryFilters() {
            const container = document.getElementById('categoryFilters');
            const existingButtons = container.querySelector('.filter-label').nextSibling;
            
            categories.forEach(cat => {
                const chip = document.createElement('button');
                chip.className = 'filter-chip';
                chip.dataset.category = cat.id;
                chip.onclick = () => filterByCategory(cat.id);
                chip.innerHTML = `
                    <span class="category-dot" style="background: ${cat.color}"></span>
                    ${cat.icon} ${cat.name}
                `;
                container.appendChild(chip);
            });
        }

        function filterByCategory(category) {
            currentCategory = category;
            document.querySelectorAll('.filter-chip').forEach(chip => {
                chip.classList.remove('active');
                if (chip.dataset.category === category) {
                    chip.classList.add('active');
                }
            });
            renderReminders();
        }

        function renderCategorySelector() {
            const container = document.getElementById('categoriesSelector');
            container.innerHTML = '';
            
            categories.forEach(cat => {
                const option = document.createElement('button');
                option.type = 'button';
                option.className = 'category-option';
                option.dataset.category = cat.id;
                option.style.borderColor = cat.color;
                option.onclick = () => toggleCategory(cat.id);
                option.innerHTML = `
                    <span class="category-dot" style="background: ${cat.color}"></span>
                    ${cat.icon} ${cat.name}
                `;
                container.appendChild(option);
            });
        }

        function toggleCategory(categoryId) {
            const index = selectedCategories.indexOf(categoryId);
            const option = document.querySelector(`[data-category="${categoryId}"]`);
            
            if (index >= 0) {
                selectedCategories.splice(index, 1);
                option.classList.remove('selected');
            } else {
                selectedCategories.push(categoryId);
                option.classList.add('selected');
            }
        }

        // Modal
        function openModal(reminderId = null) {
            editingReminderId = reminderId;
            selectedDays = [];
            selectedCategories = [];
            
            if (reminderId) {
                const reminder = reminders.find(r => r.id === reminderId);
                document.getElementById('modalTitle').textContent = 'Editar Lembrete';
                document.getElementById('reminderTitle').value = reminder.title;
                document.getElementById('reminderDate').value = reminder.date;
                document.getElementById('reminderTime').value = reminder.time || '';
                document.getElementById('reminderDescription').value = reminder.description || '';
                
                if (reminder.recurrence) {
                    document.getElementById('enableRecurrence').checked = true;
                    document.getElementById('recurrenceType').value = reminder.recurrence.type;
                    document.getElementById('recurrenceInterval').value = reminder.recurrence.interval;
                    document.getElementById('recurrenceEnd').value = reminder.recurrence.endDate || '';
                    selectedDays = reminder.recurrence.daysOfWeek || [];
                    toggleRecurrenceOptions();
                    updateRecurrenceOptions();
                    selectedDays.forEach(day => {
                        document.querySelector(`[data-day="${day}"]`).classList.add('selected');
                    });
                }
                
                if (reminder.categories) {
                    selectedCategories = [...reminder.categories];
                    selectedCategories.forEach(catId => {
                        document.querySelector(`[data-category="${catId}"]`).classList.add('selected');
                    });
                }
                
                document.getElementById('enableNotifications').checked = reminder.notifications?.enabled !== false;
                document.getElementById('enableSound').checked = reminder.notifications?.sound !== false;
                document.getElementById('notificationTime').value = reminder.notifications?.timeBefore || 15;
            } else {
                document.getElementById('modalTitle').textContent = 'Novo Lembrete';
                document.getElementById('reminderForm').reset();
                document.getElementById('recurrenceOptions').classList.remove('active');
                document.querySelectorAll('.day-btn').forEach(btn => btn.classList.remove('selected'));
                document.querySelectorAll('.category-option').forEach(opt => opt.classList.remove('selected'));
            }
            
            document.getElementById('reminderModal').classList.add('active');
        }

        function closeModal() {
            document.getElementById('reminderModal').classList.remove('active');
            editingReminderId = null;
        }

        function toggleRecurrenceOptions() {
            const enabled = document.getElementById('enableRecurrence').checked;
            const options = document.getElementById('recurrenceOptions');
            if (enabled) {
                options.classList.add('active');
                updateRecurrenceOptions();
            } else {
                options.classList.remove('active');
            }
        }

        function updateRecurrenceOptions() {
            const type = document.getElementById('recurrenceType').value;
            const weeklyOptions = document.getElementById('weeklyOptions');
            weeklyOptions.style.display = type === 'weekly' ? 'block' : 'none';
        }

        function toggleDay(day) {
            const btn = document.querySelector(`[data-day="${day}"]`);
            const index = selectedDays.indexOf(day);
            
            if (index >= 0) {
                selectedDays.splice(index, 1);
                btn.classList.remove('selected');
            } else {
                selectedDays.push(day);
                btn.classList.add('selected');
            }
        }

        function saveReminder(event) {
            event.preventDefault();
            
            const reminderData = {
                title: document.getElementById('reminderTitle').value,
                date: document.getElementById('reminderDate').value,
                time: document.getElementById('reminderTime').value,
                description: document.getElementById('reminderDescription').value,
                categories: selectedCategories,
                notifications: {
                    enabled: document.getElementById('enableNotifications').checked,
                    sound: document.getElementById('enableSound').checked,
                    timeBefore: parseInt(document.getElementById('notificationTime').value)
                }
            };
            
            if (document.getElementById('enableRecurrence').checked) {
                reminderData.recurrence = {
                    type: document.getElementById('recurrenceType').value,
                    interval: parseInt(document.getElementById('recurrenceInterval').value),
                    daysOfWeek: selectedDays.length > 0 ? selectedDays : null,
                    endDate: document.getElementById('recurrenceEnd').value || null
                };
            }
            
            if (editingReminderId) {
                const index = reminders.findIndex(r => r.id === editingReminderId);
                reminders[index] = {
                    ...reminders[index],
                    ...reminderData,
                    updatedAt: new Date().toISOString()
                };
            } else {
                const newReminder = {
                    id: Date.now(),
                    ...reminderData,
                    createdAt: new Date().toISOString(),
                    updatedAt: new Date().toISOString()
                };
                reminders.push(newReminder);
            }
            
            saveReminders();
            renderReminders();
            updateStats();
            closeModal();
            
            showNotification(`‚úÖ Lembrete ${editingReminderId ? 'atualizado' : 'criado'} com sucesso!`);
        }

        function deleteReminder(id) {
            if (!confirm('Tem certeza que deseja excluir este lembrete?')) return;
            
            reminders = reminders.filter(r => r.id !== id);
            saveReminders();
            renderReminders();
            updateStats();
            
            showNotification('üóëÔ∏è Lembrete exclu√≠do!');
        }

        function completeReminder(id) {
            reminders = reminders.filter(r => r.id !== id);
            saveReminders();
            renderReminders();
            updateStats();
            
            showNotification('‚úÖ Lembrete conclu√≠do!');
        }

        // Render
        function renderReminders() {
            const grid = document.getElementById('remindersGrid');
            const today = new Date().toISOString().split('T')[0];
            
            let filtered = reminders;
            
            // Filter by tab
            if (currentTab === 'hoje') {
                filtered = filtered.filter(r => r.date === today);
            } else if (currentTab === 'proximos') {
                filtered = filtered.filter(r => r.date > today);
            } else if (currentTab === 'atrasados') {
                filtered = filtered.filter(r => r.date < today);
            } else if (currentTab === 'recorrentes') {
                filtered = filtered.filter(r => r.recurrence);
            }
            
            // Filter by category
            if (currentCategory !== 'all') {
                filtered = filtered.filter(r => r.categories && r.categories.includes(currentCategory));
            }
            
            // Sort by date
            filtered.sort((a, b) => {
                if (a.date === b.date) {
                    return (a.time || '').localeCompare(b.time || '');
                }
                return a.date.localeCompare(b.date);
            });
            
            if (filtered.length === 0) {
                grid.innerHTML = `
                    <div class="empty-state" style="grid-column: 1/-1;">
                        <div class="empty-icon">üì≠</div>
                        <div class="empty-title">Nenhum lembrete encontrado</div>
                        <div class="empty-text">Crie seu primeiro lembrete clicando no bot√£o acima</div>
                    </div>
                `;
                return;
            }
            
            grid.innerHTML = filtered.map(reminder => {
                const isToday = reminder.date === today;
                const isOverdue = reminder.date < today;
                const cardClass = isToday ? 'today' : isOverdue ? 'overdue' : '';
                
                const categoriesHtml = reminder.categories && reminder.categories.length > 0
                    ? reminder.categories.map(catId => {
                        const cat = categories.find(c => c.id === catId);
                        if (!cat) return '';
                        return `<span class="category-badge" style="background: ${cat.color}20; color: ${cat.color}">${cat.icon} ${cat.name}</span>`;
                    }).join('')
                    : '';
                
                const recurrenceHtml = reminder.recurrence
                    ? `<span class="recurrence-badge">üîÑ ${getRecurrenceText(reminder.recurrence)}</span>`
                    : '';
                
                return `
                    <div class="reminder-card ${cardClass}">
                        <div class="reminder-header">
                            <div class="reminder-title">${reminder.title}</div>
                            <div class="reminder-actions">
                                <button class="action-btn" onclick="openModal(${reminder.id})" title="Editar">‚úèÔ∏è</button>
                                <button class="action-btn complete" onclick="completeReminder(${reminder.id})" title="Concluir">‚úì</button>
                                <button class="action-btn delete" onclick="deleteReminder(${reminder.id})" title="Excluir">üóëÔ∏è</button>
                            </div>
                        </div>
                        <div class="reminder-datetime">
                            <span>üìÖ ${formatDate(reminder.date)}</span>
                            ${reminder.time ? `<span>üïê ${reminder.time}</span>` : ''}
                        </div>
                        ${reminder.description ? `<div class="reminder-description">${reminder.description}</div>` : ''}
                        <div class="reminder-footer">
                            <div class="reminder-categories">${categoriesHtml}</div>
                            ${recurrenceHtml}
                        </div>
                    </div>
                `;
            }).join('');
        }

        function formatDate(dateString) {
            const date = new Date(dateString + 'T00:00:00');
            const today = new Date();
            today.setHours(0, 0, 0, 0);
            const tomorrow = new Date(today);
            tomorrow.setDate(tomorrow.getDate() + 1);
            
            if (dateString === today.toISOString().split('T')[0]) {
                return 'Hoje';
            } else if (dateString === tomorrow.toISOString().split('T')[0]) {
                return 'Amanh√£';
            }
            
            return date.toLocaleDateString('pt-BR', { day: '2-digit', month: 'short', year: 'numeric' });
        }

        function getRecurrenceText(recurrence) {
            const types = {
                daily: 'Di√°rio',
                weekly: 'Semanal',
                monthly: 'Mensal',
                yearly: 'Anual'
            };
            return types[recurrence.type] || recurrence.type;
        }

        function updateStats() {
            const today = new Date().toISOString().split('T')[0];
            const todayCount = reminders.filter(r => r.date === today).length;
            const overdueCount = reminders.filter(r => r.date < today).length;
            
            document.getElementById('totalCount').textContent = reminders.length;
            document.getElementById('todayCount').textContent = todayCount;
            document.getElementById('todayBadge').textContent = todayCount;
            document.getElementById('overdueBadge').textContent = overdueCount;
            
            if (todayCount === 0) {
                document.getElementById('todayBadge').style.display = 'none';
            } else {
                document.getElementById('todayBadge').style.display = 'block';
            }
            
            if (overdueCount === 0) {
                document.getElementById('overdueBadge').style.display = 'none';
            } else {
                document.getElementById('overdueBadge').style.display = 'block';
            }
        }

        // Notifications
        function checkNotificationPermission() {
            if (!('Notification' in window)) {
                return;
            }
            
            // Check if user already dismissed the banner
            const bannerDismissed = localStorage.getItem('notification-banner-dismissed');
            
            if (Notification.permission === 'default' && !bannerDismissed) {
                document.getElementById('notificationBanner').classList.remove('hidden');
            } else if (Notification.permission === 'granted') {
                hideNotificationBanner();
            }
        }

        function requestNotificationPermission() {
            Notification.requestPermission().then(permission => {
                if (permission === 'granted') {
                    showNotification('‚úÖ Notifica√ß√µes ativadas!');
                    hideNotificationBanner();
                    localStorage.setItem('notification-banner-dismissed', 'true');
                }
            });
        }

        function hideNotificationBanner() {
            document.getElementById('notificationBanner').classList.add('hidden');
            localStorage.setItem('notification-banner-dismissed', 'true');
        }

        function startNotificationChecker() {
            // Check every minute
            notificationCheckInterval = setInterval(checkRemindersForNotification, 60000);
            checkRemindersForNotification(); // Check immediately
        }

        function checkRemindersForNotification() {
            if (!('Notification' in window) || Notification.permission !== 'granted') {
                return;
            }
            
            const now = new Date();
            const currentDate = now.toISOString().split('T')[0];
            const currentTime = now.toTimeString().substring(0, 5);
            
            reminders.forEach(reminder => {
                if (!reminder.notifications || !reminder.notifications.enabled) return;
                
                const reminderDateTime = new Date(reminder.date + 'T' + (reminder.time || '00:00'));
                const timeBefore = reminder.notifications.timeBefore || 15;
                const notifyTime = new Date(reminderDateTime.getTime() - timeBefore * 60000);
                
                if (now >= notifyTime && now < reminderDateTime) {
                    const notificationKey = `notification-${reminder.id}-${reminder.date}-${reminder.time}`;
                    if (localStorage.getItem(notificationKey)) return;
                    
                    sendBrowserNotification(reminder);
                    localStorage.setItem(notificationKey, 'sent');
                }
            });
        }

        function sendBrowserNotification(reminder) {
            const title = `üîî Lembrete: ${reminder.title}`;
            const options = {
                body: reminder.description || `üìÖ ${formatDate(reminder.date)} ${reminder.time ? 'üïê ' + reminder.time : ''}`,
                icon: 'üîî',
                badge: 'üîî',
                tag: `reminder-${reminder.id}`,
                requireInteraction: true
            };
            
            const notification = new Notification(title, options);
            
            if (reminder.notifications?.sound) {
                playNotificationSound();
            }
            
            notification.onclick = () => {
                window.focus();
                switchTab('hoje');
                notification.close();
            };
        }

        function playNotificationSound() {
            // Simple beep using Web Audio API
            const audioContext = new (window.AudioContext || window.webkitAudioContext)();
            const oscillator = audioContext.createOscillator();
            const gainNode = audioContext.createGain();
            
            oscillator.connect(gainNode);
            gainNode.connect(audioContext.destination);
            
            oscillator.frequency.value = 800;
            oscillator.type = 'sine';
            
            gainNode.gain.setValueAtTime(0.3, audioContext.currentTime);
            gainNode.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + 0.5);
            
            oscillator.start(audioContext.currentTime);
            oscillator.stop(audioContext.currentTime + 0.5);
        }

        function showNotification(message) {
            const notification = document.createElement('div');
            notification.style.cssText = `
                position: fixed;
                top: 80px;
                right: 20px;
                background: var(--accent-green);
                color: white;
                padding: 16px 24px;
                border-radius: 8px;
                box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
                z-index: 10000;
                font-weight: 600;
                font-size: 14px;
                animation: slideIn 0.3s ease;
            `;
            notification.textContent = message;
            document.body.appendChild(notification);
            
            setTimeout(() => {
                notification.style.animation = 'slideOut 0.3s ease';
                setTimeout(() => {
                    if (notification.parentNode) {
                        document.body.removeChild(notification);
                    }
                }, 300);
            }, 3000);
        }

        // Keyboard shortcuts
        document.addEventListener('keydown', (e) => {
            if (e.key === 'Escape') {
                closeModal();
            }
            if (e.key === 'n' && (e.ctrlKey || e.metaKey)) {
                e.preventDefault();
                openModal();
            }
        });

        // Close modal on click outside
        document.getElementById('reminderModal').addEventListener('click', (e) => {
            if (e.target.id === 'reminderModal') {
                closeModal();
            }
        });
    </script>
</body>
</html>
